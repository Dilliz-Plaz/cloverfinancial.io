<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clover Financial — Secure. Structured. Sovereign.</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Syne:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap');

:root {
  --bg:       #080c0a;
  --bg2:      #0c1210;
  --bg3:      #101810;
  --surface:  #131c14;
  --surface2: #192419;
  --border:   #1c2b1e;
  --border2:  #243528;
  --green:    #3ddc84;
  --green2:   #28a85d;
  --green3:   #1a6b3a;
  --green-glow: rgba(61,220,132,0.12);
  --green-pale: rgba(61,220,132,0.06);
  --text:     #dff0e4;
  --text2:    #7a9e84;
  --text3:    #3d5c44;
  --red:      #ff4d4d;
  --amber:    #ffb347;
  --blue:     #4da6ff;
  --gold:     #d4af37;
  --white:    #ffffff;
}

*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}

/* NOISE */
body::after{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");opacity:0.025;pointer-events:none;z-index:9998;}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg2);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* PAGE SYSTEM */
.page{display:none;min-height:100vh;}
.page.active{display:block;}
#page-dashboard.active,#page-teller.active{display:flex;}

/* ================== TYPOGRAPHY ================== */
.display{font-family:'Cormorant Garamond',serif;}
.mono{font-family:'IBM Plex Mono',monospace;}

/* ================== BUTTONS ================== */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 22px;border:none;border-radius:3px;font-family:'Syne',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .18s;letter-spacing:0.04em;text-decoration:none;white-space:nowrap;}
.btn-primary{background:var(--green);color:#050a06;}
.btn-primary:hover{background:#4dffa0;box-shadow:0 0 20px rgba(61,220,132,0.3);}
.btn-outline{background:transparent;color:var(--green);border:1px solid var(--green3);}
.btn-outline:hover{background:var(--green-pale);border-color:var(--green);}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--surface);color:var(--text);}
.btn-danger{background:transparent;color:var(--red);border:1px solid rgba(255,77,77,0.3);}
.btn-danger:hover{background:rgba(255,77,77,0.08);}
.btn-amber{background:transparent;color:var(--amber);border:1px solid rgba(255,179,71,0.3);}
.btn-amber:hover{background:rgba(255,179,71,0.08);}
.btn-sm{padding:6px 14px;font-size:12px;}
.btn-lg{padding:13px 30px;font-size:14px;}
.btn-full{width:100%;}
.btn:disabled{opacity:0.45;cursor:not-allowed;}

/* ================== INPUTS ================== */
.input-group{margin-bottom:18px;}
.input-group label{display:block;font-size:10px;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);margin-bottom:7px;font-weight:600;}
.input-group input,.input-group select,.input-group textarea{width:100%;background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:10px 13px;border-radius:3px;font-family:'Syne',sans-serif;font-size:13px;transition:border-color .18s;-webkit-appearance:none;}
.input-group select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%233d5c44'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;}
.input-group input:focus,.input-group select:focus,.input-group textarea:focus{outline:none;border-color:var(--green3);box-shadow:0 0 0 2px var(--green-pale);}
.input-group textarea{resize:vertical;min-height:72px;}
.input-row{display:flex;gap:12px;}
.input-row .input-group{flex:1;}

/* ================== CARDS ================== */
.card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:22px;}
.card-sm{padding:14px 18px;}
.card-xs{padding:10px 14px;}

/* ================== ALERTS ================== */
.alert{padding:10px 14px;border-radius:3px;font-size:12px;margin-bottom:14px;display:none;line-height:1.5;}
.alert.show{display:block;}
.alert-error{background:rgba(255,77,77,.08);border:1px solid rgba(255,77,77,.25);color:var(--red);}
.alert-success{background:rgba(61,220,132,.08);border:1px solid rgba(61,220,132,.25);color:var(--green);}
.alert-warning{background:rgba(255,179,71,.08);border:1px solid rgba(255,179,71,.25);color:var(--amber);}
.alert-info{background:rgba(77,166,255,.08);border:1px solid rgba(77,166,255,.25);color:var(--blue);}

/* ================== BADGES ================== */
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 9px;border-radius:100px;font-size:10px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase;}
.badge::before{content:'●';font-size:6px;}
.b-green{background:rgba(61,220,132,.12);color:var(--green);border:1px solid rgba(61,220,132,.2);}
.b-red{background:rgba(255,77,77,.12);color:var(--red);border:1px solid rgba(255,77,77,.2);}
.b-amber{background:rgba(255,179,71,.12);color:var(--amber);border:1px solid rgba(255,179,71,.2);}
.b-blue{background:rgba(77,166,255,.12);color:var(--blue);border:1px solid rgba(77,166,255,.2);}
.b-gray{background:rgba(61,92,68,.15);color:var(--text3);border:1px solid var(--border);}

/* ================== TABLE ================== */
table{width:100%;border-collapse:collapse;font-size:12px;}
th{text-align:left;padding:8px 12px;font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);border-bottom:1px solid var(--border);font-weight:600;}
td{padding:11px 12px;border-bottom:1px solid var(--border);color:var(--text2);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tbody tr:hover td{background:var(--green-pale);color:var(--text);}

/* ================== MODAL ================== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:2000;padding:20px;backdrop-filter:blur(6px);}
.modal-overlay.show{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:6px;padding:28px;width:100%;max-width:520px;position:relative;max-height:90vh;overflow-y:auto;}
.modal-title{font-family:'Cormorant Garamond',serif;font-size:22px;margin-bottom:20px;}
.modal-close{position:absolute;top:14px;right:16px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:18px;line-height:1;transition:color .15s;}
.modal-close:hover{color:var(--text);}

/* ================== SECTION LABEL ================== */
.sec-label{font-size:10px;letter-spacing:0.14em;text-transform:uppercase;color:var(--text3);font-weight:600;margin-bottom:14px;}
hr.sep{border:none;border-top:1px solid var(--border);margin:20px 0;}

/* ================================================================
   LANDING PAGE — PREMIUM INSTITUTIONAL
================================================================ */
#page-landing { background: var(--bg); }

/* ================================================================
   KEYFRAMES
================================================================ */
@keyframes fadeUp {
  from { opacity:0; transform:translateY(24px); }
  to   { opacity:1; transform:translateY(0); }
}
@keyframes pulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(61,220,132,0); }
  50%      { box-shadow: 0 0 0 4px rgba(61,220,132,.12), 0 0 16px rgba(61,220,132,.4); }
}
@keyframes shimmer {
  0%   { background-position: -300% center; }
  100% { background-position: 300% center; }
}
/* Slow atmospheric orb drift — 28s / 38s loops, offset */
@keyframes orbDrift {
  0%   { transform: translate(0,   0)   scale(1);    }
  25%  { transform: translate(3%,  4%)  scale(1.03); }
  50%  { transform: translate(5%,  1%)  scale(1.05); }
  75%  { transform: translate(2%, -3%)  scale(1.02); }
  100% { transform: translate(0,   0)   scale(1);    }
}
@keyframes orbDrift2 {
  0%   { transform: translate(0,    0)   scale(1);    }
  33%  { transform: translate(-4%,  5%)  scale(1.04); }
  66%  { transform: translate(-2%, -4%)  scale(.97);  }
  100% { transform: translate(0,    0)   scale(1);    }
}
/* Scroll-reveal */
@keyframes revealUp {
  from { opacity:0; transform:translateY(28px); }
  to   { opacity:1; transform:translateY(0); }
}
/* Nav underline slide */
@keyframes slideIn {
  from { transform: scaleX(0); }
  to   { transform: scaleX(1); }
}

/* ---- STAGGER CLASSES ---- */
.land-fade { opacity:0; animation: fadeUp 1s cubic-bezier(.16,1,.3,1) forwards; }
.land-fade-1 { animation-delay:.05s; }
.land-fade-2 { animation-delay:.17s; }
.land-fade-3 { animation-delay:.3s; }
.land-fade-4 { animation-delay:.45s; }
.land-fade-5 { animation-delay:.6s; }
.land-fade-6 { animation-delay:.76s; }

/* Scroll-reveal — toggled via IntersectionObserver */
.reveal {
  opacity: 0;
  transform: translateY(26px);
  transition: opacity .85s cubic-bezier(.16,1,.3,1),
              transform .85s cubic-bezier(.16,1,.3,1);
}
.reveal.visible { opacity:1; transform:translateY(0); }
.reveal-d1 { transition-delay:.07s; }
.reveal-d2 { transition-delay:.16s; }
.reveal-d3 { transition-delay:.27s; }

/* ================================================================
   NAV
================================================================ */
.nav {
  position: fixed; top:0; left:0; right:0; z-index:200;
  background: rgba(4,6,5,.9);
  backdrop-filter: blur(40px) saturate(180%);
  -webkit-backdrop-filter: blur(40px) saturate(180%);
  border-bottom: 1px solid rgba(20,32,22,.7);
  padding: 0 80px; height: 60px;
  display: flex; align-items: center; justify-content: space-between;
  /* Nav transitions: background, shadow, blur all smooth */
  transition: background .55s ease, border-color .55s ease,
              box-shadow .55s ease, backdrop-filter .55s ease;
}
.nav.scrolled {
  background: rgba(3,5,4,.96);
  border-bottom-color: rgba(61,220,132,.07);
  box-shadow: 0 1px 0 rgba(61,220,132,.04),
              0 8px 32px rgba(0,0,0,.55),
              0 24px 80px rgba(0,0,0,.4);
  backdrop-filter: blur(64px) saturate(220%);
}
.nav-logo {
  display: flex; align-items: center; gap: 11px;
  font-family: 'Cormorant Garamond', serif; font-size: 19px;
  font-weight: 600; color: var(--text); letter-spacing: .02em;
}
.nav-logo-mark {
  width: 26px; height: 26px; background: var(--green);
  border-radius: 3px; display: flex; align-items: center;
  justify-content: center; font-size: 12px; color: #030804;
  font-weight: 900; flex-shrink:0;
  box-shadow: 0 0 14px rgba(61,220,132,.22);
  transition: box-shadow .35s;
}
.nav-logo:hover .nav-logo-mark { box-shadow: 0 0 22px rgba(61,220,132,.38); }
.nav-links { display: flex; align-items: center; }
.nav-link {
  background: none; border: none; color: #253327;
  padding: 8px 14px; font-family: 'Syne', sans-serif;
  font-size: 10px; cursor: pointer; letter-spacing: .12em;
  text-transform: uppercase; font-weight: 700; position: relative;
  transition: color .28s;
}
.nav-link:hover { color: #537558; }
.nav-link.active { color: var(--text2); }
/* Underline animates in from center on activation */
.nav-link.active::after {
  content:''; position:absolute; bottom:0; left:14px; right:14px; height:1px;
  background: linear-gradient(90deg, transparent, var(--green2), transparent);
  transform-origin: center;
  animation: slideIn .32s cubic-bezier(.25,.46,.45,.94) forwards;
}
.nav-divider { width:1px; height:14px; background:rgba(28,43,30,.7); margin:0 6px; }
.nav .btn-outline {
  padding: 6px 16px; font-size: 10px; letter-spacing: .1em;
  border-color: rgba(28,43,30,.9); color: #4a6b50;
  transition: all .28s cubic-bezier(.25,.46,.45,.94);
}
.nav .btn-outline:hover {
  background: rgba(61,220,132,.05); border-color: rgba(61,220,132,.28);
  color: var(--text2); box-shadow: 0 0 16px rgba(61,220,132,.08);
}

/* ================================================================
   HERO
================================================================ */
.hero {
  min-height: 100vh; display: flex; align-items: center;
  padding: 0 80px; position: relative; overflow: hidden;
  background: #060a08;
}

/* ---- ANIMATED GRADIENT LAYERS ---- */
/* Base: very slow warm-dark-to-emerald gradient that breathes */
.hero::before {
  content:''; position:absolute; inset:-15%;
  /* Two-stop gradient that drifts between deep charcoal and dark emerald */
  background: radial-gradient(
    ellipse 70% 60% at 30% 45%,
    rgba(22,56,36,.38) 0%,
    rgba(12,28,18,.18) 35%,
    transparent 70%
  ),
  radial-gradient(
    ellipse 50% 45% at 75% 60%,
    rgba(8,24,16,.25) 0%,
    transparent 65%
  );
  animation: orbDrift 28s ease-in-out infinite;
  will-change: transform; pointer-events:none; z-index:0;
}
/* Second orb: offset timing, slightly different position */
.hero::after {
  content:''; position:absolute; inset:-15%;
  background: radial-gradient(
    ellipse 55% 50% at 65% 30%,
    rgba(15,45,28,.22) 0%,
    rgba(8,24,16,.1) 45%,
    transparent 72%
  ),
  radial-gradient(
    ellipse 40% 35% at 20% 75%,
    rgba(10,32,20,.15) 0%,
    transparent 65%
  );
  animation: orbDrift2 38s ease-in-out infinite;
  will-change: transform; pointer-events:none; z-index:0;
}
/* Static layer: bg element for the glow div + dot grid */
.hero-bg {
  position:absolute; inset:0; pointer-events:none; z-index:1;
}
/* Bright focused emerald glow — centred left, static */
.hero-bg::before {
  content:''; position:absolute;
  left:-8%; top:10%; width:58%; height:80%;
  background: radial-gradient(
    ellipse 65% 55% at 40% 48%,
    rgba(61,220,132,.055) 0%,
    rgba(40,140,90,.02)   40%,
    transparent 70%
  );
  pointer-events:none;
}
/* Vignette: top + bottom depth */
.hero-bg::after {
  content:''; position:absolute; inset:0;
  background:
    radial-gradient(ellipse 100% 35% at 50% 0%,   rgba(0,0,0,.45) 0%, transparent 55%),
    radial-gradient(ellipse 100% 40% at 50% 100%, rgba(0,0,0,.65) 0%, transparent 60%);
  pointer-events:none;
}
/* Dot grid — faint institutional texture */
.hero-left { position:relative; z-index:2; }
.hero-left::before {
  content:''; position:absolute; inset:-200px -400px; pointer-events:none;
  background-image: radial-gradient(rgba(28,43,30,.2) 1px, transparent 1px);
  background-size: 28px 28px;
  mask-image: radial-gradient(ellipse 70% 80% at 20% 50%,
    rgba(0,0,0,.55) 0%, transparent 80%);
  z-index:-1;
}

/* ---- HERO CONTENT ---- */
.hero-left {
  position: relative; z-index:2;
  max-width: 680px;
  padding: 120px 0 100px;
  display: flex; flex-direction: column; justify-content: center;
}
.hero-classification {
  display: flex; align-items: center; gap: 14px; margin-bottom: 48px;
}
.hero-classification-rule {
  width: 32px; height: 1px;
  background: linear-gradient(90deg, var(--green2), transparent);
}
.hero-classification-text {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; letter-spacing: .32em; text-transform: uppercase;
  color: var(--green3); font-weight: 700;
}
.hero-h1 {
  font-family: 'Cormorant Garamond', serif;
  font-size: clamp(54px, 5.4vw, 92px);
  line-height: .96; font-weight: 600;
  color: var(--text); letter-spacing: -.02em;
  margin-bottom: 30px;
}
.hero-h1 em {
  display: block; font-style: italic;
  background: linear-gradient(100deg,
    var(--green2) 0%, #b8ffd8 35%, var(--green) 55%, #6effc0 75%, var(--green2) 100%);
  background-size: 300% auto;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: shimmer 7s linear infinite;
}
.hero-desc {
  font-size: 14.5px; color: #4a6a52; line-height: 1.9;
  max-width: 420px; margin-bottom: 48px; letter-spacing: .01em;
}

/* ---- CTA BUTTONS ---- */
.hero-cta {
  display: flex; flex-direction: column; gap: 9px;
  max-width: 350px; margin-bottom: 52px;
}
.hero-cta .btn {
  justify-content: space-between; font-size: 12px;
  letter-spacing: .05em; padding: 13px 18px;
  position: relative; overflow: hidden;
  transition: all .32s cubic-bezier(.25,.46,.45,.94);
}
.hero-cta .btn::after {
  content: '→'; opacity: .35; font-size: 14px;
  transition: opacity .25s, transform .25s;
}
.hero-cta .btn:hover::after { opacity:1; transform: translateX(5px); }

/* Primary — shimmer sweep + green glow */
.hero-cta .btn-primary {
  background: var(--green); color: #030804; font-weight: 700; border: none;
}
.hero-cta .btn-primary::after { opacity:.7; }
/* Shimmer highlight that sweeps across on hover */
.hero-cta .btn-primary > span.sweep {
  position: absolute; inset:0; pointer-events:none;
  background: linear-gradient(105deg,
    transparent 35%, rgba(255,255,255,.18) 50%, transparent 65%);
  transform: translateX(-100%);
  transition: transform .55s cubic-bezier(.25,.46,.45,.94);
}
.hero-cta .btn-primary:hover > span.sweep { transform: translateX(100%); }
.hero-cta .btn-primary:hover {
  background: #4cffa5;
  box-shadow:
    0 0 0 1px rgba(61,220,132,.5),
    0 6px 32px rgba(61,220,132,.32),
    0 2px 8px rgba(0,0,0,.3);
  transform: translateY(-2px);
}

/* Outline */
.hero-cta .btn-outline { border-color: rgba(28,43,30,.8); color: #4a6a52; }
.hero-cta .btn-outline:hover {
  border-color: rgba(61,220,132,.35); color: var(--text2);
  background: rgba(61,220,132,.04);
  box-shadow: 0 0 0 1px rgba(61,220,132,.07), 0 4px 20px rgba(0,0,0,.22);
  transform: translateY(-2px);
}

/* Ghost */
.hero-cta .btn-ghost { color: #2e4434; }
.hero-cta .btn-ghost:hover {
  background: var(--surface); color: #4a6a52;
  transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,.18);
}

/* Credential strip */
.hero-cred {
  display: flex; align-items: center;
  padding-top: 28px; border-top: 1px solid rgba(28,43,30,.35);
}
.hero-cred-item {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px; letter-spacing: .16em; text-transform: uppercase;
  color: #253327; font-weight: 700;
  display: flex; align-items: center; gap: 7px;
  padding-right: 22px; margin-right: 22px;
  border-right: 1px solid rgba(28,43,30,.35);
  transition: color .28s;
}
.hero-cred-item:hover { color: #3d5a42; }
.hero-cred-item:last-child { border-right:none; padding-right:0; margin-right:0; }
.hero-cred-item::before { content:'✓'; color: var(--green3); }

/* ================================================================
   METRICS STRIP
================================================================ */
.stats-strip {
  padding: 0 80px;
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  position: relative; overflow: hidden;
}
/* Faint horizontal glow sweep */
.stats-strip::before {
  content:''; position:absolute; inset:0; pointer-events:none;
  background: linear-gradient(90deg,
    rgba(61,220,132,.018) 0%, transparent 28%,
    transparent 72%, rgba(61,220,132,.012) 100%);
}
.stats-strip-inner {
  max-width: 1100px; margin: 0 auto;
  display: grid; grid-template-columns: repeat(4,1fr);
  background: var(--border); border: 1px solid var(--border);
  position: relative;
}
.stat-item {
  background: var(--bg); padding: 44px 36px;
  border-right: 1px solid var(--border);
  position: relative; overflow: hidden;
  transition: background .35s, transform .35s cubic-bezier(.25,.46,.45,.94);
  cursor: default;
}
.stat-item:last-child { border-right:none; }
/* Accent line slides out from center on hover */
.stat-item::after {
  content:''; position:absolute; top:0; left:0; right:0; height:2px;
  background: linear-gradient(90deg, transparent, rgba(61,220,132,.55), transparent);
  opacity:0; transform: scaleX(.3); transform-origin: center;
  transition: opacity .35s, transform .4s cubic-bezier(.25,.46,.45,.94);
}
.stat-item:hover { background: var(--surface); transform: translateY(-1px); }
.stat-item:hover::after { opacity:1; transform: scaleX(1); }
.stat-n {
  font-family: 'Cormorant Garamond', serif; font-size: 58px;
  font-weight: 600; color: var(--text); margin-bottom: 10px;
  line-height: 1; letter-spacing: -.03em; transition: color .3s;
}
.stat-item:hover .stat-n { color: #dff0e6; }
.stat-label {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; color: #253327; letter-spacing: .14em;
  text-transform: uppercase; font-weight: 700; transition: color .3s;
}
.stat-item:hover .stat-label { color: #3d5a42; }
.stat-sub { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: #1c2b1e; margin-top: 6px; }

/* ================================================================
   SERVICES
================================================================ */
.services {
  padding: 112px 80px;
  background: var(--bg2);
  position: relative; overflow: hidden;
}
.services-hdr {
  max-width: 1100px; margin: 0 auto 68px;
  display: grid; grid-template-columns: 1fr 1fr; align-items: end; gap: 60px;
}
.services-hdr-eyebrow {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px; letter-spacing: .3em; text-transform: uppercase;
  color: var(--green3); font-weight: 700; margin-bottom: 16px; display: block;
}
.services-hdr-left h2 {
  font-family: 'Cormorant Garamond', serif; font-size: 44px;
  font-weight: 600; line-height: 1.02; color: var(--text); letter-spacing: -.01em;
}
.services-hdr-left p { color: #3a5440; font-size: 13px; line-height: 1.8; padding-top: 10px; max-width: 440px; }
.services-grid {
  display: grid; grid-template-columns: repeat(5,1fr);
  background: var(--border); border: 1px solid var(--border);
  max-width: 1100px; margin: 0 auto;
  box-shadow: 0 24px 80px rgba(0,0,0,.5), 0 6px 20px rgba(0,0,0,.25);
}
/* Glass-style service card */
.svc-card {
  background: var(--bg2); padding: 40px 26px 34px;
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  position: relative; overflow: hidden;
  transition: background .3s,
              transform .38s cubic-bezier(.25,.46,.45,.94),
              box-shadow .38s;
}
.svc-card:last-child { border-right:none; }
.svc-card:hover {
  background: var(--surface);
  transform: translateY(-5px);
  box-shadow: 0 14px 44px rgba(0,0,0,.38), 0 4px 12px rgba(0,0,0,.18);
  z-index: 2;
}
/* Top accent: scales in from centre */
.svc-card::before {
  content:''; position:absolute; top:0; left:0; right:0; height:2px;
  background: linear-gradient(90deg, transparent, var(--green2), transparent);
  opacity:0; transform: scaleX(.4); transform-origin: center;
  transition: opacity .3s, transform .38s cubic-bezier(.25,.46,.45,.94);
}
.svc-card:hover::before { opacity:.85; transform: scaleX(1); }
/* Glass inner glow */
.svc-card::after {
  content:''; position:absolute; inset:0; pointer-events:none;
  background: radial-gradient(ellipse 90% 55% at 50% 0%,
    rgba(61,220,132,.04) 0%, transparent 70%);
  opacity:0; transition: opacity .4s;
}
.svc-card:hover::after { opacity:1; }
.svc-icon-wrap {
  width: 36px; height: 36px; border-radius: 6px;
  background: rgba(61,220,132,.04); border: 1px solid rgba(28,43,30,.6);
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; margin-bottom: 20px; flex-shrink: 0;
  transition: background .3s, border-color .3s, transform .32s;
}
.svc-card:hover .svc-icon-wrap {
  background: rgba(61,220,132,.09); border-color: rgba(61,220,132,.22);
  transform: scale(1.08);
}
.svc-card h3 { font-size: 13px; font-weight: 600; margin-bottom: 10px; color: var(--text); transition: color .25s; }
.svc-card:hover h3 { color: #d5eedd; }
.svc-card p { font-size: 11px; color: #3a5440; line-height: 1.75; margin-bottom: 20px; flex: 1; }
.svc-learn {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px; color: #253327; letter-spacing: .14em;
  text-transform: uppercase; font-weight: 700;
  background: none; border: none; cursor: pointer; padding: 0;
  display: flex; align-items: center; gap: 7px; margin-top: auto;
  transition: color .25s, gap .28s;
}
.svc-learn::after { content:'→'; font-size: 11px; transition: transform .25s; }
.svc-learn:hover { color: var(--green2); gap: 11px; }
.svc-learn:hover::after { transform: translateX(2px); }

/* ================================================================
   PRINCIPLES / ABOUT
================================================================ */
.principles { padding: 112px 80px; background: var(--bg); }
.principles-inner { max-width: 1100px; margin: 0 auto; }
.principles-top {
  display: grid; grid-template-columns: 280px 1fr;
  gap: 96px; align-items: start; margin-bottom: 72px;
}
.principles-eyebrow {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px; letter-spacing: .3em; text-transform: uppercase;
  color: var(--green3); font-weight: 700; margin-bottom: 20px; display: block;
}
.principles-h {
  font-family: 'Cormorant Garamond', serif; font-size: 44px;
  font-weight: 600; line-height: 1.04; color: var(--text); letter-spacing: -.01em;
}
.principles-text p { font-size: 14px; color: #4a6a52; line-height: 1.95; margin-bottom: 18px; }
.principles-grid {
  display: grid; grid-template-columns: repeat(3,1fr);
  background: var(--border); border: 1px solid var(--border);
  box-shadow: 0 14px 52px rgba(0,0,0,.36);
}
.principle-card {
  background: var(--bg); padding: 40px 34px;
  border-right: 1px solid var(--border);
  position: relative; overflow: hidden;
  transition: background .3s, transform .35s cubic-bezier(.25,.46,.45,.94);
}
.principle-card:last-child { border-right:none; }
.principle-card:hover { background: var(--surface); transform: translateY(-3px); }
/* Left accent bar on hover */
.principle-card::before {
  content:''; position:absolute; left:0; top:16px; bottom:16px; width:2px;
  background: linear-gradient(to bottom, transparent, var(--green3), transparent);
  opacity:0; transition: opacity .35s;
}
.principle-card:hover::before { opacity:1; }
.principle-num {
  font-family: 'IBM Plex Mono', monospace; font-size: 8.5px;
  color: var(--green3); margin-bottom: 20px; letter-spacing: .2em;
  font-weight: 700; display: block;
}
.principle-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text); transition: color .25s; }
.principle-card:hover .principle-title { color: #d5eedd; }
.principle-desc { font-size: 12.5px; color: #3a5440; line-height: 1.8; }

/* ================================================================
   SUPPORT SECTION
================================================================ */
.support-sect {
  padding: 88px 80px;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  position: relative; overflow: hidden;
}
/* Soft ambient glow far right */
.support-sect::before {
  content:''; position:absolute; inset:0; pointer-events:none;
  background: radial-gradient(ellipse 55% 90% at 90% 50%,
    rgba(61,220,132,.03) 0%, transparent 65%);
}
.support-inner {
  max-width: 1100px; margin: 0 auto;
  display: grid; grid-template-columns: 1fr 260px;
  align-items: center; gap: 72px; position: relative;
}
.support-left { }
.support-tag {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 8.5px; letter-spacing: .26em; text-transform: uppercase;
  color: var(--green3); font-weight: 700; margin-bottom: 20px;
  display: flex; align-items: center; gap: 12px;
}
.support-tag::before { content:''; width:20px; height:1px; background: var(--green3); }
.support-text h3 {
  font-family: 'Cormorant Garamond', serif; font-size: 34px;
  margin-bottom: 14px; line-height: 1.05; color: var(--text); letter-spacing: -.01em;
}
.support-text p { font-size: 13px; color: #4a6a52; line-height: 1.85; max-width: 500px; }
.support-channel-cards { display: flex; gap: 10px; margin-top: 28px; flex-wrap: wrap; }
.support-channel-card {
  display: flex; align-items: flex-start; gap: 11px;
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 4px; padding: 14px 16px; flex: 1; min-width: 160px;
  transition: border-color .3s, background .3s,
              transform .32s cubic-bezier(.25,.46,.45,.94), box-shadow .3s;
}
.support-channel-card:hover {
  border-color: rgba(40,65,45,.9); background: var(--surface);
  transform: translateY(-2px); box-shadow: 0 6px 22px rgba(0,0,0,.22);
}
.support-channel-icon {
  width: 28px; height: 28px; border-radius: 4px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center; font-size: 13px;
  transition: transform .3s;
}
.support-channel-card:hover .support-channel-icon { transform: scale(1.1); }
.support-channel-icon.pub { background: rgba(77,166,255,.06); border: 1px solid rgba(77,166,255,.12); }
.support-channel-icon.acc { background: rgba(61,220,132,.05); border: 1px solid rgba(61,220,132,.11); }
.support-channel-name { font-size: 12px; font-weight: 600; margin-bottom: 3px; }
.support-channel-name.pub { color: var(--blue); }
.support-channel-name.acc { color: var(--green2); }
.support-channel-desc { font-size: 10px; color: #3a5440; line-height: 1.55; }
.support-right { display: flex; flex-direction: column; gap: 10px; }
.agent-status {
  display: flex; align-items: center; gap: 9px;
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 3px; padding: 10px 14px; font-size: 11px; color: var(--text2);
}
.agent-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.agent-dot.online  { background: var(--green); animation: pulse 2.5s ease-in-out infinite; }
.agent-dot.limited { background: var(--amber); box-shadow: 0 0 6px rgba(255,179,71,.5); }
.agent-dot.offline { background: var(--red); }
.agent-status-text { font-weight: 600; font-size: 11px; }
.agent-status-text.online  { color: var(--green); }
.agent-status-text.limited { color: var(--amber); }
.agent-status-text.offline { color: var(--red); }
.support-cta-btn { transition: all .3s cubic-bezier(.25,.46,.45,.94) !important; }
.support-cta-btn.btn-primary:hover {
  transform: translateY(-2px) !important;
  box-shadow: 0 8px 30px rgba(61,220,132,.26) !important;
}
.support-cta-btn.btn-ghost:hover {
  transform: translateY(-1px) !important;
  box-shadow: 0 4px 16px rgba(0,0,0,.18) !important;
}

/* ================================================================
   FOOTER
================================================================ */
.footer {
  background: #030604;
  border-top: 1px solid rgba(20,32,22,.8);
  padding: 64px 80px 40px;
  position: relative; overflow: hidden;
}
.footer::before {
  content:''; position:absolute; inset:0; pointer-events:none;
  background: radial-gradient(ellipse 45% 75% at 15% 50%,
    rgba(61,220,132,.016) 0%, transparent 60%);
}
.footer-top {
  max-width: 1100px; margin: 0 auto;
  display: grid; grid-template-columns: 2fr 1fr 1fr 1fr;
  gap: 56px; padding-bottom: 52px;
  border-bottom: 1px solid rgba(20,32,22,.6);
  position: relative;
}
.footer-brand { display: flex; align-items: center; gap: 10px; font-family: 'Cormorant Garamond', serif; font-size: 17px; color: #3a5440; margin-bottom: 16px; }
.footer-brand-mark { width: 20px; height: 20px; background: var(--green3); border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--green); font-weight: 900; }
.footer-tagline { font-size: 11px; color: #253327; line-height: 1.75; max-width: 200px; margin-bottom: 18px; }
.footer-rp-notice { font-size: 10px; color: #1c2b1e; line-height: 1.7; border-top: 1px solid rgba(20,32,22,.5); padding-top: 16px; max-width: 200px; font-style: italic; }
.footer-col-title { font-family: 'IBM Plex Mono', monospace; font-size: 8.5px; letter-spacing: .2em; text-transform: uppercase; color: #253327; font-weight: 700; margin-bottom: 18px; }
.footer-col-links { display: flex; flex-direction: column; gap: 10px; }
.footer-col-link {
  font-size: 11.5px; color: #253327; background: none; border: none;
  cursor: pointer; text-align: left; padding: 0;
  font-family: 'Syne', sans-serif; letter-spacing: .01em;
  transition: color .25s, transform .25s;
  display: inline-block;
}
.footer-col-link:hover { color: #537558; transform: translateX(3px); }
.footer-bottom {
  max-width: 1100px; margin: 30px auto 0;
  display: flex; justify-content: space-between; align-items: center; position: relative;
}
.footer-copy { font-family: 'IBM Plex Mono', monospace; font-size: 8.5px; color: #1c2b1e; letter-spacing: .1em; text-transform: uppercase; }
.footer-badges { display: flex; gap: 22px; align-items: center; }
.footer-badge { font-family: 'IBM Plex Mono', monospace; font-size: 8.5px; color: #1c2b1e; letter-spacing: .1em; text-transform: uppercase; display: flex; align-items: center; gap: 6px; }
.footer-badge::before { content:'·'; color: rgba(28,43,30,.6); margin-right: 2px; }

/* ================================================================
   AI SUPPORT SYSTEM — VISUAL LAYER
================================================================ */

/* AI message bubble — distinct from teller */
.chat-msg.ai-msg { align-self: flex-start; }
.chat-msg.ai-msg .chat-bubble {
  background: linear-gradient(135deg, #0d1f14 0%, #0f1c15 100%);
  border: 1px solid rgba(61,220,132,.18);
  color: var(--text);
  border-radius: 2px 8px 8px 8px;
  position: relative;
}
/* Thin top accent on AI bubble */
.chat-msg.ai-msg .chat-bubble::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, rgba(61,220,132,.4), transparent);
  border-radius: 2px 8px 0 0;
}
.chat-time.ai-label {
  color: var(--green3);
  font-weight: 600;
}
/* AI quick-action buttons row */
.ai-quick-btns {
  display: flex; flex-wrap: wrap; gap: 6px;
  margin-top: 8px;
}
.ai-qbtn {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px; letter-spacing: .06em; text-transform: uppercase;
  padding: 5px 11px; border-radius: 3px; cursor: pointer;
  border: 1px solid rgba(61,220,132,.25); background: rgba(61,220,132,.05);
  color: var(--green2); font-weight: 600;
  transition: all .2s;
}
.ai-qbtn:hover {
  background: rgba(61,220,132,.12); border-color: rgba(61,220,132,.4);
  color: #a0ffcc;
}
.ai-qbtn.ai-qbtn-escalate {
  border-color: rgba(255,179,71,.3); background: rgba(255,179,71,.05); color: var(--amber);
}
.ai-qbtn.ai-qbtn-escalate:hover {
  background: rgba(255,179,71,.12); border-color: rgba(255,179,71,.5);
}
/* Escalation banner — shown when chat is in escalated state */
.ai-escalation-banner {
  display: flex; align-items: center; gap: 10px;
  background: rgba(255,179,71,.07); border: 1px solid rgba(255,179,71,.25);
  border-radius: 4px; padding: 10px 14px; margin: 8px 10px;
  font-size: 12px; color: var(--amber); line-height: 1.5;
}
.ai-escalation-banner strong { color: #ffd080; }
/* AI typing indicator */
.ai-typing {
  display: flex; align-items: center; gap: 5px;
  padding: 9px 13px; font-size: 12px; color: var(--green3);
  font-family: 'IBM Plex Mono', monospace; letter-spacing: .05em;
}
.ai-typing-dots { display: flex; gap: 3px; }
.ai-typing-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: var(--green3);
  animation: aiDotBounce .9s ease-in-out infinite;
}
.ai-typing-dot:nth-child(2) { animation-delay: .18s; }
.ai-typing-dot:nth-child(3) { animation-delay: .36s; }
@keyframes aiDotBounce {
  0%,80%,100% { transform: translateY(0); opacity:.4; }
  40% { transform: translateY(-5px); opacity:1; }
}
/* AI status badge in chat header */
.ai-status-chip {
  display: inline-flex; align-items: center; gap: 5px;
  font-family: 'IBM Plex Mono', monospace; font-size: 9px;
  letter-spacing: .12em; text-transform: uppercase; font-weight: 700;
  padding: 3px 9px; border-radius: 100px;
  background: rgba(61,220,132,.08); border: 1px solid rgba(61,220,132,.2);
  color: var(--green2);
}
.ai-status-chip::before { content: '◉'; font-size: 7px; }
.ai-status-chip.escalated {
  background: rgba(255,179,71,.08); border-color: rgba(255,179,71,.25); color: var(--amber);
}
.ai-status-chip.escalated::before { content: '◉'; color: var(--amber); }
.ai-status-chip.disabled {
  background: rgba(61,92,68,.12); border-color: var(--border); color: var(--text3);
}
/* Connect with agent button — persistent in input area */
.ai-connect-btn {
  font-family: 'IBM Plex Mono', monospace; font-size: 10px;
  letter-spacing: .07em; text-transform: uppercase; font-weight: 700;
  padding: 0 12px; border-radius: 3px; cursor: pointer; white-space: nowrap;
  border: 1px solid rgba(255,179,71,.35); background: rgba(255,179,71,.05);
  color: var(--amber); transition: all .22s; height: 32px;
}
.ai-connect-btn:hover {
  background: rgba(255,179,71,.12); border-color: rgba(255,179,71,.55);
}

/* ================================================================
   AI CONTROL CENTER — TELLER PANEL
================================================================ */
.ai-control-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;
}
.ai-stat-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 4px; padding: 18px 20px; position: relative; overflow: hidden;
}
.ai-stat-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, rgba(61,220,132,.35), transparent);
}
.ai-stat-val {
  font-family: 'Cormorant Garamond', serif;
  font-size: 38px; font-weight: 600; line-height: 1; color: var(--text);
  margin-bottom: 5px;
}
.ai-stat-lbl {
  font-family: 'IBM Plex Mono', monospace; font-size: 9px;
  letter-spacing: .14em; text-transform: uppercase; color: var(--text3);
  font-weight: 700;
}
.ai-log-row {
  display: flex; gap: 12px; padding: 8px 0;
  border-bottom: 1px solid var(--border); font-size: 12px;
  align-items: flex-start;
}
.ai-log-row:last-child { border-bottom: none; }
.ai-log-time {
  font-family: 'IBM Plex Mono', monospace; font-size: 10px;
  color: var(--text3); min-width: 120px; flex-shrink: 0; padding-top: 1px;
}
.ai-log-channel {
  font-family: 'IBM Plex Mono', monospace; font-size: 9px;
  letter-spacing: .08em; text-transform: uppercase; font-weight: 700;
  min-width: 60px; flex-shrink: 0; padding-top: 2px;
}
.ai-log-channel.pub { color: var(--blue); }
.ai-log-channel.acc { color: var(--green2); }
.ai-log-q { flex: 1; color: var(--text); }
.ai-log-outcome {
  font-family: 'IBM Plex Mono', monospace; font-size: 9px;
  padding: 2px 8px; border-radius: 100px; white-space: nowrap; font-weight: 600;
}
.ai-log-outcome.answered { background: rgba(61,220,132,.1); color: var(--green2); border: 1px solid rgba(61,220,132,.2); }
.ai-log-outcome.escalated { background: rgba(255,179,71,.1); color: var(--amber); border: 1px solid rgba(255,179,71,.2); }
.ai-faq-item {
  display: flex; align-items: center; justify-content: space-between;
  gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border);
  font-size: 12px;
}
.ai-faq-item:last-child { border-bottom: none; }
.ai-faq-q { flex: 1; color: var(--text2); }
.ai-faq-count {
  font-family: 'IBM Plex Mono', monospace; font-size: 10px;
  color: var(--green3); font-weight: 700; white-space: nowrap;
}
.ai-toggle-row {
  display: flex; align-items: center; justify-content: space-between;
  gap: 14px; padding: 12px 0; border-bottom: 1px solid var(--border);
}
.ai-toggle-row:last-child { border-bottom: none; }
.ai-toggle-label { font-size: 13px; font-weight: 500; }
.ai-toggle-sub { font-size: 11px; color: var(--text3); margin-top: 2px; }
/* Toggle switch */
.ai-toggle {
  position: relative; width: 42px; height: 22px; flex-shrink: 0; cursor: pointer;
}
.ai-toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
.ai-toggle-track {
  position: absolute; inset: 0; border-radius: 100px;
  background: var(--surface2); border: 1px solid var(--border2);
  transition: background .25s, border-color .25s;
}
.ai-toggle input:checked + .ai-toggle-track { background: var(--green3); border-color: var(--green2); }
.ai-toggle-thumb {
  position: absolute; top: 3px; left: 3px; width: 14px; height: 14px;
  border-radius: 50%; background: var(--text3);
  transition: transform .25s, background .25s;
}
.ai-toggle input:checked ~ .ai-toggle-thumb { transform: translateX(20px); background: var(--green); }
.ai-sensitivity-row {
  display: flex; align-items: center; gap: 12px; margin-top: 4px;
}
.ai-sensitivity-row input[type=range] {
  flex: 1; accent-color: var(--green2);
}
.ai-faq-add-row {
  display: flex; gap: 8px; margin-bottom: 14px;
}
.ai-faq-add-row input {
  flex: 1; background: var(--surface); border: 1px solid var(--border);
  color: var(--text); padding: 7px 12px; border-radius: 3px;
  font-family: 'Syne', sans-serif; font-size: 13px;
}
.ai-faq-add-row input:focus { outline: none; border-color: var(--green3); }

/* ================================================================
   AUTH PAGES
================================================================ */
.auth-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:radial-gradient(ellipse 50% 50% at 50% 0%,rgba(61,220,132,.05) 0%,transparent 70%);}
.auth-box{width:100%;max-width:400px;}
.auth-logo{text-align:center;margin-bottom:32px;}
.auth-logo-mark{width:44px;height:44px;background:var(--green);border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-size:22px;color:#050a06;font-weight:700;margin-bottom:10px;}
.auth-logo p{font-size:11px;color:var(--text3);letter-spacing:0.08em;text-transform:uppercase;margin-top:4px;}
.auth-back{background:none;border:none;color:var(--text2);font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px;margin-bottom:24px;font-family:'Syne',sans-serif;transition:color .15s;}
.auth-back:hover{color:var(--green);}
.auth-card-title{font-family:'Cormorant Garamond',serif;font-size:26px;margin-bottom:6px;}
.auth-card-sub{font-size:12px;color:var(--text2);margin-bottom:24px;}
.lock-screen{text-align:center;padding:36px 20px;}
.lock-icon{font-size:40px;margin-bottom:14px;}
.lock-title{font-family:'Cormorant Garamond',serif;font-size:22px;margin-bottom:8px;color:var(--red);}
.lock-sub{color:var(--text2);font-size:12px;margin-bottom:20px;line-height:1.6;}

/* ================================================================
   DASHBOARD LAYOUT
================================================================ */
.dash-layout{display:flex;width:100%;min-height:100vh;}
.sidebar{width:248px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto;}
.sidebar-logo{padding:20px 20px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;font-family:'Cormorant Garamond',serif;font-size:19px;font-weight:600;}
.sidebar-logo .lm{width:26px;height:26px;background:var(--green);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#050a06;font-weight:700;flex-shrink:0;}
.sidebar-user{padding:14px 20px 14px;border-bottom:1px solid var(--border);}
.su-name{font-size:13px;font-weight:600;}
.su-acc{font-size:11px;color:var(--text3);font-family:'IBM Plex Mono',monospace;margin-top:3px;}
.sidebar-nav{flex:1;padding:12px 10px;}
.snav-item{display:flex;align-items:center;gap:11px;padding:9px 11px;border-radius:3px;cursor:pointer;font-size:13px;color:var(--text2);transition:all .14s;margin-bottom:1px;border:none;background:none;width:100%;text-align:left;font-family:'Syne',sans-serif;font-weight:500;}
.snav-item:hover{background:var(--surface);color:var(--text);}
.snav-item.active{background:var(--green-glow);color:var(--green);border:1px solid rgba(61,220,132,.12);}
.snav-item.active{margin-bottom:0;} /* compensate border */
.snav-icon{width:16px;text-align:center;font-size:14px;flex-shrink:0;}
.snav-notif{width:6px;height:6px;background:var(--red);border-radius:50%;margin-left:auto;flex-shrink:0;}
.sidebar-bottom{padding:14px 20px;border-top:1px solid var(--border);}

.dash-main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.dash-topbar{position:sticky;top:0;z-index:10;background:rgba(12,18,16,.9);backdrop-filter:blur(14px);border-bottom:1px solid var(--border);padding:0 28px;height:56px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.dash-topbar-title{font-size:14px;font-weight:600;}
.dash-topbar-right{display:flex;align-items:center;gap:12px;}
.dash-scroll{flex:1;overflow-y:auto;padding:26px 28px;}

/* TAB SYSTEM */
.tab-pane{display:none;}
.tab-pane.active{display:block;}

/* ACCOUNT BALANCE CARDS */
.bal-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:26px;}
.bal-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:18px;position:relative;overflow:hidden;}
.bal-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;}
.bal-card.checking::after{background:var(--green3);}
.bal-card.savings::after{background:var(--blue);}
.bal-card.loan::after{background:var(--amber);}
.bc-label{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);margin-bottom:10px;font-weight:600;}
.bc-amount{font-family:'Cormorant Garamond',serif;font-size:30px;font-weight:600;line-height:1;}
.bc-sub{font-size:11px;color:var(--text3);margin-top:5px;}
.bc-amount.green{color:var(--green);}
.bc-amount.amber{color:var(--amber);}

/* TRANSACTION ROW */
.tx-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);}
.tx-row:last-child{border-bottom:none;}
.tx-left{display:flex;align-items:center;gap:12px;}
.tx-ic{width:34px;height:34px;border-radius:7px;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.tx-desc{font-size:13px;font-weight:500;}
.tx-meta{font-size:11px;color:var(--text3);font-family:'IBM Plex Mono',monospace;margin-top:2px;}
.tx-amt{font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:500;text-align:right;}
.tx-amt.cr{color:var(--green);}
.tx-amt.dr{color:var(--red);}
.tx-cat{font-size:10px;color:var(--text3);margin-top:2px;text-align:right;}

/* FROZEN BANNER */
.frozen-bar{background:rgba(255,77,77,.1);border:1px solid rgba(255,77,77,.25);border-radius:3px;padding:10px 16px;font-size:12px;color:var(--red);margin-bottom:18px;display:none;align-items:center;gap:10px;}
.frozen-bar.show{display:flex;}

/* PROGRESS BAR */
.prog-wrap{background:var(--border);border-radius:100px;height:4px;overflow:hidden;margin-top:6px;}
.prog-fill{height:100%;border-radius:100px;transition:width .3s;}
.prog-green{background:var(--green2);}
.prog-amber{background:var(--amber);}

/* DEPOSIT MODAL STYLE */
.deposit-info-box{background:var(--bg2);border:1px solid var(--border2);border-radius:4px;padding:18px;font-size:13px;line-height:1.7;color:var(--text2);}
.deposit-info-box strong{color:var(--text);}

/* ================================================================
   TELLER PANEL
================================================================ */
.teller-role-badge{padding:18px 20px;border-bottom:1px solid var(--border);}
.trb-label{font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:var(--text3);font-weight:600;margin-bottom:4px;}
.trb-name{font-family:'Cormorant Garamond',serif;font-size:17px;}
.trb-id{font-size:11px;color:var(--amber);font-family:'IBM Plex Mono',monospace;margin-top:3px;}

/* ADMIN SUMMARY CARDS */
.admin-sum-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:26px;}
.asm-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:16px;}
.asm-val{font-family:'IBM Plex Mono',monospace;font-size:18px;font-weight:500;margin-bottom:4px;}
.asm-lbl{font-size:10px;text-transform:uppercase;letter-spacing:.1em;color:var(--text3);font-weight:600;}
.asm-val.green{color:var(--green);}
.asm-val.amber{color:var(--amber);}
.asm-val.red{color:var(--red);}

/* ACCOUNT LIST ROW */
.acc-list-row{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:14px 16px;margin-bottom:8px;transition:border-color .15s;}
.acc-list-row:hover{border-color:var(--border2);}
.alr-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.alr-name{font-size:14px;font-weight:600;}
.alr-num{font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--text3);}
.alr-balances{display:flex;gap:28px;}
.alr-bal-item{font-size:12px;}
.alr-bal-lbl{font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--text3);font-weight:600;margin-bottom:2px;}
.alr-bal-val{font-family:'IBM Plex Mono',monospace;}

/* RECURRING ROW */
.recur-row{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:12px 16px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;}
.rr-info{flex:1;}
.rr-name{font-size:13px;font-weight:500;}
.rr-meta{font-size:11px;color:var(--text3);margin-top:2px;font-family:'IBM Plex Mono',monospace;}

/* CHAT */
.chat-win{display:flex;flex-direction:column;height:420px;border:1px solid var(--border);border-radius:4px;overflow:hidden;}
.chat-msgs{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:10px;}
.chat-msg{display:flex;flex-direction:column;max-width:78%;}
.chat-msg.cust{align-self:flex-start;}
.chat-msg.teller{align-self:flex-end;}
.chat-bubble{padding:9px 13px;border-radius:7px;font-size:13px;line-height:1.5;}
.chat-msg.cust .chat-bubble{background:var(--surface2);color:var(--text);border-radius:2px 7px 7px 7px;}
.chat-msg.teller .chat-bubble{background:var(--green2);color:#fff;border-radius:7px 2px 7px 7px;}
.chat-time{font-size:10px;color:var(--text3);margin-top:3px;font-family:'IBM Plex Mono',monospace;}
.chat-msg.teller .chat-time{text-align:right;}
.chat-input-row{display:flex;gap:8px;padding:10px;background:var(--bg2);border-top:1px solid var(--border);}
.chat-input{flex:1;background:var(--surface);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:3px;font-family:'Syne',sans-serif;font-size:13px;}
.chat-input:focus{outline:none;border-color:var(--green3);}

/* AUDIT */
.audit-row{display:flex;gap:14px;padding:9px 0;border-bottom:1px solid var(--border);font-size:12px;}
.audit-row:last-child{border-bottom:none;}
.audit-time{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--text3);min-width:130px;flex-shrink:0;padding-top:1px;}
.audit-action{flex:1;color:var(--text);}
.audit-actor{color:var(--text3);font-size:11px;white-space:nowrap;}

/* GRID HELPERS */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
@media(max-width:860px){.g2,.g3{grid-template-columns:1fr;}}

/* CODE BOX */
.code-box{background:var(--bg);border:1px solid var(--border);border-radius:3px;padding:12px 16px;font-family:'IBM Plex Mono',monospace;font-size:15px;letter-spacing:.1em;color:var(--green);}

/* ================================================================
   CHAT LIFECYCLE MANAGEMENT
================================================================ */
.chat-status-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:100px;font-size:10px;font-weight:600;letter-spacing:.07em;text-transform:uppercase;white-space:nowrap;}
.chat-status-badge::before{content:'●';font-size:6px;}
.cs-active  {background:rgba(61,220,132,.1); color:var(--green); border:1px solid rgba(61,220,132,.25);}
.cs-awaiting{background:rgba(255,179,71,.1); color:var(--amber); border:1px solid rgba(255,179,71,.25);}
.cs-resolved{background:rgba(77,166,255,.1); color:var(--blue);  border:1px solid rgba(77,166,255,.25);}
.cs-closed  {background:rgba(61,92,68,.15);  color:var(--text3); border:1px solid var(--border);}
.cs-archived{background:rgba(20,20,20,.3);   color:#485249;      border:1px solid #1a2218;}

.chat-list-item{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:14px 16px;margin-bottom:8px;transition:border-color .15s,opacity .2s;}
.chat-list-item:hover{border-color:var(--border2);}
.chat-list-item.archived{opacity:.5;filter:saturate(.4);}
.chat-list-item.closed  {border-left:3px solid var(--border2);}
.chat-list-item.active  {border-left:3px solid var(--green3);}
.chat-list-item.awaiting{border-left:3px solid rgba(255,179,71,.6);}
.cli-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:6px;}
.cli-name{font-size:13px;font-weight:600;}
.cli-meta{font-size:11px;color:var(--text3);font-family:'IBM Plex Mono',monospace;margin-top:2px;}
.cli-id{font-size:10px;color:var(--text3);font-family:'IBM Plex Mono',monospace;}
.cli-preview{font-size:12px;color:var(--text2);margin-bottom:10px;line-height:1.4;}
.cli-footer{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;}
.cli-actions{display:flex;gap:5px;flex-wrap:wrap;}
.cli-ts{font-size:10px;color:var(--text3);font-family:'IBM Plex Mono',monospace;}

.chat-closed-notice{background:var(--bg2);border:1px solid var(--border);border-radius:3px;padding:11px 16px;font-size:12px;color:var(--text3);text-align:center;display:none;margin:8px 10px;}
.chat-iaw{position:relative;}
.chat-iaw.is-closed .chat-input-row{display:none;}
.chat-iaw.is-closed .chat-closed-notice{display:block;}

.support-filter-bar{display:flex;align-items:center;gap:7px;margin-bottom:14px;flex-wrap:wrap;}
.sfb-search{flex:1;min-width:160px;background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:7px 12px;border-radius:3px;font-family:'Syne',sans-serif;font-size:12px;}
.sfb-search:focus{outline:none;border-color:var(--green3);}
.sfb-btn{padding:6px 12px;font-size:11px;border-radius:3px;background:var(--surface);border:1px solid var(--border);color:var(--text2);cursor:pointer;font-family:'Syne',sans-serif;font-weight:500;letter-spacing:.03em;transition:all .15s;white-space:nowrap;}
.sfb-btn:hover{background:var(--surface2);color:var(--text);}
.sfb-btn.active{background:var(--green-glow);color:var(--green);border-color:rgba(61,220,132,.2);}

.cust-chat-status-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--bg2);border:1px solid var(--border);border-bottom:none;border-radius:4px 4px 0 0;font-size:12px;}
.new-chat-btn-wrap{text-align:center;padding:14px;border:1px solid var(--border);border-top:none;border-radius:0 0 4px 4px;background:var(--bg2);display:none;}

.del-modal-warn{background:rgba(255,77,77,.07);border:1px solid rgba(255,77,77,.2);border-radius:3px;padding:12px 14px;font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:18px;}
.del-modal-warn strong{color:var(--red);}

/* ================================================================
   PUBLIC SUPPORT PAGE
================================================================ */
#page-public-support { background: var(--bg); }
.pub-support-wrap {
  min-height: 100vh; display: flex; flex-direction: column;
}
.pub-support-topbar {
  background: rgba(8,12,10,.96); backdrop-filter: blur(24px);
  border-bottom: 1px solid var(--border);
  padding: 0 60px; height: 64px;
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.pub-support-topbar-logo {
  display: flex; align-items: center; gap: 10px;
  font-family: 'Cormorant Garamond', serif; font-size: 19px;
  font-weight: 600; color: var(--text);
}
.pub-support-topbar-logo .lm {
  width: 26px; height: 26px; background: var(--green); border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; color: #050a06; font-weight: 800;
}
.pub-support-main {
  flex: 1; display: grid; grid-template-columns: 300px 1fr;
  max-width: 1000px; width: 100%; margin: 40px auto;
  gap: 24px; padding: 0 24px;
}
.pub-support-info {
  display: flex; flex-direction: column; gap: 16px;
}
.pub-info-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 6px; padding: 20px;
}
.pub-info-card-title {
  font-size: 12px; font-weight: 600; margin-bottom: 8px;
  display: flex; align-items: center; gap: 8px;
}
.pub-info-card-text { font-size: 12px; color: var(--text2); line-height: 1.65; }
.pub-channel-tag {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: 10px; font-weight: 600; letter-spacing: .08em;
  text-transform: uppercase; padding: 3px 10px; border-radius: 100px;
  margin-bottom: 14px;
}
.pub-channel-tag.public {
  background: rgba(77,166,255,.1); color: var(--blue);
  border: 1px solid rgba(77,166,255,.2);
}
.pub-channel-tag.account {
  background: rgba(61,220,132,.1); color: var(--green);
  border: 1px solid rgba(61,220,132,.2);
}
.pub-channel-tag::before { content: '●'; font-size: 7px; }
.pub-rules-list {
  display: flex; flex-direction: column; gap: 7px;
  font-size: 12px; color: var(--text2);
}
.pub-rules-list li {
  list-style: none; display: flex; align-items: flex-start; gap: 8px;
  line-height: 1.5;
}
.pub-rules-list li::before { content: '—'; color: var(--text3); flex-shrink: 0; }

/* ---- SUPPORT CHANNEL CHAT WRAPPER ---- */
.support-chat-area { display: flex; flex-direction: column; gap: 0; }
.support-channel-header {
  background: var(--surface); border: 1px solid var(--border);
  border-bottom: none; border-radius: 6px 6px 0 0;
  padding: 14px 20px;
  display: flex; align-items: center; justify-content: space-between;
}
.sch-label { display: flex; align-items: center; gap: 10px; }
.sch-label-title { font-size: 13px; font-weight: 600; }
.sch-label-sub { font-size: 11px; color: var(--text2); margin-top:2px; }
.support-chat-area .chat-win {
  border-radius: 0 0 6px 6px; border-top: none; height: 480px;
}

/* ---- DASHBOARD: TWO-CHANNEL SUPPORT ---- */
.support-channel-tabs {
  display: flex; gap: 1px; background: var(--border);
  border: 1px solid var(--border); border-radius: 4px 4px 0 0;
  overflow: hidden; margin-bottom: 0;
}
.sct-btn {
  flex: 1; padding: 11px 16px; background: var(--surface2);
  border: none; cursor: pointer; font-family: 'Syne', sans-serif;
  font-size: 12px; font-weight: 500; color: var(--text2);
  transition: all .18s; display: flex; flex-direction: column;
  align-items: flex-start; gap: 2px;
}
.sct-btn:hover { background: var(--surface); color: var(--text); }
.sct-btn.active { background: var(--bg2); color: var(--text); }
.sct-btn-label { display: flex; align-items: center; gap: 7px; font-size: 13px; }
.sct-btn-sub { font-size: 10px; color: var(--text3); letter-spacing: .03em; }
.sct-btn.active .sct-btn-sub { color: var(--text2); }
.support-tab-pane { display: none; }
.support-tab-pane.active { display: block; }
.support-pane-header {
  background: var(--surface); border: 1px solid var(--border);
  border-top: none; border-bottom: none;
  padding: 12px 18px;
  display: flex; align-items: center; justify-content: space-between;
}
.support-pane-header-info { display: flex; align-items: center; gap: 10px; }
.account-chat-wrap .chat-win {
  border-radius: 0 0 4px 4px; border-top: none; height: 400px;
}
.public-chat-wrap .chat-win {
  border-radius: 0 0 4px 4px; border-top: none; height: 400px;
}
/* Green top accent for account support */
.account-chat-wrap .chat-win { border-top: 2px solid var(--green3); }
/* Blue top accent for general support */
.public-chat-wrap .chat-win { border-top: 2px solid rgba(77,166,255,.4); }

/* Teller chats: show channel type */
.teller-chat-channel-badge {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 10px; font-weight: 600; letter-spacing: .06em;
  text-transform: uppercase; padding: 2px 8px; border-radius: 100px;
}
.tcc-public {
  background: rgba(77,166,255,.1); color: var(--blue);
  border: 1px solid rgba(77,166,255,.2);
}
.tcc-account {
  background: rgba(61,220,132,.1); color: var(--green);
  border: 1px solid rgba(61,220,132,.2);
}

/* ================================================================
   TELLER QOL — STATUS BAR / QUICK ACTIONS / SEARCH / NOTIFS
================================================================ */
.t-status-bar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 8px 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 12px;
  flex-wrap: wrap;
  position: sticky;
  top: 0;
  z-index: 50;
}
.tsb-indicator { display:flex; align-items:center; gap:7px; font-weight:600; min-width:130px; }
.tsb-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--green); box-shadow: 0 0 6px var(--green);
  animation: tsb-pulse 2s ease-in-out infinite;
}
.tsb-dot.warn { background: var(--amber); box-shadow: 0 0 6px var(--amber); }
.tsb-dot.crit { background: var(--red); box-shadow: 0 0 6px var(--red); }
@keyframes tsb-pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
.tsb-stats { display:flex; align-items:center; gap:10px; flex:1; flex-wrap:wrap; }
.tsb-stat { display:flex; gap:5px; align-items:center; }
.tsb-stat span:first-child { font-weight:700; font-family:'IBM Plex Mono',monospace; font-size:13px; color:var(--text); }
.tsb-stat span:last-child { color:var(--text3); font-size:11px; }
.tsb-stat.tsb-stat-warn span:first-child { color:var(--amber); }
.tsb-stat.tsb-stat-crit span:first-child { color:var(--red); }
.tsb-divider { width:1px; height:16px; background:var(--border); }
.tsb-right { display:flex; align-items:center; gap:10px; margin-left:auto; }

/* Notification bell */
.t-notif-bell-wrap { position:relative; }
.t-notif-bell {
  background: none; border: none; cursor: pointer;
  font-size: 18px; padding: 4px 6px; border-radius: 6px;
  position: relative; transition: background 0.15s;
  color: var(--text2);
}
.t-notif-bell:hover { background: var(--bg3); }
.t-notif-badge {
  position: absolute; top: 0; right: 0;
  background: var(--red); color: #fff;
  font-size: 9px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;
  border-radius: 10px; padding: 1px 4px; min-width: 16px; text-align: center;
  line-height: 14px;
}
.t-notif-dropdown {
  position: absolute; top: 36px; right: 0;
  width: 320px; background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; box-shadow: 0 8px 32px rgba(0,0,0,.4); z-index: 200;
  overflow: hidden;
}
.tnd-header {
  padding: 10px 14px; font-size: 12px; font-weight: 700; letter-spacing: .06em;
  border-bottom: 1px solid var(--border); display:flex; justify-content:space-between; align-items:center;
}
.tnd-header span { background:var(--bg3); border-radius:10px; padding:1px 7px; font-size:11px; color:var(--text3); }
.tnd-list { max-height: 280px; overflow-y: auto; }
.tnd-item {
  padding: 10px 14px; font-size: 12px; border-bottom: 1px solid var(--border2);
  cursor: pointer; transition: background 0.1s;
}
.tnd-item:hover { background: var(--bg3); }
.tnd-item.tnd-warn { border-left: 3px solid var(--amber); }
.tnd-item.tnd-crit { border-left: 3px solid var(--red); }
.tnd-item.tnd-info { border-left: 3px solid var(--green2); }
.tnd-item-title { font-weight: 600; margin-bottom: 2px; }
.tnd-item-sub { color: var(--text3); font-size: 11px; }
.tnd-footer { padding: 8px 14px; border-top: 1px solid var(--border); }

/* Global search */
.t-global-search-wrap { position: relative; }
.t-global-search {
  background: var(--bg3); border: 1px solid var(--border); border-radius: 8px;
  padding: 6px 12px; color: var(--text); font-size: 12px;
  font-family: 'Syne', sans-serif; width: 220px; transition: border-color 0.2s, width 0.2s;
}
.t-global-search:focus { outline: none; border-color: var(--green2); width: 280px; }
.t-search-results {
  position: absolute; top: 36px; left: 0; right: 0;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,.4); z-index: 200;
  max-height: 320px; overflow-y: auto;
}
.tsr-item {
  padding: 10px 14px; font-size: 12px; cursor: pointer; border-bottom: 1px solid var(--border2);
  transition: background 0.1s;
}
.tsr-item:hover { background: var(--bg3); }
.tsr-item:last-child { border-bottom: none; }
.tsr-type { font-size: 10px; color: var(--text3); margin-bottom: 2px; letter-spacing:.05em; }
.tsr-name { font-weight: 600; }
.tsr-meta { font-size: 11px; color: var(--text2); margin-top: 1px; }

/* Quick action cards */
.t-quick-actions { display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin-bottom:4px; }
@media(max-width:1100px){ .t-quick-actions { grid-template-columns:repeat(3,1fr); } }
@media(max-width:700px){ .t-quick-actions { grid-template-columns:repeat(2,1fr); } }
.tqa-card {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 10px; padding: 16px 12px; text-align: center;
  cursor: pointer; transition: all 0.2s; display:flex; flex-direction:column; align-items:center; gap:8px;
  font-family: 'Syne', sans-serif;
}
.tqa-card:hover { border-color: var(--green2); background: var(--surface); transform: translateY(-2px); box-shadow: 0 4px 16px rgba(61,220,132,.1); }
.tqa-icon { font-size: 22px; line-height: 1; }
.tqa-label { font-size: 11px; font-weight: 600; color: var(--text2); letter-spacing:.04em; }

/* Recurring activity log in overview */
.recur-log-row {
  display: grid;
  grid-template-columns: 140px 80px 1fr 1fr 80px 80px;
  gap: 8px;
  padding: 6px 0;
  border-bottom: 1px solid var(--border2);
  font-size: 11px;
  align-items: center;
}
.recur-log-row:last-child { border-bottom: none; }
.recur-log-hdr { color: var(--text3); font-weight: 600; letter-spacing:.06em; font-size:10px; }

/* Escalation overdue highlight */
.chat-list-item.overdue { border-color: var(--red) !important; box-shadow: 0 0 0 2px rgba(255,77,77,.15); }
.chat-list-item.waiting { border-color: var(--amber) !important; }
.overdue-badge { background: var(--red); color: #fff; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
.waiting-badge { background: var(--amber); color: var(--bg); font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px; }

/* ---- SOUND SYSTEM — VISUAL REINFORCEMENT ---- */
@keyframes notif-bell-shake {
  0%,100%{ transform: rotate(0deg) scale(1); }
  15%     { transform: rotate(-18deg) scale(1.2); }
  30%     { transform: rotate(18deg) scale(1.2); }
  45%     { transform: rotate(-12deg) scale(1.1); }
  60%     { transform: rotate(12deg) scale(1.1); }
  75%     { transform: rotate(-6deg); }
  90%     { transform: rotate(6deg); }
}
.chat-list-item.overdue {
  border-color: var(--red) !important;
  box-shadow: 0 0 0 2px rgba(255,77,77,.2) !important;
  animation: overdue-flash 1.4s ease-in-out infinite;
}
@keyframes overdue-flash { 0%,100%{opacity:1} 50%{opacity:.75} }
.chat-list-item.waiting {
  border-color: var(--amber) !important;
  box-shadow: 0 0 0 2px rgba(255,179,71,.15) !important;
}
.notif-test-btn { transition: opacity .15s; }
.notif-test-btn:hover { opacity: .85; }

/* ---- ADVANCED RECURRING ENGINE ---- */
.recur-preview-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.ai-log-row .conf-high { color:var(--green2); }
.ai-log-row .conf-med  { color:var(--amber); }
.ai-log-row .conf-low  { color:var(--red); }
.ai-log-outcome.unmatched { color:var(--amber); }
.ai-control-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
@media(max-width:1100px){ .ai-control-grid { grid-template-columns:repeat(2,1fr); } }
@media(max-width:700px){ .ai-control-grid { grid-template-columns:1fr; } }
.ai-faq-list-wrap { margin-top:12px; }
#t-recur-filter { cursor:pointer; }
#c-recur-list .card-sm { border-left:3px solid var(--amber); }
</style>
</head>
<body>

<!-- ================================================================
     LANDING PAGE
================================================================ -->
<div id="page-landing" class="page active">

  <!-- NAV -->
  <nav class="nav" id="main-nav">
    <div class="nav-logo">
      <div class="nav-logo-mark">♣</div>
      Clover Financial
    </div>
    <div class="nav-links">
      <button class="nav-link active" id="nav-home"     onclick="landScroll('hero');setNavActive('nav-home')">Home</button>
      <button class="nav-link"        id="nav-services" onclick="landScroll('services-sect');setNavActive('nav-services')">Services</button>
      <button class="nav-link"        id="nav-about"    onclick="landScroll('about-sect');setNavActive('nav-about')">About</button>
      <button class="nav-link"        id="nav-support"  onclick="landScroll('support-sect');setNavActive('nav-support')">Support</button>
      <div class="nav-divider"></div>
      <button class="btn btn-outline btn-sm" onclick="showPage('page-login')">Member Login</button>
    </div>
  </nav>

  <!-- HERO -->
  <section class="hero" id="hero">
    <div class="hero-bg"></div>

    <!-- Left -->
    <div class="hero-left">
      <div class="hero-classification land-fade land-fade-1">
        <div class="hero-classification-rule"></div>
        <div class="hero-classification-text">Clover Financial &nbsp;·&nbsp; Digital Banking</div>
      </div>

      <h1 class="hero-h1 land-fade land-fade-2">
        Modern Banking.<br><em>Timeless</em> Security.
      </h1>

      <p class="hero-desc land-fade land-fade-3">
        Structured digital financial management with full administrative oversight. Every transaction logged. Every deposit verified.
      </p>

      <div class="hero-cta land-fade land-fade-4">
        <button class="btn btn-primary btn-lg" onclick="showPage('page-login')"><span class="sweep"></span>Login to Your Account</button>
        <button class="btn btn-outline btn-lg" onclick="showPage('page-public-support')">Connect With an Agent</button>
        <button class="btn btn-ghost btn-lg"   onclick="showPage('page-teller-login')">Teller Access</button>
      </div>

      <div class="hero-cred land-fade land-fade-5">
        <div class="hero-cred-item">Admin-Controlled Deposits</div>
        <div class="hero-cred-item">Full Audit Trail</div>
        <div class="hero-cred-item">RP Verified</div>
      </div>
    </div>



  </section>

  <!-- METRICS -->
  <div class="stats-strip">
    <div class="stats-strip-inner reveal">
      <div class="stat-item">
        <div class="stat-n" id="count-accounts">0</div>
        <div class="stat-label">Active Accounts</div>
      </div>
      <div class="stat-item">
        <div class="stat-n" id="count-transactions">0</div>
        <div class="stat-label">Transactions Logged</div>
      </div>
      <div class="stat-item">
        <div class="stat-n" id="count-loans">0</div>
        <div class="stat-label">Loans Managed</div>
      </div>
      <div class="stat-item">
        <div class="stat-n" id="count-support">0</div>
        <div class="stat-label">Support Sessions</div>
      </div>
    </div>
  </div>

  <!-- SERVICES -->
  <section class="services" id="services-sect">
    <div class="services-hdr reveal">
      <div class="services-hdr-left">
        <div class="services-hdr-eyebrow">What We Offer</div>
        <h2>Full-Spectrum<br>Banking Services</h2>
        <p>Purpose-built for controlled, audited economies where every number is real and every action is logged.</p>
      </div>
    </div>
    <div class="services-grid reveal reveal-d1">
      <div class="svc-card">
        <div class="svc-icon-wrap">🏦</div>
        <h3>Personal Banking</h3>
        <p>Checking and savings accounts with teller-controlled balances and real-time transaction logs.</p>
        <button class="svc-learn" onclick="landScroll('about-sect')">Learn More</button>
      </div>
      <div class="svc-card">
        <div class="svc-icon-wrap">🏢</div>
        <h3>Business Banking</h3>
        <p>Institutional accounts with dedicated teller oversight and complete audit trails.</p>
        <button class="svc-learn" onclick="landScroll('about-sect')">Learn More</button>
      </div>
      <div class="svc-card">
        <div class="svc-icon-wrap">📋</div>
        <h3>Loans</h3>
        <p>Admin-issued loans with configurable rates, scheduled payments, and automatic deductions.</p>
        <button class="svc-learn" onclick="landScroll('about-sect')">Learn More</button>
      </div>
      <div class="svc-card">
        <div class="svc-icon-wrap">🔄</div>
        <h3>Recurring Payments</h3>
        <p>Scheduled rent, utilities, payroll, and subscriptions with automated balance adjustments.</p>
        <button class="svc-learn" onclick="landScroll('about-sect')">Learn More</button>
      </div>
      <div class="svc-card">
        <div class="svc-icon-wrap">🛡</div>
        <h3>Security</h3>
        <p>Session locks, account freeze controls, fraud detection, and complete login audit history.</p>
        <button class="svc-learn" onclick="landScroll('about-sect')">Learn More</button>
      </div>
    </div>
  </section>

  <!-- ABOUT -->
  <section class="principles" id="about-sect">
    <div class="principles-inner">
      <div class="principles-top reveal">
        <div>
          <div class="principles-eyebrow">Our Foundation</div>
          <h2 class="principles-h">Built on Structure.<br>Driven by<br>Integrity.</h2>
        </div>
        <div class="principles-text">
          <p>Clover Financial operates as a fully controlled digital institution. Every deposit is teller-processed. No account can self-credit. The money supply is administered by authorized staff — always.</p>
          <p>Designed for economies that demand financial realism, administrative oversight, and complete ledger transparency. Every number is real. Every action is logged.</p>
        </div>
      </div>
      <div class="principles-grid reveal reveal-d1">
        <div class="principle-card">
          <div class="principle-num">01</div>
          <div class="principle-title">Controlled Money Supply</div>
          <div class="principle-desc">All funds enter the system through teller-processed deposits only. No self-crediting. No inflation.</div>
        </div>
        <div class="principle-card">
          <div class="principle-num">02</div>
          <div class="principle-title">Complete Audit Trail</div>
          <div class="principle-desc">Every transaction, login, balance edit, and admin action is timestamped and logged permanently.</div>
        </div>
        <div class="principle-card">
          <div class="principle-num">03</div>
          <div class="principle-title">Administrative Control</div>
          <div class="principle-desc">Tellers can freeze accounts, schedule recurring payments, and issue loans through a secure terminal.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- SUPPORT -->
  <section class="support-sect" id="support-sect">
    <div class="support-inner">
      <div class="support-left reveal">
        <div class="support-tag">Live Support</div>
        <div class="support-text">
          <h3>We're Here to Help</h3>
          <p>Connect with a Clover Financial agent anytime — no login required for general questions. Members can access account-specific support after logging in.</p>
          <div class="support-channel-cards">
            <div class="support-channel-card">
              <div class="support-channel-icon pub">💬</div>
              <div>
                <div class="support-channel-name pub">General Support</div>
                <div class="support-channel-desc">Open to everyone. No login needed.</div>
              </div>
            </div>
            <div class="support-channel-card">
              <div class="support-channel-icon acc">🔐</div>
              <div>
                <div class="support-channel-name acc">Account Assistance</div>
                <div class="support-channel-desc">For members. Balance, loans, account issues.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="support-right reveal reveal-d1">
        <div class="agent-status">
          <div class="agent-dot" id="agent-dot-indicator"></div>
          <div>
            <div class="agent-status-text" id="agent-status-text">Checking status…</div>
            <div style="font-size:10px;color:var(--text3);margin-top:1px" id="agent-status-sub"></div>
          </div>
        </div>
        <button class="btn btn-primary support-cta-btn btn-full" onclick="showPage('page-public-support')" style="justify-content:space-between">
          Chat With an Agent <span>→</span>
        </button>
        <button class="btn btn-ghost support-cta-btn btn-sm btn-full" onclick="showPage('page-login')" style="justify-content:space-between">
          Member Login <span style="opacity:.4">→</span>
        </button>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-top">

      <div class="footer-brand-col">
        <div class="footer-brand">
          <div class="footer-brand-mark">♣</div>
          Clover Financial
        </div>
        <div class="footer-tagline">Secure. Structured. Sovereign.</div>
        <div class="footer-rp-notice">This is a structured roleplay financial institution. All transactions are governed by administrative review. No real currency is involved.</div>
      </div>

      <div>
        <div class="footer-col-title">Banking</div>
        <div class="footer-col-links">
          <button class="footer-col-link" onclick="showPage('page-login')">Member Login</button>
          <button class="footer-col-link" onclick="landScroll('services-sect')">Personal Banking</button>
          <button class="footer-col-link" onclick="landScroll('services-sect')">Loans</button>
          <button class="footer-col-link" onclick="landScroll('services-sect')">Recurring Payments</button>
        </div>
      </div>

      <div>
        <div class="footer-col-title">Support</div>
        <div class="footer-col-links">
          <button class="footer-col-link" onclick="showPage('page-public-support')">General Support</button>
          <button class="footer-col-link" onclick="showPage('page-login')">Account Assistance</button>
          <button class="footer-col-link" onclick="landScroll('about-sect')">How It Works</button>
        </div>
      </div>

      <div>
        <div class="footer-col-title">Security</div>
        <div class="footer-col-links">
          <button class="footer-col-link" onclick="landScroll('about-sect')">Account Controls</button>
          <button class="footer-col-link" onclick="landScroll('about-sect')">Audit Logging</button>
          <button class="footer-col-link" onclick="showPage('page-teller-login')">Teller Access</button>
        </div>
      </div>

    </div>
    <div class="footer-bottom">
      <div class="footer-copy">© 2025 Clover Financial</div>
      <div class="footer-badges">
        <span class="footer-badge">RP Platform</span>
        <span class="footer-badge">Admin Verified</span>
      </div>
    </div>
  </footer>

</div>

<!-- ================================================================
     PUBLIC SUPPORT PAGE (NO LOGIN REQUIRED)
================================================================ -->
<div id="page-public-support" class="page">
  <div class="pub-support-wrap">

    <!-- Top bar -->
    <div class="pub-support-topbar">
      <div class="pub-support-topbar-logo">
        <div class="lm">♣</div>
        Clover Financial
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <button class="auth-back" style="margin:0" onclick="showPage('page-landing')">← Back to Home</button>
        <button class="btn btn-outline btn-sm" onclick="showPage('page-login')">Member Login</button>
      </div>
    </div>

    <!-- Main layout -->
    <div class="pub-support-main">

      <!-- Left info panel -->
      <div class="pub-support-info">

        <div class="pub-info-card">
          <div class="pub-channel-tag public">General Support</div>
          <div class="pub-info-card-title">💬 Open to Everyone</div>
          <div class="pub-info-card-text">No account or login required. Ask us anything about our services, how to open an account, or general banking questions.</div>
        </div>

        <div class="pub-info-card">
          <div class="pub-info-card-title" style="color:var(--text3);font-size:11px;text-transform:uppercase;letter-spacing:.08em">What we can help with</div>
          <ul class="pub-rules-list" style="margin-top:8px">
            <li>General banking inquiries</li>
            <li>How to open an account</li>
            <li>Information about our services</li>
            <li>Loan and product questions</li>
            <li>Non-account-specific help</li>
          </ul>
        </div>

        <div class="pub-info-card" style="border-color:rgba(61,220,132,.15)">
          <div class="pub-channel-tag account">Account Assistance</div>
          <div class="pub-info-card-text" style="margin-bottom:12px">For balance disputes, loan management, or account-specific issues, please log in securely.</div>
          <button class="btn btn-outline btn-full btn-sm" onclick="showPage('page-login')">Login for Account Support →</button>
        </div>

        <div class="pub-info-card">
          <div id="pub-agent-status-box" class="agent-status" style="background:none;border:none;padding:0">
            <div class="agent-dot" id="pub-agent-dot"></div>
            <div>
              <div class="agent-status-text" id="pub-agent-text">Checking…</div>
              <div style="font-size:10px;color:var(--text3)" id="pub-agent-sub"></div>
            </div>
          </div>
        </div>

      </div>

      <!-- Right chat area -->
      <div class="support-chat-area">
        <div class="support-channel-header">
          <div class="sch-label">
            <div>
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
                <div class="pub-channel-tag public" style="margin-bottom:0">General Support</div>
                <span id="pub-chat-status-badge" class="chat-status-badge cs-active">Active</span>
              </div>
              <div class="sch-label-title">Clover Financial — Public Support</div>
              <div class="sch-label-sub" id="pub-chat-id-display">No account required · All messages are logged for compliance</div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
            <div id="pub-chat-agent-status" style="font-size:12px;color:var(--text2)"></div>
            <div id="pub-ai-chip" class="ai-status-chip">AI Active</div>
            <!-- Visitor can end session voluntarily -->
            <button class="btn btn-ghost btn-sm" onclick="pubVisitorEndSession()" id="pub-btn-end-session" style="font-size:11px">End My Session</button>
          </div>
        </div>
        <div class="chat-win" style="border-radius:0 0 6px 6px;border-top:2px solid rgba(77,166,255,.4);height:500px">
          <div class="chat-msgs" id="pub-chat-msgs"></div>
          <div class="chat-iaw" id="pub-chat-iaw">
            <div class="chat-closed-notice">This conversation has been closed. To continue, <button onclick="pubStartNewSession()" style="background:none;border:none;color:var(--green2);cursor:pointer;font-size:12px;font-family:'Syne',sans-serif;padding:0;text-decoration:underline">start a new session</button>.</div>
            <div class="chat-input-row">
              <button class="ai-connect-btn" onclick="aiUserEscalate('public','')" title="Connect with a Human Agent">⇧ Agent</button>
              <input class="chat-input" id="pub-chat-input" placeholder="Ask Clover AI a question…" onkeydown="if(event.key==='Enter')sendPublicMsg()" />
              <button class="btn btn-primary btn-sm" onclick="sendPublicMsg()">Send</button>
            </div>
          </div>
        </div>
        <div style="font-size:11px;color:var(--text3);margin-top:10px;text-align:center;padding:0 4px">
          This is a general support channel. For account-specific help, <button onclick="showPage('page-login')" style="background:none;border:none;color:var(--green2);cursor:pointer;font-size:11px;font-family:'Syne',sans-serif;padding:0">log in to your account</button>.
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ================================================================
     CUSTOMER LOGIN
================================================================ -->
<div id="page-login" class="page">
  <div class="auth-wrap">
    <div class="auth-box">
      <div class="auth-logo">
        <div class="auth-logo-mark">♣</div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:600;">Clover Financial</div>
        <p>Secure Member Portal</p>
      </div>
      <button class="auth-back" onclick="showPage('page-landing')">← Back to Home</button>
      <div class="card">
        <h2 class="auth-card-title">Member Login</h2>
        <p class="auth-card-sub">Enter your credentials to access your account dashboard.</p>
        <div id="login-alert" class="alert"></div>
        <div id="login-form">
          <div class="input-group"><label>Account Number</label><input type="text" id="l-acc" placeholder="e.g. 100001" maxlength="12" /></div>
          <div class="input-group"><label>PIN</label><input type="password" id="l-pin" placeholder="Enter PIN" maxlength="10" onkeydown="if(event.key==='Enter')doLogin()" /></div>
          <button class="btn btn-primary btn-full" onclick="doLogin()">Access Account →</button>
        </div>
        <div id="login-locked" class="lock-screen" style="display:none">
          <div class="lock-icon">🔒</div>
          <div class="lock-title">Account Locked</div>
          <div class="lock-sub">Too many failed attempts. This session has been temporarily suspended and logged.</div>
          <button class="btn btn-ghost btn-sm" onclick="resetLoginLock()">Reset Session</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================================================================
     TELLER LOGIN
================================================================ -->
<div id="page-teller-login" class="page">
  <div class="auth-wrap">
    <div class="auth-box">
      <div class="auth-logo">
        <div class="auth-logo-mark">♣</div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:600;">Clover Financial</div>
        <p>Restricted — Authorized Personnel Only</p>
      </div>
      <button class="auth-back" onclick="showPage('page-landing')">← Back to Home</button>
      <div class="card">
        <div style="margin-bottom:16px"><span class="badge b-amber">⚠ Teller Terminal</span></div>
        <h2 class="auth-card-title">Teller Authentication</h2>
        <p class="auth-card-sub">All access attempts are recorded in the system audit log.</p>
        <div id="teller-alert" class="alert"></div>
        <div id="teller-form">
          <div class="input-group"><label>Authorization Code</label><input type="password" id="t-code" placeholder="Enter teller code" maxlength="10" onkeydown="if(event.key==='Enter')doTellerLogin()" /></div>
          <button class="btn btn-primary btn-full" onclick="doTellerLogin()">Authenticate →</button>
        </div>
        <div id="teller-locked" class="lock-screen" style="display:none">
          <div class="lock-icon">🔒</div>
          <div class="lock-title">Terminal Locked</div>
          <div class="lock-sub">This terminal has been locked due to repeated authentication failures. Incident logged.</div>
          <button class="btn btn-ghost btn-sm" onclick="resetTellerLock()">Reset Terminal</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================================================================
     CUSTOMER DASHBOARD
================================================================ -->
<div id="page-dashboard" class="page">
  <div class="dash-layout">
    <aside class="sidebar">
      <div class="sidebar-logo"><div class="lm">♣</div>Clover Financial</div>
      <div class="sidebar-user">
        <div class="su-name" id="sd-name">—</div>
        <div class="su-acc" id="sd-acc">—</div>
      </div>
      <nav class="sidebar-nav">
        <button class="snav-item active" onclick="cTab('overview',this)"><span class="snav-icon">◈</span>Overview</button>
        <button class="snav-item" onclick="cTab('activity',this)"><span class="snav-icon">↕</span>Banking Activity</button>
        <button class="snav-item" onclick="cTab('withdraw',this)"><span class="snav-icon">↑</span>Withdraw</button>
        <button class="snav-item" onclick="cTab('transfer',this)"><span class="snav-icon">⇄</span>Transfer to Savings</button>
        <button class="snav-item" onclick="cTab('deposit',this)"><span class="snav-icon">↓</span>Deposit</button>
        <button class="snav-item" onclick="cTab('loans',this)"><span class="snav-icon">📋</span>Loans</button>
        <button class="snav-item" onclick="cTab('recurring',this)"><span class="snav-icon">🔄</span>Recurring</button>
        <button class="snav-item" onclick="cTab('support',this)" id="sd-support-btn"><span class="snav-icon">💬</span>Live Support<span class="snav-notif" id="sd-notif" style="display:none"></span></button>
      </nav>
      <div class="sidebar-bottom"><button class="btn btn-ghost btn-full btn-sm" onclick="doLogout()">⎋ Logout</button></div>
    </aside>

    <div class="dash-main">
      <div class="dash-topbar">
        <div class="dash-topbar-title" id="c-topbar-title">Account Overview</div>
        <div class="dash-topbar-right">
          <span id="c-frozen-badge" class="badge b-red" style="display:none">Frozen</span>
          <span id="c-flagged-badge" class="badge b-amber" style="display:none">⚠ Flagged</span>
          <span class="badge b-green">● Live</span>
        </div>
      </div>
      <div class="dash-scroll">
        <div id="c-frozen-bar" class="frozen-bar">🔒 Your account has been frozen. Contact support or visit a branch for assistance.</div>

        <!-- OVERVIEW -->
        <div id="cpane-overview" class="tab-pane active">
          <div class="bal-cards" id="c-bal-cards"><!-- js --></div>
          <div class="g2">
            <div>
              <div class="sec-label">Recent Transactions</div>
              <div class="card card-sm" id="c-recent-tx"><!-- js --></div>
            </div>
            <div>
              <div class="sec-label">Account Status</div>
              <div class="card card-sm">
                <div style="display:flex;flex-direction:column;gap:12px">
                  <div style="display:flex;justify-content:space-between;align-items:center">
                    <span style="font-size:12px;color:var(--text2)">Account Standing</span>
                    <span id="c-standing-badge" class="badge b-green">Good Standing</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center">
                    <span style="font-size:12px;color:var(--text2)">Credit Tier</span>
                    <span id="c-credit-badge" class="badge b-gray">—</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center">
                    <span style="font-size:12px;color:var(--text2)">Active Loans</span>
                    <span id="c-loan-count" class="badge b-gray">0</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center">
                    <span style="font-size:12px;color:var(--text2)">Recurring Payments</span>
                    <span id="c-recur-count" class="badge b-gray">0</span>
                  </div>
                </div>
              </div>
              <div style="margin-top:16px">
                <div class="sec-label">Active Loan Summary</div>
                <div class="card card-sm" id="c-loan-summary"><div style="color:var(--text3);font-size:12px">No active loans.</div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- BANKING ACTIVITY -->
        <div id="cpane-activity" class="tab-pane">
          <div class="sec-label">Full Transaction History</div>
          <div class="card">
            <div id="c-full-tx"><!-- js --></div>
          </div>
        </div>

        <!-- WITHDRAW -->
        <div id="cpane-withdraw" class="tab-pane">
          <div class="sec-label">Withdraw Funds</div>
          <div class="card" style="max-width:460px">
            <div id="c-wd-alert" class="alert"></div>
            <div class="input-group"><label>Withdraw From</label>
              <select id="c-wd-from"><option value="checking">Checking</option></select>
            </div>
            <div class="input-group"><label>Method</label>
              <select id="c-wd-method">
                <option>ATM Withdrawal</option><option>ACH Transfer</option>
                <option>Wire Transfer</option><option>Cash Withdrawal</option>
              </select>
            </div>
            <div class="input-group"><label>Amount ($)</label><input type="number" id="c-wd-amt" placeholder="0.00" min="0.01" step="0.01" /></div>
            <div class="input-group"><label>Notes (optional)</label><input type="text" id="c-wd-note" placeholder="e.g. Rent payment" /></div>
            <button class="btn btn-primary btn-full" onclick="doWithdraw()">Confirm Withdrawal →</button>
          </div>
        </div>

        <!-- TRANSFER TO SAVINGS -->
        <div id="cpane-transfer" class="tab-pane">
          <div class="sec-label">Transfer to Savings</div>
          <div class="card" style="max-width:460px">
            <div id="c-tr-alert" class="alert"></div>
            <p style="font-size:12px;color:var(--text2);margin-bottom:18px">Transfer funds from your Checking account to your Savings account.</p>
            <div id="c-tr-balances" style="display:flex;gap:20px;margin-bottom:18px"></div>
            <div class="input-group"><label>Amount ($)</label><input type="number" id="c-tr-amt" placeholder="0.00" min="0.01" step="0.01" /></div>
            <button class="btn btn-primary btn-full" onclick="doTransferSavings()">Transfer to Savings →</button>
          </div>
        </div>

        <!-- DEPOSIT -->
        <div id="cpane-deposit" class="tab-pane">
          <div class="sec-label">Deposit Funds</div>
          <div class="card" style="max-width:520px">
            <div class="deposit-info-box">
              <div style="font-size:16px;margin-bottom:12px">🏛</div>
              <strong>Deposits must be processed by a teller.</strong>
              <p style="margin-top:10px">To make a deposit, please visit a <strong>Clover Financial branch</strong> or contact the <strong>official Discord banking channel</strong>. Deposits must be processed by an authorized teller through the admin panel.</p>
              <p style="margin-top:10px;font-size:12px;color:var(--text3)">This policy ensures a controlled, audited money supply. Self-crediting is not permitted.</p>
            </div>
            <button class="btn btn-ghost btn-full" style="margin-top:16px" onclick="cTab('support',document.querySelector('.snav-item:nth-child(7)'))">Open Support Chat →</button>
          </div>
        </div>

        <!-- LOANS -->
        <div id="cpane-loans" class="tab-pane">
          <div class="sec-label">Active Loans</div>
          <div id="c-loans-list"><div class="card card-sm" style="color:var(--text3);font-size:12px">No active loans on this account.</div></div>
          <div style="margin-top:16px">
            <div class="sec-label">Loan Payment History</div>
            <div class="card card-sm" id="c-loan-tx"><!-- js --></div>
          </div>
        </div>

        <!-- RECURRING PAYMENTS -->
        <div id="cpane-recurring" class="tab-pane">
          <div class="sec-label">Scheduled Recurring Payments</div>
          <div id="c-recur-list"><div style="color:var(--text3);font-size:12px">No scheduled payments on your account.</div></div>
        </div>

        <!-- SUPPORT -->
        <div id="cpane-support" class="tab-pane">
          <div class="sec-label">Support Channels</div>
          <div style="max-width:660px">

            <!-- Channel tabs -->
            <div class="support-channel-tabs">
              <button class="sct-btn active" id="sct-account-btn" onclick="switchSupportChannel('account')">
                <div class="sct-btn-label">🔐 Account Assistance</div>
                <div class="sct-btn-sub">Balance disputes · Loans · Account-specific help</div>
              </button>
              <button class="sct-btn" id="sct-public-btn" onclick="switchSupportChannel('public')">
                <div class="sct-btn-label">💬 General Support</div>
                <div class="sct-btn-sub">General inquiries · Non-account questions</div>
              </button>
            </div>

            <!-- ACCOUNT ASSISTANCE -->
            <div class="support-tab-pane active" id="support-channel-account">
              <!-- Status bar (visible to customer, no delete) -->
              <div class="cust-chat-status-bar">
                <div style="display:flex;align-items:center;gap:10px">
                  <span class="pub-channel-tag account" style="margin-bottom:0">Account Assistance</span>
                  <span id="c-acc-chat-status-badge" class="chat-status-badge cs-active">Active</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                  <span id="c-acc-ai-chip" class="ai-status-chip">AI Active</span>
                  <span style="font-size:11px;color:var(--text3)" id="c-support-acc-label">Authenticated</span>
                  <button class="btn btn-ghost btn-sm" id="c-btn-end-acc-chat" onclick="custEndAccChat()" style="font-size:11px" title="End this chat session">End Session</button>
                </div>
              </div>
              <div class="account-chat-wrap">
                <div class="chat-win" style="border-radius:0;border-top:none">
                  <div class="chat-msgs" id="c-chat-msgs"></div>
                  <div class="chat-iaw" id="c-acc-chat-iaw">
                    <div class="chat-closed-notice">This conversation has been closed. To get further assistance, please <button onclick="custStartNewAccChat()" style="background:none;border:none;color:var(--green2);cursor:pointer;font-size:12px;font-family:'Syne',sans-serif;padding:0;text-decoration:underline">open a new support request</button>.</div>
                    <div class="chat-input-row">
                      <button class="ai-connect-btn" onclick="aiUserEscalate('account',currentAcc)" title="Connect with Human Agent">⇧ Agent</button>
                      <input class="chat-input" id="c-chat-input" placeholder="Ask Clover AI…" onkeydown="if(event.key==='Enter')sendCustMsg()" />
                      <button class="btn btn-primary btn-sm" onclick="sendCustMsg()">Send</button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- New chat button (shown after close) -->
              <div class="new-chat-btn-wrap" id="c-acc-new-chat-wrap">
                <button class="btn btn-outline btn-sm" onclick="custStartNewAccChat()">+ Open New Support Request</button>
              </div>
              <div style="font-size:11px;color:var(--text3);margin-top:8px;padding:0 2px">
                Authenticated channel. Your account information is accessible to our support team.
              </div>
            </div>

            <!-- GENERAL / PUBLIC -->
            <div class="support-tab-pane" id="support-channel-public">
              <div class="cust-chat-status-bar">
                <div style="display:flex;align-items:center;gap:10px">
                  <span class="pub-channel-tag public" style="margin-bottom:0">General Support</span>
                  <span id="c-pub-chat-status-badge" class="chat-status-badge cs-active">Active</span>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                  <span style="font-size:11px;color:var(--text3)">Open channel · No account data shared</span>
                  <button class="btn btn-ghost btn-sm" id="c-btn-end-pub-chat" onclick="custEndPubChat()" style="font-size:11px" title="End this chat session">End Session</button>
                </div>
              </div>
              <div class="public-chat-wrap">
                <div class="chat-win" style="border-radius:0;border-top:none">
                  <div class="chat-msgs" id="c-pub-chat-msgs"></div>
                  <div class="chat-iaw" id="c-pub-chat-iaw">
                    <div class="chat-closed-notice">This conversation has been closed. To continue, please <button onclick="custStartNewPubChat()" style="background:none;border:none;color:var(--green2);cursor:pointer;font-size:12px;font-family:'Syne',sans-serif;padding:0;text-decoration:underline">open a new support request</button>.</div>
                    <div class="chat-input-row">
                      <button class="ai-connect-btn" onclick="aiUserEscalate('public','')" title="Connect with Human Agent">⇧ Agent</button>
                      <input class="chat-input" id="c-pub-chat-input" placeholder="Ask Clover AI a question…" onkeydown="if(event.key==='Enter')sendCustPubMsg()" />
                      <button class="btn btn-primary btn-sm" onclick="sendCustPubMsg()">Send</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="new-chat-btn-wrap" id="c-pub-new-chat-wrap">
                <button class="btn btn-outline btn-sm" onclick="custStartNewPubChat()">+ Open New Support Request</button>
              </div>
              <div style="font-size:11px;color:var(--text3);margin-top:8px;padding:0 2px">
                General channel. Account balance or private data will not be disclosed here.
              </div>
            </div>

          </div>
        </div>

      </div><!-- dash-scroll -->
    </div><!-- dash-main -->
  </div>
</div>

<!-- ================================================================
     TELLER DASHBOARD
================================================================ -->
<div id="page-teller" class="page">
  <div class="dash-layout">
    <aside class="sidebar">
      <div class="teller-role-badge">
        <div class="trb-label">Teller Terminal</div>
        <div class="trb-name">Operations Panel</div>
        <div class="trb-id">AUTH: ████ · Verified</div>
      </div>
      <nav class="sidebar-nav" style="padding:12px 10px">
        <button class="snav-item active" onclick="tTab('overview',this)"><span class="snav-icon">◈</span>System Overview</button>
        <button class="snav-item" onclick="tTab('accounts',this)"><span class="snav-icon">👥</span>Account Management</button>
        <button class="snav-item" onclick="tTab('transaction',this)"><span class="snav-icon">💳</span>Create Transaction</button>
        <button class="snav-item" onclick="tTab('recurring',this)"><span class="snav-icon">🔄</span>Recurring Payments</button>
        <button class="snav-item" onclick="tTab('loans-admin',this)"><span class="snav-icon">📋</span>Loan Management</button>
        <button class="snav-item" onclick="tTab('generate',this)"><span class="snav-icon">⊕</span>Generate Account</button>
        <button class="snav-item" onclick="tTab('chats',this)" id="t-chats-btn"><span class="snav-icon">💬</span>Support Chats<span class="snav-notif" id="t-notif" style="display:none"></span></button>
        <button class="snav-item" onclick="tTab('ai-control',this)"><span class="snav-icon">🤖</span>AI Control Center</button>
        <button class="snav-item" onclick="tTab('audit',this)"><span class="snav-icon">📋</span>Audit Log</button>
        <button class="snav-item" onclick="tTab('logins',this)"><span class="snav-icon">🔐</span>Login Attempts</button>
      </nav>
      <div class="sidebar-bottom"><button class="btn btn-ghost btn-full btn-sm" onclick="showPage('page-landing')">⎋ Exit Panel</button></div>
    </aside>

    <div class="dash-main">
      <!-- LIVE SYSTEM STATUS BAR -->
      <div id="t-status-bar" class="t-status-bar">
        <div class="tsb-indicator" id="tsb-indicator">
          <span class="tsb-dot" id="tsb-dot"></span>
          <span id="tsb-label">System Active</span>
        </div>
        <div class="tsb-stats">
          <div class="tsb-stat"><span id="tsb-active-recur">0</span> <span>Recurring Active</span></div>
          <div class="tsb-divider"></div>
          <div class="tsb-stat tsb-stat-warn"><span id="tsb-failed-recur">0</span> <span>Failed</span></div>
          <div class="tsb-divider"></div>
          <div class="tsb-stat tsb-stat-warn"><span id="tsb-flagged">0</span> <span>Flagged Accs</span></div>
          <div class="tsb-divider"></div>
          <div class="tsb-stat"><span id="tsb-chats">0</span> <span>Active Chats</span></div>
        </div>
        <div class="tsb-right">
          <!-- Notification bell -->
          <div class="t-notif-bell-wrap" id="t-notif-bell-wrap">
            <button class="t-notif-bell" onclick="toggleNotifDropdown()" id="t-notif-bell-btn" title="Notifications">
              🔔
              <span class="t-notif-badge" id="t-notif-count" style="display:none">0</span>
            </button>
            <div class="t-notif-dropdown" id="t-notif-dropdown" style="display:none">
              <div class="tnd-header">Notifications <span id="tnd-count">0</span></div>
              <div class="tnd-list" id="tnd-list"><div style="padding:12px;font-size:12px;color:var(--text3)">No notifications.</div></div>
              <div class="tnd-footer"><button class="btn btn-ghost btn-sm btn-full" onclick="clearAllNotifs()">Clear All</button></div>
            </div>
          </div>
          <!-- Global search -->
          <div class="t-global-search-wrap">
            <input type="text" id="t-global-search" class="t-global-search" placeholder="🔎 Search accounts, loans, payments…" oninput="globalSearch(this.value)" autocomplete="off" />
            <div class="t-search-results" id="t-search-results" style="display:none"></div>
          </div>
          <span class="badge b-amber" style="white-space:nowrap">TELLER SESSION</span>
        </div>
      </div>
      <div class="dash-topbar">
        <div class="dash-topbar-title" id="t-topbar-title">System Overview</div>
        <div class="dash-topbar-right" style="font-size:11px;color:var(--text3)" id="t-next-execution-display"></div>
      </div>
      <div class="dash-scroll">

        <!-- TELLER OVERVIEW -->
        <div id="tpane-overview" class="tab-pane active">

          <!-- QUICK ACTIONS -->
          <div class="sec-label">Quick Actions</div>
          <div class="t-quick-actions">
            <button class="tqa-card" onclick="tTab('generate',document.querySelector('.snav-item:nth-child(6)'))">
              <div class="tqa-icon">⊕</div>
              <div class="tqa-label">Create Account</div>
            </button>
            <button class="tqa-card" onclick="tTab('transaction',document.querySelector('.snav-item:nth-child(3)'))">
              <div class="tqa-icon">💳</div>
              <div class="tqa-label">Adjust Balance</div>
            </button>
            <button class="tqa-card" onclick="tTab('recurring',document.querySelector('.snav-item:nth-child(4)'))">
              <div class="tqa-icon">🔄</div>
              <div class="tqa-label">Create Recurring</div>
            </button>
            <button class="tqa-card" onclick="tTab('accounts',document.querySelector('.snav-item:nth-child(2)'))">
              <div class="tqa-icon">🔒</div>
              <div class="tqa-label">Manage Accounts</div>
            </button>
            <button class="tqa-card" onclick="tTab('ai-control',document.querySelector('.snav-item:nth-child(8)'))">
              <div class="tqa-icon">🤖</div>
              <div class="tqa-label">AI Dashboard</div>
            </button>
          </div>

          <!-- ANALYTICS SNAPSHOT -->
          <div class="sec-label" style="margin-top:20px">System Analytics</div>
          <div class="admin-sum-grid" id="t-sum-grid"><!-- js --></div>

          <!-- RECURRING ACTIVITY LOG -->
          <div class="sec-label" style="margin-top:20px">Recurring Activity Log</div>
          <div class="card card-sm" id="t-recur-activity-log" style="max-height:200px;overflow-y:auto">
            <div style="font-size:12px;color:var(--text3)">No activity yet.</div>
          </div>

          <div class="g2" style="margin-top:20px">
            <div>
              <div class="sec-label">Flagged &amp; Frozen Accounts</div>
              <div id="t-flagged-list" class="card card-sm"><!-- js --></div>
              <div style="margin-top:16px">
                <div class="sec-label">Agent Availability Control</div>
                <div class="card card-sm">
                  <p style="font-size:12px;color:var(--text2);margin-bottom:12px">Set the agent status shown on the public landing page.</p>
                  <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <button class="btn btn-ghost btn-sm" onclick="setAgentStatus('online')" style="color:var(--green);border-color:rgba(61,220,132,.3)">🟢 Online</button>
                    <button class="btn btn-ghost btn-sm" onclick="setAgentStatus('limited')" style="color:var(--amber);border-color:rgba(255,179,71,.3)">🟡 Limited</button>
                    <button class="btn btn-ghost btn-sm" onclick="setAgentStatus('offline')" style="color:var(--red);border-color:rgba(255,77,77,.3)">🔴 Offline</button>
                  </div>
                  <div style="font-size:11px;color:var(--text3);margin-top:10px">Current: <span id="t-agent-status-display" style="color:var(--green)">Online</span></div>
                </div>
              </div>
            </div>
            <div>
              <div class="sec-label">Recent Audit Events</div>
              <div class="card card-sm" id="t-recent-audit"><!-- js --></div>
            </div>
          </div>
        </div>

        <!-- ACCOUNTS -->
        <div id="tpane-accounts" class="tab-pane">
          <div class="sec-label">All Registered Accounts</div>
          <div id="t-acc-list"><!-- js --></div>
        </div>

        <!-- CREATE TRANSACTION -->
        <div id="tpane-transaction" class="tab-pane">
          <div class="sec-label">Create Manual Transaction</div>
          <div class="card" style="max-width:540px">
            <div id="t-tx-alert" class="alert"></div>
            <div class="input-group"><label>Account</label><select id="t-tx-acc"><!-- js --></select></div>
            <div class="g2">
              <div class="input-group"><label>Transaction Type</label>
                <select id="t-tx-type">
                  <option value="credit">Credit (Add Funds)</option>
                  <option value="debit">Debit (Remove Funds)</option>
                </select>
              </div>
              <div class="input-group"><label>Target Account</label>
                <select id="t-tx-target"><option value="checking">Checking</option><option value="savings">Savings</option></select>
              </div>
            </div>
            <div class="input-group"><label>Category</label>
              <select id="t-tx-cat">
                <option>Deposit</option><option>Payroll Credit</option><option>Business Revenue</option>
                <option>Government Fine</option><option>Utility Payment</option><option>Loan Payment</option>
                <option>Savings Transfer</option><option>Administrative Credit</option><option>Withdrawal</option><option>Other</option>
              </select>
            </div>
            <div class="input-group"><label>Amount ($)</label><input type="number" id="t-tx-amt" placeholder="0.00" min="0.01" step="0.01" /></div>
            <div class="input-group"><label>Notes</label><input type="text" id="t-tx-note" placeholder="Transaction description / reference" /></div>
            <button class="btn btn-primary btn-full" onclick="createTellerTx()">Post Transaction →</button>
          </div>
        </div>

        <!-- RECURRING PAYMENTS -->
        <div id="tpane-recurring" class="tab-pane">
          <div class="sec-label">Scheduled Recurring Transactions</div>
          <div class="g2">
            <!-- LEFT: Create form -->
            <div>
              <div class="card" style="margin-bottom:14px">
                <div style="font-size:13px;font-weight:600;margin-bottom:4px">Create Recurring Payment</div>
                <div style="font-size:11px;color:var(--text3);margin-bottom:16px">Flexible interval shorthand: 5m · 1h · 2d · 1mo · 1y · 2d 12h · 1mo 5d</div>
                <div id="t-recur-alert" class="alert"></div>
                <div class="input-group"><label>Account</label><select id="t-recur-acc"><!-- js --></select></div>
                <div class="input-group"><label>Payment Label</label><input type="text" id="t-recur-name" placeholder="e.g. Monthly Rent" /></div>
                <div class="input-group"><label>Amount ($)</label><input type="number" id="t-recur-amt" placeholder="0.00" min="0.01" step="0.01" /></div>
                <div class="input-group"><label>Deduct From</label><select id="t-recur-target"><option value="checking">Checking</option><option value="savings">Savings</option></select></div>
                <div class="input-group"><label>Category</label>
                  <select id="t-recur-cat">
                    <option>Rent</option><option>Loan Payment</option><option>Subscription</option>
                    <option>Utility Bill</option><option>Insurance</option><option>Payroll</option><option>Other</option>
                  </select>
                </div>
                <div class="input-group">
                  <label>Interval <span style="font-size:10px;color:var(--text3);font-family:'IBM Plex Mono',monospace">m=minutes · h=hours · d=days · mo=months · y=years</span></label>
                  <input type="text" id="t-recur-interval" placeholder="e.g. 1mo  or  2d 12h  or  1y 2mo" autocomplete="off" />
                </div>
                <div class="g2">
                  <div class="input-group"><label>Occurrences <span style="font-size:10px;color:var(--text3)">(0 = unlimited)</span></label><input type="number" id="t-recur-occ" value="0" min="0" step="1" /></div>
                  <div class="input-group"><label>Penalty if NSF ($)</label><input type="number" id="t-recur-penalty" value="0" min="0" step="0.01" /></div>
                </div>
                <button class="btn btn-outline btn-full" style="margin-bottom:8px" onclick="previewRecurring()">Preview Schedule →</button>

                <!-- Preview confirmation panel -->
                <div id="t-recur-preview" style="display:none;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:14px;margin-top:4px">
                  <div style="font-size:11px;font-weight:700;letter-spacing:.08em;color:var(--green2);margin-bottom:10px">SCHEDULE PREVIEW</div>
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;margin-bottom:14px">
                    <div><div style="color:var(--text3);font-size:10px;margin-bottom:2px">PAYMENT</div><div id="t-rp-name" style="font-weight:600">—</div></div>
                    <div><div style="color:var(--text3);font-size:10px;margin-bottom:2px">ACCOUNT</div><div id="t-rp-account">—</div></div>
                    <div><div style="color:var(--text3);font-size:10px;margin-bottom:2px">AMOUNT</div><div id="t-rp-amount" style="color:var(--amber);font-weight:600">—</div></div>
                    <div><div style="color:var(--text3);font-size:10px;margin-bottom:2px">INTERVAL</div><div id="t-rp-interval" style="color:var(--green2)">—</div></div>
                    <div><div style="color:var(--text3);font-size:10px;margin-bottom:2px">NEXT DEDUCTION</div><div id="t-rp-next">—</div></div>
                    <div><div style="color:var(--text3);font-size:10px;margin-bottom:2px">OCCURRENCES</div><div id="t-rp-occ">—</div></div>
                    <div><div style="color:var(--text3);font-size:10px;margin-bottom:2px">NSF PENALTY</div><div id="t-rp-penalty">—</div></div>
                  </div>
                  <div style="display:flex;gap:8px">
                    <button class="btn btn-primary" style="flex:1" onclick="confirmCreateRecurring()">✓ Confirm &amp; Activate</button>
                    <button class="btn btn-ghost" onclick="cancelRecurPreview()">Cancel</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- RIGHT: Active schedules + run -->
            <div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div class="sec-label" style="margin-bottom:0">Active Schedules</div>
                <select id="t-recur-filter" onchange="renderRecurringList()" style="font-size:11px;padding:4px 8px;background:var(--surface);border:1px solid var(--border);border-radius:4px;color:var(--text2)">
                  <option value="all">All</option>
                  <option value="active">Active</option>
                  <option value="paused">Paused</option>
                  <option value="failed">Failed</option>
                  <option value="completed">Completed</option>
                </select>
              </div>
              <div id="t-recur-list"><!-- js --></div>
              <div style="margin-top:16px">
                <div class="sec-label">Process Due Payments</div>
                <div class="card card-sm">
                  <p style="font-size:12px;color:var(--text2);margin-bottom:12px">Manually trigger all payments currently due based on their schedule.</p>
                  <button class="btn btn-outline btn-full" onclick="processDuePayments()">Run Due Payments →</button>
                  <div id="t-recur-run-result" style="margin-top:10px;font-size:12px;color:var(--text2)"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- LOAN MANAGEMENT -->
        <div id="tpane-loans-admin" class="tab-pane">
          <div class="sec-label">Loan Management</div>
          <div class="g2">
            <div class="card">
              <div style="font-size:13px;font-weight:600;margin-bottom:16px">Issue New Loan</div>
              <div id="t-loan-alert" class="alert"></div>
              <div class="input-group"><label>Account</label><select id="t-loan-acc"><!-- js --></select></div>
              <div class="input-group"><label>Loan Label</label><input type="text" id="t-loan-name" placeholder="e.g. Personal Loan" /></div>
              <div class="input-group"><label>Principal Amount ($)</label><input type="number" id="t-loan-principal" placeholder="0.00" min="1" step="0.01" /></div>
              <div class="input-group"><label>Interest Rate (% APR)</label><input type="number" id="t-loan-rate" placeholder="8.5" min="0" step="0.1" /></div>
              <div class="input-group"><label>Monthly Payment ($)</label><input type="number" id="t-loan-payment" placeholder="0.00" min="1" step="0.01" /></div>
              <div class="input-group"><label>Duration (months)</label><input type="number" id="t-loan-months" placeholder="12" min="1" /></div>
              <div class="input-group"><label>Disbursement Account</label><select id="t-loan-disburse"><option value="checking">Checking</option><option value="savings">Savings</option></select></div>
              <div class="input-group"><label>Auto-Schedule Monthly Payment</label>
                <select id="t-loan-schedule"><option value="yes">Yes — auto-schedule</option><option value="no">No — manual payments only</option></select>
              </div>
              <button class="btn btn-primary btn-full" onclick="issueLoan()">Issue Loan →</button>
            </div>
            <div>
              <div class="sec-label">All Active Loans</div>
              <div id="t-loans-active-list"><!-- js --></div>
              <div style="margin-top:16px">
                <div class="sec-label">Manual Loan Payment</div>
                <div class="card card-sm">
                  <div id="t-loanpay-alert" class="alert"></div>
                  <div class="input-group"><label>Select Loan</label><select id="t-loanpay-select"><!-- js --></select></div>
                  <div class="input-group"><label>Payment Amount ($)</label><input type="number" id="t-loanpay-amt" placeholder="0.00" min="0.01" step="0.01" /></div>
                  <button class="btn btn-outline btn-full" onclick="makeLoanPayment()">Apply Payment →</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- GENERATE ACCOUNT -->
        <div id="tpane-generate" class="tab-pane">
          <div class="sec-label">Generate New Account Credentials</div>
          <div class="card" style="max-width:460px">
            <div id="t-gen-alert" class="alert"></div>
            <div class="input-group"><label>Account Holder Name</label><input type="text" id="t-gen-name" placeholder="Full name" /></div>
            <p style="font-size:12px;color:var(--text3);margin-bottom:16px">All new accounts begin at $0.00. Funds must be deposited via the Create Transaction panel.</p>
            <button class="btn btn-primary btn-full" onclick="generateAccount()">Generate Credentials →</button>
            <div id="t-gen-result" style="display:none;margin-top:20px">
              <hr class="sep">
              <div class="sec-label">Generated Credentials — Share Securely</div>
              <div class="code-box" style="margin-bottom:10px">Account: <span id="t-gen-num"></span></div>
              <div class="code-box">PIN: <span id="t-gen-pin"></span></div>
              <div style="font-size:11px;color:var(--text3);margin-top:10px">⚠ Provide credentials securely. Record confirmed in system.</div>
            </div>
          </div>
        </div>

        <!-- SUPPORT CHATS -->
        <div id="tpane-chats" class="tab-pane">

          <!-- Filter + search bar -->
          <div class="support-filter-bar">
            <input class="sfb-search" id="t-chat-search" placeholder="Search by name, account, chat ID…" oninput="renderTellerChats()" />
            <button class="sfb-btn active" id="sfb-all"       onclick="setChatFilter('all')">All</button>
            <button class="sfb-btn"        id="sfb-active"    onclick="setChatFilter('active')">🟢 Active</button>
            <button class="sfb-btn"        id="sfb-awaiting"  onclick="setChatFilter('awaiting')">🟡 Awaiting</button>
            <button class="sfb-btn"        id="sfb-resolved"  onclick="setChatFilter('resolved')">🔵 Resolved</button>
            <button class="sfb-btn"        id="sfb-closed"    onclick="setChatFilter('closed')">⬜ Closed</button>
            <button class="sfb-btn"        id="sfb-archived"  onclick="setChatFilter('archived')">🗄 Archived</button>
          </div>

          <!-- Two-column chat list -->
          <div class="g2" style="margin-bottom:20px" id="t-chat-lists-grid">
            <div>
              <div class="sec-label" style="display:flex;align-items:center;gap:8px">
                <span class="pub-channel-tag account" style="margin-bottom:0">Account Assistance</span>
                <span id="t-acc-chat-count" style="color:var(--text3);font-size:10px"></span>
              </div>
              <div id="t-chat-list"></div>
            </div>
            <div>
              <div class="sec-label" style="display:flex;align-items:center;gap:8px">
                <span class="pub-channel-tag public" style="margin-bottom:0">General Support</span>
                <span id="t-pub-chat-count" style="color:var(--text3);font-size:10px"></span>
              </div>
              <div id="t-pub-chat-list"></div>
            </div>
          </div>

          <!-- Expanded chat panel -->
          <div id="t-chat-panel" style="display:none;margin-top:4px">
            <!-- Header row -->
            <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;gap:12px;flex-wrap:wrap">
              <div style="display:flex;align-items:center;gap:10px">
                <span id="t-chat-channel-badge" class="teller-chat-channel-badge tcc-account">Account</span>
                <div>
                  <div style="font-size:14px;font-weight:600" id="t-chat-viewing-name">—</div>
                  <div style="font-size:11px;color:var(--text3);font-family:'IBM Plex Mono',monospace" id="t-chat-viewing-acc">—</div>
                  <div style="display:flex;align-items:center;gap:8px;margin-top:4px">
                    <span id="t-chat-status-badge" class="chat-status-badge cs-active">Active</span>
                    <span id="t-chat-id-display" class="cli-id"></span>
                    <span id="t-chat-opened-at" class="cli-ts"></span>
                  </div>
                </div>
              </div>
              <!-- Lifecycle action buttons -->
              <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
                <button class="btn btn-ghost btn-sm" id="t-btn-set-awaiting"  onclick="tellerSetStatus('awaiting')"  title="Mark Awaiting Response">⏳ Awaiting</button>
                <button class="btn btn-ghost btn-sm" id="t-btn-set-resolved"  onclick="tellerSetStatus('resolved')"  title="Mark Resolved">✓ Resolve</button>
                <button class="btn btn-amber btn-sm" id="t-btn-close-chat"    onclick="openCloseChatModal()"          title="Close Conversation">✕ Close Chat</button>
                <button class="btn btn-ghost btn-sm" id="t-btn-archive-chat"  onclick="openArchiveChatModal()"        title="Archive Conversation" style="color:var(--text3)">🗄 Archive</button>
                <button class="btn btn-danger btn-sm" id="t-btn-delete-chat"  onclick="openDeleteChatModal()"         title="Permanently Delete">🗑 Delete</button>
                <button class="btn btn-ghost btn-sm" onclick="closeTellerChat()">← Back</button>
              </div>
            </div>

            <!-- Public channel notice -->
            <div id="t-chat-restrict-notice" class="alert alert-info" style="display:none;font-size:12px">
              ⚠ <strong>Public channel</strong> — Do not reveal account balances or private banking data. If a visitor asks about account-specific information, respond: <em>"For account-specific assistance, please log in securely."</em>
            </div>

            <!-- Chat closed notice (shown when status = closed) -->
            <div id="t-chat-closed-banner" class="alert alert-warning" style="display:none;font-size:12px">
              🔒 This conversation is <strong>Closed</strong>. Replies are still possible from the teller side. To reopen, change the status.
            </div>

            <!-- Chat window -->
            <div class="chat-win">
              <div class="chat-msgs" id="t-chat-msgs"></div>
              <div class="chat-iaw" id="t-chat-iaw">
                <div class="chat-closed-notice">This conversation has been closed by the support team.</div>
                <div class="chat-input-row">
                  <input class="chat-input" id="t-chat-input" placeholder="Reply as Support..." onkeydown="if(event.key==='Enter')sendTellerMsg()" />
                  <button class="btn btn-primary btn-sm" onclick="sendTellerMsg()">Reply</button>
                </div>
              </div>
            </div>

            <!-- Closed-at / archived-at timestamps -->
            <div id="t-chat-lifecycle-footer" style="margin-top:8px;font-size:11px;color:var(--text3);display:none"></div>
          </div>

        </div>

        <!-- AI CONTROL CENTER -->
        <div id="tpane-ai-control" class="tab-pane">
          <!-- Stats row -->
          <div class="ai-control-grid" style="margin-bottom:20px">
            <div class="ai-stat-card">
              <div class="ai-stat-val" id="ai-stat-answered">0</div>
              <div class="ai-stat-lbl">Questions Answered</div>
            </div>
            <div class="ai-stat-card">
              <div class="ai-stat-val" id="ai-stat-escalated">0</div>
              <div class="ai-stat-lbl">Escalations</div>
            </div>
            <div class="ai-stat-card">
              <div class="ai-stat-val" id="ai-stat-unmatched">0</div>
              <div class="ai-stat-lbl">Unmatched Queries</div>
            </div>
            <div class="ai-stat-card">
              <div class="ai-stat-val" id="ai-stat-rate">—</div>
              <div class="ai-stat-lbl">Escalation Rate</div>
            </div>
            <div class="ai-stat-card">
              <div class="ai-stat-val" id="ai-stat-faqs">0</div>
              <div class="ai-stat-lbl">Total FAQ Entries</div>
            </div>
            <div class="ai-stat-card">
              <div class="ai-stat-val" id="ai-stat-avgms">—</div>
              <div class="ai-stat-lbl">Avg Response Time</div>
            </div>
          </div>

          <div class="g2">
            <!-- LEFT: Settings + Knowledge Base -->
            <div>
              <div class="sec-label">AI Settings</div>
              <div class="card card-sm" style="margin-bottom:16px">
                <div class="ai-toggle-row">
                  <div>
                    <div class="ai-toggle-label">AI Assistant</div>
                    <div class="ai-toggle-sub">Enable or disable the AI first-response layer across all chats</div>
                  </div>
                  <label class="ai-toggle">
                    <input type="checkbox" id="ai-master-toggle" onchange="setAiEnabled(this.checked)" checked />
                    <div class="ai-toggle-track"></div>
                    <div class="ai-toggle-thumb"></div>
                  </label>
                </div>
                <div class="ai-toggle-row" style="margin-top:12px">
                  <div>
                    <div class="ai-toggle-label">Auto-Escalation Sensitivity</div>
                    <div class="ai-toggle-sub">How aggressively the AI escalates ambiguous questions</div>
                  </div>
                </div>
                <div class="ai-sensitivity-row">
                  <span style="font-size:11px;color:var(--text3)">Low</span>
                  <input type="range" min="1" max="3" step="1" id="ai-sensitivity" value="2" oninput="setAiSensitivity(this.value)" />
                  <span style="font-size:11px;color:var(--text3)">High</span>
                  <span id="ai-sensitivity-label" style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--green2);min-width:60px">Medium</span>
                </div>
              </div>

              <div class="sec-label" style="margin-top:20px">Notification &amp; Alert Settings</div>
              <div class="card card-sm" style="margin-bottom:16px">
                <!-- Toggles -->
                <div class="ai-toggle-row">
                  <div><div class="ai-toggle-label">Sound Alerts</div><div class="ai-toggle-sub">Play audio when escalations and failures occur</div></div>
                  <label class="ai-toggle"><input type="checkbox" id="notif-sound-toggle" onchange="setNotifPref('soundEnabled',this.checked)" checked /><div class="ai-toggle-track"></div><div class="ai-toggle-thumb"></div></label>
                </div>
                <div class="ai-toggle-row" style="margin-top:10px">
                  <div><div class="ai-toggle-label">Critical Alerts Only</div><div class="ai-toggle-sub">Level 3 critical only — suppress Level 1 &amp; 2</div></div>
                  <label class="ai-toggle"><input type="checkbox" id="notif-critical-toggle" onchange="setNotifPref('criticalOnly',this.checked)" /><div class="ai-toggle-track"></div><div class="ai-toggle-thumb"></div></label>
                </div>
                <div class="ai-toggle-row" style="margin-top:10px">
                  <div><div class="ai-toggle-label">Mute All</div><div class="ai-toggle-sub">Silence everything temporarily</div></div>
                  <label class="ai-toggle"><input type="checkbox" id="notif-mute-toggle" onchange="setNotifPref('muted',this.checked)" /><div class="ai-toggle-track"></div><div class="ai-toggle-thumb"></div></label>
                </div>
                <!-- Volume -->
                <div style="margin-top:14px">
                  <div style="font-size:11px;color:var(--text3);margin-bottom:6px">Alert Volume: <span id="notif-vol-label">70%</span></div>
                  <input type="range" min="0" max="100" value="70" id="notif-volume" oninput="setNotifVolume(this.value)" style="width:100%" />
                </div>
                <!-- Thresholds -->
                <div style="margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
                  <div>
                    <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Reminder Threshold (min)</div>
                    <input type="number" id="notif-thresh1" value="3" min="1" max="60" style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:6px 8px;color:var(--text);font-size:12px" onchange="setNotifThreshold(1,this.value)" />
                  </div>
                  <div>
                    <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Critical Threshold (min)</div>
                    <input type="number" id="notif-thresh2" value="8" min="2" max="120" style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:6px 8px;color:var(--text);font-size:12px" onchange="setNotifThreshold(2,this.value)" />
                  </div>
                </div>
                <!-- 3 individual test buttons -->
                <div style="margin-top:14px">
                  <div style="font-size:11px;color:var(--text3);margin-bottom:8px;font-weight:600;letter-spacing:.06em">TEST SOUNDS</div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <button class="btn btn-ghost btn-sm notif-test-btn" onclick="testAlertSafe(1)" style="border-color:rgba(61,220,132,.3);color:var(--green2)">
                      🟢 Level 1 — Info
                    </button>
                    <button class="btn btn-ghost btn-sm notif-test-btn" onclick="testAlertSafe(2)" style="border-color:rgba(255,179,71,.3);color:var(--amber)">
                      🟡 Level 2 — Warning
                    </button>
                    <button class="btn btn-ghost btn-sm notif-test-btn" onclick="testAlertSafe(3)" style="border-color:rgba(255,77,77,.3);color:var(--red)">
                      🔴 Level 3 — Critical
                    </button>
                  </div>
                  <div style="font-size:10px;color:var(--text3);margin-top:6px">Tests play at current volume. No system events triggered.</div>
                </div>
              </div>

              <div class="sec-label">Knowledge Base — FAQ Entries</div>
              <div class="card card-sm" style="margin-bottom:8px">
                <div style="font-size:12px;color:var(--text2);margin-bottom:12px">Teller-defined FAQs override all built-in AI responses. Match priority: exact phrase → multi-keyword → partial.</div>
                <div id="ai-faq-add-alert" class="alert"></div>
                <div class="input-group"><label>FAQ Title</label><input type="text" id="ai-faq-title" placeholder="e.g. Wire Transfer Policy" /></div>
                <div class="input-group"><label>Keywords <span style="font-size:10px;color:var(--text3)">(comma-separated trigger phrases)</span></label><input type="text" id="ai-faq-keywords" placeholder="wire transfer, wire, international transfer" /></div>
                <div class="input-group"><label>Official Response</label><textarea id="ai-faq-answer" rows="3" placeholder="The official policy response..." style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px;color:var(--text);font-size:12px;font-family:'Syne',sans-serif;resize:vertical"></textarea></div>
                <div class="g2">
                  <div class="input-group"><label>Category</label>
                    <select id="ai-faq-cat">
                      <option value="general">General</option>
                      <option value="deposit">Deposits</option>
                      <option value="withdrawal">Withdrawals</option>
                      <option value="loans">Loans</option>
                      <option value="recurring">Recurring Payments</option>
                      <option value="security">Security</option>
                      <option value="account">Account</option>
                      <option value="policy">Policy</option>
                    </select>
                  </div>
                  <div class="input-group"><label>Requires Human Escalation</label>
                    <select id="ai-faq-escalate">
                      <option value="no">No — AI answers fully</option>
                      <option value="yes">Yes — connect to agent</option>
                    </select>
                  </div>
                </div>
                <button class="btn btn-outline btn-full" onclick="addFaqEntry()">Add to Knowledge Base →</button>
              </div>

              <div id="ai-faq-list-wrap"><!-- rendered by JS --></div>
            </div>

            <!-- RIGHT: Logs + Unmatched -->
            <div>
              <div class="sec-label">Most Triggered FAQ</div>
              <div class="card card-sm" id="ai-top-faq" style="margin-bottom:16px">
                <div style="font-size:12px;color:var(--text3)">No data yet.</div>
              </div>

              <div class="sec-label">Unmatched Questions</div>
              <div class="card card-sm" id="ai-unmatched-log" style="max-height:220px;overflow-y:auto;margin-bottom:16px">
                <div style="font-size:12px;color:var(--text3)">None recorded.</div>
              </div>

              <div class="sec-label">Recent AI Conversations</div>
              <div class="card card-sm" style="max-height:360px;overflow-y:auto" id="ai-conv-log">
                <div style="font-size:12px;color:var(--text3)">No conversations logged.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- AUDIT LOG -->
        <div id="tpane-audit" class="tab-pane">
          <div class="sec-label">System Audit Log</div>
          <div class="card card-sm" id="t-audit-list"><!-- js --></div>
        </div>

        <!-- LOGIN ATTEMPTS -->
        <div id="tpane-logins" class="tab-pane">
          <div class="sec-label">Login Attempt Log</div>
          <div class="card card-sm" id="t-login-list"><!-- js --></div>
        </div>

      </div><!-- dash-scroll -->
    </div><!-- dash-main -->
  </div>
</div>

<!-- DEPOSIT MODAL (used as info popup from nav) -->
<div class="modal-overlay" id="modal-deposit-info">
  <div class="modal">
    <button class="modal-close" onclick="closeMod('modal-deposit-info')">×</button>
    <div class="modal-title">Deposit Information</div>
    <div class="deposit-info-box">
      <strong>Deposits are teller-controlled only.</strong>
      <p style="margin-top:10px">To make a deposit, please visit a <strong>Clover Financial branch</strong> or contact the <strong>official Discord banking channel</strong>. An authorized teller must process all deposits through the admin panel.</p>
      <p style="margin-top:10px;font-size:12px;color:var(--text3)">This ensures the money supply remains controlled, auditable, and fraud-free.</p>
    </div>
    <div style="margin-top:16px"><button class="btn btn-ghost btn-full" onclick="closeMod('modal-deposit-info')">Understood</button></div>
  </div>
</div>

<!-- CLOSE CHAT MODAL -->
<div class="modal-overlay" id="modal-close-chat">
  <div class="modal" style="max-width:440px">
    <button class="modal-close" onclick="closeMod('modal-close-chat')">×</button>
    <div class="modal-title">Close Conversation</div>
    <p style="font-size:13px;color:var(--text2);margin-bottom:18px">Set this conversation status to <strong style="color:var(--text)">Closed</strong>. The customer will no longer be able to send messages, but the full transcript will remain accessible.</p>
    <div class="input-group">
      <label>Closure Reason (optional)</label>
      <select id="modal-close-reason">
        <option value="Resolved">Resolved — issue addressed</option>
        <option value="No response">No response — visitor inactive</option>
        <option value="Escalated">Escalated — referred to branch</option>
        <option value="Duplicate">Duplicate — existing ticket</option>
        <option value="Out of scope">Out of scope — redirect required</option>
        <option value="Admin closure">Admin closure</option>
      </select>
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost btn-full" onclick="closeMod('modal-close-chat')">Cancel</button>
      <button class="btn btn-amber btn-full" onclick="confirmCloseChat()">Close Conversation</button>
    </div>
  </div>
</div>

<!-- ARCHIVE CHAT MODAL -->
<div class="modal-overlay" id="modal-archive-chat">
  <div class="modal" style="max-width:440px">
    <button class="modal-close" onclick="closeMod('modal-archive-chat')">×</button>
    <div class="modal-title">Archive Conversation</div>
    <p style="font-size:13px;color:var(--text2);margin-bottom:18px">Move this conversation to the <strong style="color:var(--text)">Archive</strong>. It will be removed from the active view but retained in full with all timestamps and message history.</p>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost btn-full" onclick="closeMod('modal-archive-chat')">Cancel</button>
      <button class="btn btn-ghost btn-full" onclick="confirmArchiveChat()" style="color:var(--text2);border-color:var(--border2)">Archive Conversation</button>
    </div>
  </div>
</div>

<!-- DELETE CHAT MODAL -->
<div class="modal-overlay" id="modal-delete-chat">
  <div class="modal" style="max-width:440px">
    <button class="modal-close" onclick="closeMod('modal-delete-chat')">×</button>
    <div class="modal-title" style="color:var(--red)">Permanently Delete Chat</div>
    <div class="del-modal-warn">
      <strong>⚠ This action cannot be undone.</strong><br>
      All messages, timestamps, and metadata will be permanently removed. A deletion record will be written to the system audit log.
    </div>
    <p style="font-size:13px;color:var(--text2);margin-bottom:18px">Type <strong style="color:var(--text);font-family:'IBM Plex Mono',monospace">DELETE</strong> to confirm.</p>
    <div class="input-group" style="margin-bottom:18px">
      <input type="text" id="delete-confirm-input" placeholder="Type DELETE to confirm" autocomplete="off" />
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost btn-full" onclick="closeMod('modal-delete-chat')">Cancel</button>
      <button class="btn btn-danger btn-full" onclick="confirmDeleteChat()">Permanently Delete</button>
    </div>
  </div>
</div>

<script>
// ================================================================
// DATA STORE
// ================================================================
const DB = {
  accounts: {
    100001: {
      name: "Alex Morgan",
      pin: "01234",
      checking: 0,
      savings: 0,
      frozen: false,
      flagged: false,
      creditTier: "—",
      transactions: [],
      loans: [],
      // Account support chat — lifecycle fields added
      chat: [
        { from:'ai', text:'Welcome to Clover Financial Support. I\'m the Clover AI Assistant. How can I assist you today?', time: ts() }
      ],
      chatStatus: 'active',
      chatAiEscalated: false,      // active | awaiting | resolved | closed | archived
      chatId: 'ACC-100001-001',
      chatOpenedAt: ts(),
      chatClosedAt: null,
      chatArchivedAt: null,
      chatClosureReason: null,
      failedLogins: 0,
      loginLocked: false
    }
  },
  // Public / general support conversations (no account tied)
  publicChats: [
    {
      id: 'PUB-001',
      label: 'General Support',
      status: 'active',          // active | awaiting | resolved | closed | archived
      openedAt: ts(),
      closedAt: null,
      archivedAt: null,
      closureReason: null,
      messages: [
        { from:'ai', text:'Welcome to Clover Financial Support. I\'m the Clover AI Assistant. How can I assist you today?', time: ts() }
      ],
      aiEscalated: false
    }
  ],
  recurringPayments: [],
  auditLog: [],
  loginLog: [],
  nextAccId: 100002,
  nextTxId: 1000,
  nextLoanId: 1,
  nextRecurId: 1,
  notifications: {
    soundEnabled: true,
    backgroundNotif: false,
    criticalOnly: false,
    muted: false,
    volume: 0.7,
    escalationThreshold1: 3,   // minutes — level 2 reminder
    escalationThreshold2: 8,   // minutes — level 3 critical
    alertedEscalations: {},    // key: chatId+level → ts of last alert
    lastRecurRun: 0            // ts of last scheduler check
  },
  nextChatId: 2,   // for new public chats
  teller: { failedAttempts: 0, locked: false },
  // AI Support Control
  ai: {
    enabled: true,
    escalationSensitivity: 2, // 1=low 2=medium 3=high
    // Rich FAQ entries
    faqs: [],      // [{id,title,keywords:[],response,category,escalationRequired,active}]
    conversationLogs: [],
    unmatchedQuestions: [],
    stats: {
      totalAnswered: 0,
      totalEscalated: 0,
      totalUnmatched: 0,
      responseTimes: [],
      categoryHits: {}
    },
    nextFaqId: 1
  }
};

let currentAcc = null; // active customer account key
let tellerViewingAccKey = null; // for teller chat

// ================================================================
// UTILITIES
// ================================================================
function fmt(n){ return Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function ts(){ return new Date().toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'}); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function al(id,type,msg){ const e=document.getElementById(id); if(!e) return; e.className=`alert alert-${type} show`; e.textContent=msg; }
function clal(id){ const e=document.getElementById(id); if(e){e.className='alert';e.textContent='';} }
function showAl(el,type,msg){ el.className=`alert alert-${type} show`; el.textContent=msg; }
function clAl(el){ el.className='alert'; el.textContent=''; }

function addAudit(action, actor){
  DB.auditLog.unshift({ time: ts(), action, actor: actor||'System' });
}
function addLoginLog(acc, success){
  DB.loginLog.unshift({ time: ts(), acc, success });
}
function addTx(accKey, desc, amount, target, icon, category, note){
  DB.nextTxId++;
  DB.accounts[accKey].transactions.push({
    id: DB.nextTxId, date: ts(), desc, amount,
    type: amount >= 0 ? 'credit' : 'debit',
    target: target||'checking', icon: icon||'💳',
    category: category||'Transaction', note: note||''
  });
}

// ================================================================
// PAGE ROUTING
// ================================================================
function showPage(id){
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const target = document.getElementById(id);
  if(!target){ console.warn('[Clover] showPage: element not found:', id); return; }
  target.classList.add('active');
  if(id==='page-dashboard') renderCust();
  if(id==='page-teller') renderTeller();
  if(id==='page-landing'){ updateLandingStats(); renderAgentStatus(); }
  if(id==='page-public-support') renderPublicSupportPage();
}
function landScroll(id){ const e=document.getElementById(id); if(e) e.scrollIntoView({behavior:'smooth'}); }
function setNavActive(activeId){
  ['nav-home','nav-services','nav-about','nav-support'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.classList.toggle('active', id===activeId);
  });
}
function closeMod(id){ document.getElementById(id).classList.remove('show'); }
function doLogout(){
  addAudit(`Customer logout — Account ${currentAcc}`, 'Account '+currentAcc);
  currentAcc = null;
  showPage('page-landing');
}

// ================================================================
// CUSTOMER LOGIN
// ================================================================
function doLogin(){
  const acc = document.getElementById('l-acc').value.trim();
  const pin = document.getElementById('l-pin').value.trim();
  const a = DB.accounts[acc];
  if(!a){ al('login-alert','error','Account not found.'); addLoginLog(acc,false); return; }
  if(a.loginLocked){ document.getElementById('login-form').style.display='none'; document.getElementById('login-locked').style.display='block'; return; }
  if(a.pin !== pin){
    a.failedLogins++;
    addLoginLog(acc,false);
    addAudit(`Failed login attempt on Account ${acc} (attempt ${a.failedLogins})`, 'Security');
    if(a.failedLogins >= 3){
      a.loginLocked = true;
      addAudit(`Account ${acc} login-locked after 3 failed attempts`, 'Security');
      document.getElementById('login-form').style.display='none';
      document.getElementById('login-locked').style.display='block';
    } else {
      al('login-alert','error',`Incorrect PIN. ${3-a.failedLogins} attempt(s) remaining.`);
    }
    return;
  }
  a.failedLogins = 0;
  clal('login-alert');
  addLoginLog(acc,true);
  addAudit(`Successful login — Account ${acc}`, 'Account '+acc);
  currentAcc = acc;
  document.getElementById('l-acc').value='';
  document.getElementById('l-pin').value='';
  showPage('page-dashboard');
}
function resetLoginLock(){
  const acc = document.getElementById('l-acc').value.trim();
  if(DB.accounts[acc]){ DB.accounts[acc].loginLocked=false; DB.accounts[acc].failedLogins=0; }
  document.getElementById('login-form').style.display='';
  document.getElementById('login-locked').style.display='none';
}

// ================================================================
// TELLER LOGIN
// ================================================================
function doTellerLogin(){
  const code = document.getElementById('t-code').value.trim();
  if(DB.teller.locked){ document.getElementById('teller-form').style.display='none'; document.getElementById('teller-locked').style.display='block'; return; }
  if(code !== '5897'){
    DB.teller.failedAttempts++;
    addAudit(`Failed teller auth (attempt ${DB.teller.failedAttempts})`, 'Teller Terminal');
    if(DB.teller.failedAttempts >= 3){
      DB.teller.locked = true;
      addAudit('Teller terminal locked — repeated auth failures', 'Security');
      document.getElementById('teller-form').style.display='none';
      document.getElementById('teller-locked').style.display='block';
    } else {
      al('teller-alert','error',`Invalid code. ${3-DB.teller.failedAttempts} attempt(s) remaining.`);
    }
    return;
  }
  DB.teller.failedAttempts = 0;
  clal('teller-alert');
  document.getElementById('t-code').value='';
  addAudit('Teller session authenticated', 'Teller Terminal');
  showPage('page-teller');
}
function resetTellerLock(){
  DB.teller.locked=false; DB.teller.failedAttempts=0;
  document.getElementById('teller-form').style.display='';
  document.getElementById('teller-locked').style.display='none';
}

// ================================================================
// CUSTOMER DASHBOARD RENDER
// ================================================================
function renderCust(){
  if(!currentAcc) return;
  const a = DB.accounts[currentAcc];

  document.getElementById('sd-name').textContent = a.name;
  document.getElementById('sd-acc').textContent = 'ACC · ' + currentAcc;

  // Badges
  document.getElementById('c-frozen-badge').style.display = a.frozen ? '' : 'none';
  document.getElementById('c-flagged-badge').style.display = a.flagged ? '' : 'none';
  document.getElementById('c-frozen-bar').classList.toggle('show', a.frozen);

  // Balance cards
  const loans = DB.recurringPayments.filter(r => r.accKey == currentAcc);
  const activeLoansList = a.loans.filter(l => l.remaining > 0);
  const totalLoanBal = activeLoansList.reduce((s,l)=>s+l.remaining,0);

  let bcHTML = `
    <div class="bal-card checking">
      <div class="bc-label">Checking</div>
      <div class="bc-amount">$${fmt(a.checking)}</div>
      <div class="bc-sub">Primary account</div>
    </div>
    <div class="bal-card savings">
      <div class="bc-label">Savings</div>
      <div class="bc-amount" style="color:var(--blue)">$${fmt(a.savings)}</div>
      <div class="bc-sub">Savings account</div>
    </div>`;
  if(activeLoansList.length > 0){
    bcHTML += `<div class="bal-card loan">
      <div class="bc-label">Loan Balance</div>
      <div class="bc-amount amber">$${fmt(totalLoanBal)}</div>
      <div class="bc-sub">${activeLoansList.length} active loan(s)</div>
    </div>`;
  }
  document.getElementById('c-bal-cards').innerHTML = bcHTML;

  // Status
  let sbd = document.getElementById('c-standing-badge');
  if(a.frozen){ sbd.className='badge b-red'; sbd.textContent='Frozen'; }
  else if(a.flagged){ sbd.className='badge b-amber'; sbd.textContent='Flagged'; }
  else { sbd.className='badge b-green'; sbd.textContent='Good Standing'; }
  document.getElementById('c-credit-badge').textContent = a.creditTier||'—';
  document.getElementById('c-loan-count').textContent = activeLoansList.length;
  document.getElementById('c-recur-count').textContent = DB.recurringPayments.filter(r=>r.accKey==currentAcc).length;

  // Recent tx
  const recentTx = [...a.transactions].reverse().slice(0,6);
  document.getElementById('c-recent-tx').innerHTML = renderTxRows(recentTx, true);

  // Full tx
  document.getElementById('c-full-tx').innerHTML = renderTxRows([...a.transactions].reverse(), false);

  // Loan summary
  let lsHTML = activeLoansList.length === 0 ? '<div style="color:var(--text3);font-size:12px">No active loans.</div>' :
    activeLoansList.map(l => `
      <div style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
          <span style="font-weight:600">${esc(l.name)}</span>
          <span class="mono" style="color:var(--amber)">$${fmt(l.remaining)}</span>
        </div>
        <div style="font-size:11px;color:var(--text3)">$${fmt(l.monthly)}/mo · ${l.rate}% APR</div>
        <div class="prog-wrap"><div class="prog-fill prog-amber" style="width:${Math.min(100,((l.principal-l.remaining)/l.principal*100)).toFixed(1)}%"></div></div>
      </div>
    `).join('');
  document.getElementById('c-loan-summary').innerHTML = lsHTML;

  // Loans pane
  document.getElementById('c-loans-list').innerHTML = activeLoansList.length === 0
    ? '<div class="card card-sm" style="color:var(--text3);font-size:12px">No active loans.</div>'
    : activeLoansList.map(l => `
        <div class="card card-sm" style="margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;margin-bottom:10px">
            <div><div style="font-size:14px;font-weight:600">${esc(l.name)}</div><div style="font-size:11px;color:var(--text3)">Rate: ${l.rate}% APR · Payment: $${fmt(l.monthly)}/mo</div></div>
            <div style="text-align:right"><div class="mono" style="font-size:18px;color:var(--amber)">$${fmt(l.remaining)}</div><div style="font-size:11px;color:var(--text3)">remaining</div></div>
          </div>
          <div style="font-size:11px;color:var(--text2)">Original: $${fmt(l.principal)} · Paid: $${fmt(l.principal-l.remaining)}</div>
          <div class="prog-wrap"><div class="prog-fill prog-amber" style="width:${Math.min(100,((l.principal-l.remaining)/l.principal*100)).toFixed(1)}%"></div></div>
        </div>`).join('');

  // Loan tx history
  const loanTxs = a.transactions.filter(t=>t.category==='Loan Payment').reverse();
  document.getElementById('c-loan-tx').innerHTML = loanTxs.length===0
    ? '<div style="color:var(--text3);font-size:12px">No loan payment history.</div>'
    : renderTxRows(loanTxs, false);

  // Recurring payments panel
  renderCustRecurring();

  // Chat
  renderCustChat();
}

function renderTxRows(txs, compact){
  if(txs.length===0) return '<div style="color:var(--text3);font-size:12px;padding:8px 0">No transactions yet.</div>';
  return txs.map(tx=>`
    <div class="tx-row">
      <div class="tx-left">
        <div class="tx-ic">${tx.icon||'💳'}</div>
        <div>
          <div class="tx-desc">${esc(tx.desc)}</div>
          <div class="tx-meta">${tx.date}${tx.note?' · '+esc(tx.note):''}</div>
          ${!compact ? `<div class="tx-meta" style="color:var(--text3)">${tx.category} · ${tx.target}</div>`:''}
        </div>
      </div>
      <div>
        <div class="tx-amt ${tx.type==='credit'?'cr':'dr'}">${tx.amount>0?'+':''}$${fmt(Math.abs(tx.amount))}</div>
        <div class="tx-cat">${tx.type==='credit'?'Credit':'Debit'}</div>
      </div>
    </div>
  `).join('');
}

// ================================================================
// CUSTOMER ACTIONS
// ================================================================
function doWithdraw(){
  const a = DB.accounts[currentAcc];
  const from = document.getElementById('c-wd-from').value;
  const method = document.getElementById('c-wd-method').value;
  const amt = parseFloat(document.getElementById('c-wd-amt').value);
  const note = document.getElementById('c-wd-note').value.trim();
  const alertEl = document.getElementById('c-wd-alert');

  if(!amt || amt <= 0){ showAl(alertEl,'error','Enter a valid amount.'); return; }
  if(a.frozen){ showAl(alertEl,'error','Account is frozen. Withdrawals are not permitted.'); return; }
  if(a.flagged && amt > 2000){ showAl(alertEl,'error','Account flagged. Withdrawals over $2,000 are restricted.'); return; }
  if(a[from] < amt){ showAl(alertEl,'error',`Insufficient ${from} balance. Available: $${fmt(a[from])}`); return; }

  a[from] = +(a[from] - amt).toFixed(2);
  addTx(currentAcc, method, -amt, from, '🏧', 'Withdrawal', note);
  addAudit(`Withdrawal $${fmt(amt)} from ${from} via ${method} — Account ${currentAcc}`, 'Account '+currentAcc);
  showAl(alertEl,'success',`$${fmt(amt)} withdrawn from ${from}.`);
  document.getElementById('c-wd-amt').value='';
  document.getElementById('c-wd-note').value='';
  checkFraud(currentAcc, amt);
  renderCust();
}

function doTransferSavings(){
  const a = DB.accounts[currentAcc];
  const amt = parseFloat(document.getElementById('c-tr-amt').value);
  const alertEl = document.getElementById('c-tr-alert');

  if(!amt || amt <= 0){ showAl(alertEl,'error','Enter a valid amount.'); return; }
  if(a.frozen){ showAl(alertEl,'error','Account is frozen.'); return; }
  if(a.checking < amt){ showAl(alertEl,'error',`Insufficient checking balance. Available: $${fmt(a.checking)}`); return; }

  a.checking = +(a.checking - amt).toFixed(2);
  a.savings = +(a.savings + amt).toFixed(2);
  addTx(currentAcc, 'Transfer to Savings', -amt, 'checking', '⇄', 'Transfer', '');
  addTx(currentAcc, 'Transfer from Checking', +amt, 'savings', '⇄', 'Transfer', '');
  addAudit(`Transfer $${fmt(amt)} checking→savings — Account ${currentAcc}`, 'Account '+currentAcc);
  showAl(alertEl,'success',`$${fmt(amt)} transferred to savings.`);
  document.getElementById('c-tr-amt').value='';
  renderCust();
}

function checkFraud(accKey, amt){
  const a = DB.accounts[accKey];
  if(amt > 1000){
    const recent = a.transactions.filter(t => t.category==='Withdrawal' && Math.abs(t.amount)>1000);
    if(recent.length >= 3 && !a.flagged){
      a.flagged = true;
      addAudit(`🚨 Auto-flag: 3+ large withdrawals detected — Account ${accKey}`, 'Fraud System');
    }
  }
}

// ================================================================
// CUSTOMER CHAT
// ================================================================
function renderCustChat(){
  if(!currentAcc) return;
  const a = DB.accounts[currentAcc];
  const msgs = a.chat;
  const container = document.getElementById('c-chat-msgs');
  if(!container) return;
  const lbl = document.getElementById('c-support-acc-label');
  if(lbl) lbl.textContent = `${a.name} · ACC ${currentAcc}`;
  let bannerHtml = a.chatAiEscalated
    ? '<div class="ai-escalation-banner">⚡ <span><strong>Escalated to Human Agent</strong> — A teller will join this conversation shortly.</span></div>'
    : '';
  container.innerHTML = bannerHtml + msgs.map(m => renderMsgBubble(m)).join('');
  container.scrollTop = container.scrollHeight;
  updateCustAccChatStatusUi(currentAcc);
  // Update AI chip
  const accAiChip2 = document.getElementById('c-acc-ai-chip');
  if(accAiChip2) {
    if(!DB.ai.enabled){ accAiChip2.textContent='AI Disabled'; accAiChip2.className='ai-status-chip disabled'; }
    else if(a.chatAiEscalated){ accAiChip2.textContent='Escalated'; accAiChip2.className='ai-status-chip escalated'; }
    else { accAiChip2.textContent='AI Active'; accAiChip2.className='ai-status-chip'; }
  }
}
function sendCustMsg(){
  if(!currentAcc) return;
  const a = DB.accounts[currentAcc];
  if(a.chatStatus==='closed'||a.chatStatus==='archived') return;
  const inp = document.getElementById('c-chat-input');
  const text = inp.value.trim();
  if(!text) return;
  a.chat.push({ from:'customer', text, time: ts() });
  if(a.chatStatus==='active') a.chatStatus='awaiting';
  inp.value = '';
  renderCustChat();
  renderTellerChats();
  addAudit(`Account ${currentAcc} support message [${a.chatId}]`, 'Account '+currentAcc);

  if(!a.chatAiEscalated && DB.ai.enabled) {
    const container = document.getElementById('c-chat-msgs');
    const aiResp = aiRespond(text, 'account', { isLoggedIn:true, accKey:currentAcc });
    if(aiResp) {
      _deliverAiReply(container, aiResp, (resp) => {
        const msg = {from:'ai', text:resp.text, time:ts(), quickBtns:resp.quickBtns, _channel:'account', _key:currentAcc};
        a.chat.push(msg);
        if(resp.escalate) {
          aiUserEscalate('account', currentAcc);
        } else {
          if(a.chatStatus==='awaiting') a.chatStatus='active';
        }
        renderCustChat();
        if(tellerViewingAccKey===currentAcc) openTellerChat(currentAcc);
        renderTellerChats();
      });
    }
  } else {
    document.getElementById('t-notif').style.display = '';
  }
}

// ================================================================
// CUSTOMER TABS
// ================================================================
function cTab(name, btn){
  document.querySelectorAll('#page-dashboard .tab-pane').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('#page-dashboard .snav-item').forEach(b=>b.classList.remove('active'));
  const cpane = document.getElementById('cpane-'+name);
  if(cpane) cpane.classList.add('active'); else console.warn('[Clover] cTab: pane not found:', name);
  if(btn) btn.classList.add('active');
  const titles={overview:'Account Overview',activity:'Banking Activity',withdraw:'Withdraw Funds',transfer:'Transfer to Savings',deposit:'Deposit Funds',loans:'Loans',recurring:'Recurring Payments',support:'Live Support'};
  document.getElementById('c-topbar-title').textContent = titles[name]||name;
  if(name==='support'){ document.getElementById('sd-notif').style.display='none'; renderCustChat(); }
  if(name==='transfer'){
    const a = DB.accounts[currentAcc];
    document.getElementById('c-tr-balances').innerHTML = `
      <div class="card card-xs" style="flex:1"><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px">Checking</div><div class="mono" style="font-size:14px">$${fmt(a.checking)}</div></div>
      <div class="card card-xs" style="flex:1"><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px">Savings</div><div class="mono" style="font-size:14px;color:var(--blue)">$${fmt(a.savings)}</div></div>
    `;
  }
  renderCust();
}

// ================================================================
// TELLER PANEL RENDER
// ================================================================
function renderTeller(){
  renderTellerSummary();
  renderTellerAccounts();
  populateTellerSelects();
  renderRecurringList();
  renderLoansAdmin();
  renderAuditLog();
  renderLoginLog();
  renderTellerChats();
}

function renderTellerSummary(){
  const accs = Object.values(DB.accounts);
  const totalChecking = accs.reduce((s,a)=>s+a.checking,0);
  const totalSavings = accs.reduce((s,a)=>s+a.savings,0);
  const allLoans = accs.flatMap(a=>a.loans.filter(l=>l.remaining>0));
  const totalLoans = allLoans.reduce((s,l)=>s+l.remaining,0);
  const flaggedCount = accs.filter(a=>a.flagged).length;
  const frozenCount = accs.filter(a=>a.frozen).length;

  document.getElementById('t-sum-grid').innerHTML = `
    <div class="asm-card"><div class="asm-val green">$${fmt(totalChecking+totalSavings)}</div><div class="asm-lbl">Total Money in System</div></div>
    <div class="asm-card"><div class="asm-val green">$${fmt(totalChecking)}</div><div class="asm-lbl">Total in Checking</div></div>
    <div class="asm-card"><div class="asm-val" style="color:var(--blue)">$${fmt(totalSavings)}</div><div class="asm-lbl">Total in Savings</div></div>
    <div class="asm-card"><div class="asm-val amber">$${fmt(totalLoans)}</div><div class="asm-lbl">Total Loans Outstanding</div></div>
    <div class="asm-card"><div class="asm-val red">${flaggedCount}</div><div class="asm-lbl">Flagged Accounts</div></div>
    <div class="asm-card"><div class="asm-val red">${frozenCount}</div><div class="asm-lbl">Frozen Accounts</div></div>
  `;

  // Flagged list
  const flagged = Object.entries(DB.accounts).filter(([,a])=>a.flagged||a.frozen);
  document.getElementById('t-flagged-list').innerHTML = flagged.length===0
    ? '<div style="color:var(--text3);font-size:12px">No flagged or frozen accounts.</div>'
    : flagged.map(([k,a])=>`
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);">
          <div><div style="font-size:13px;font-weight:500">${esc(a.name)}</div><div style="font-size:11px;font-family:'IBM Plex Mono',monospace;color:var(--text3)">${k}</div></div>
          <div style="display:flex;gap:6px">${a.frozen?'<span class="badge b-red">Frozen</span>':''}${a.flagged?'<span class="badge b-amber">Flagged</span>':''}</div>
        </div>`).join('');

  // Recent audit (5)
  const recent5 = DB.auditLog.slice(0,5);
  document.getElementById('t-recent-audit').innerHTML = recent5.length===0
    ? '<div style="color:var(--text3);font-size:12px">No audit events.</div>'
    : recent5.map(e=>`<div class="audit-row"><div class="audit-time">${e.time}</div><div class="audit-action">${esc(e.action)}</div></div>`).join('');
}

function renderTellerAccounts(){
  const html = Object.entries(DB.accounts).map(([k,a])=>`
    <div class="acc-list-row">
      <div class="alr-head">
        <div>
          <div class="alr-name">${esc(a.name)}</div>
          <div class="alr-num">ACC · ${k}</div>
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          ${a.frozen?'<span class="badge b-red">Frozen</span>':'<span class="badge b-green">Active</span>'}
          ${a.flagged?'<span class="badge b-amber">⚠ Flagged</span>':''}
          <span class="badge b-gray">${a.creditTier||'—'}</span>
          <button class="btn btn-ghost btn-sm" onclick="quickEditAcc('${k}')">Edit</button>
          ${a.frozen?`<button class="btn btn-ghost btn-sm" onclick="setFreeze('${k}',false)">Unfreeze</button>`:`<button class="btn btn-amber btn-sm" onclick="setFreeze('${k}',true)">Freeze</button>`}
          ${a.flagged?`<button class="btn btn-ghost btn-sm" onclick="setFlag('${k}',false)">Unflag</button>`:`<button class="btn btn-danger btn-sm" onclick="setFlag('${k}',true)">Flag</button>`}
        </div>
      </div>
      <div class="alr-balances">
        <div class="alr-bal-item"><div class="alr-bal-lbl">Checking</div><div class="alr-bal-val">$${fmt(a.checking)}</div></div>
        <div class="alr-bal-item"><div class="alr-bal-lbl">Savings</div><div class="alr-bal-val">$${fmt(a.savings)}</div></div>
        <div class="alr-bal-item"><div class="alr-bal-lbl">Active Loans</div><div class="alr-bal-val">${a.loans.filter(l=>l.remaining>0).length}</div></div>
        <div class="alr-bal-item"><div class="alr-bal-lbl">Transactions</div><div class="alr-bal-val">${a.transactions.length}</div></div>
      </div>
    </div>
  `).join('');
  document.getElementById('t-acc-list').innerHTML = html;
}

function quickEditAcc(k){
  const a = DB.accounts[k];
  const checking = prompt(`Edit Checking balance for ${a.name} (${k})\nCurrent: $${fmt(a.checking)}\nEnter new amount:`);
  if(checking===null) return;
  const cv = parseFloat(checking);
  if(isNaN(cv)||cv<0){ alert('Invalid amount.'); return; }
  const savings = prompt(`Edit Savings balance for ${a.name} (${k})\nCurrent: $${fmt(a.savings)}\nEnter new amount:`);
  if(savings===null) return;
  const sv = parseFloat(savings);
  if(isNaN(sv)||sv<0){ alert('Invalid amount.'); return; }
  addAudit(`Admin balance edit — Account ${k}: Checking $${fmt(a.checking)}→$${fmt(cv)}, Savings $${fmt(a.savings)}→$${fmt(sv)}`, 'Teller');
  a.checking = +cv.toFixed(2);
  a.savings = +sv.toFixed(2);
  renderTellerAccounts();
  renderTellerSummary();
  if(currentAcc==k) renderCust();
}

function setFreeze(k, state){
  DB.accounts[k].frozen = state;
  addAudit(`Account ${k} ${state?'FROZEN':'UNFROZEN'} by Teller`, 'Teller');
  renderTellerAccounts();
  renderTellerSummary();
  if(currentAcc==k) renderCust();
}
function setFlag(k, state){
  DB.accounts[k].flagged = state;
  addAudit(`Account ${k} ${state?'FLAGGED':'UNFLAGGED'} by Teller`, 'Teller');
  renderTellerAccounts();
  renderTellerSummary();
  if(currentAcc==k) renderCust();
}

function populateTellerSelects(){
  const opts = Object.entries(DB.accounts).map(([k,a])=>`<option value="${k}">${k} — ${esc(a.name)}</option>`).join('');
  ['t-tx-acc','t-recur-acc','t-loan-acc'].forEach(id=>{ const e=document.getElementById(id); if(e) e.innerHTML=opts; });
  // Loan payment select
  const allLoans = [];
  Object.entries(DB.accounts).forEach(([k,a])=>{
    a.loans.filter(l=>l.remaining>0).forEach(l=>allLoans.push(`<option value="${k}|${l.id}">${k} · ${esc(l.name)} ($${fmt(l.remaining)})</option>`));
  });
  const lps = document.getElementById('t-loanpay-select');
  if(lps) lps.innerHTML = allLoans.length===0 ? '<option>No active loans</option>' : allLoans.join('');
}

// ================================================================
// TELLER: CREATE TRANSACTION
// ================================================================
function createTellerTx(){
  const k = document.getElementById('t-tx-acc').value;
  const type = document.getElementById('t-tx-type').value;
  const target = document.getElementById('t-tx-target').value;
  const cat = document.getElementById('t-tx-cat').value;
  const amt = parseFloat(document.getElementById('t-tx-amt').value);
  const note = document.getElementById('t-tx-note').value.trim();
  const alertEl = document.getElementById('t-tx-alert');

  if(!k){ showAl(alertEl,'error','Select an account.'); return; }
  if(!amt||amt<=0){ showAl(alertEl,'error','Enter a valid amount.'); return; }
  const a = DB.accounts[k];
  if(type==='debit' && a[target] < amt){ showAl(alertEl,'error',`Insufficient ${target} balance ($${fmt(a[target])}).`); return; }

  const signedAmt = type==='credit' ? +amt.toFixed(2) : -amt.toFixed(2);
  a[target] = +(a[target] + signedAmt).toFixed(2);

  const icons = { Deposit:'💵', 'Payroll Credit':'💼', 'Business Revenue':'🏢', 'Government Fine':'⚖', 'Utility Payment':'⚡', 'Loan Payment':'📋', 'Savings Transfer':'⇄', 'Administrative Credit':'🏛', Withdrawal:'🏧', Other:'💳' };
  addTx(k, note||cat, signedAmt, target, icons[cat]||'💳', cat, note);
  addAudit(`Teller TX: ${type} $${fmt(amt)} (${cat}) → Account ${k} ${target} · "${note}"`, 'Teller');
  showAl(alertEl,'success',`Transaction posted: ${type==='credit'?'+':'-'}$${fmt(amt)} (${cat}) on Account ${k}`);
  document.getElementById('t-tx-amt').value='';
  document.getElementById('t-tx-note').value='';
  renderTellerSummary();
  if(currentAcc==k) renderCust();
}

// ================================================================
// TELLER: RECURRING PAYMENTS
// ================================================================
// ================================================================
// ADVANCED RECURRING PAYMENT ENGINE
// Flexible interval shorthand: m=minutes h=hours d=days mo=months y=years
// Compound: "2d 12h" "1mo 5d" "1y 2mo"
// ================================================================

function parseInterval(raw) {
  // Returns { ms, label } or null if invalid
  if (!raw || typeof raw !== 'string') return null;
  const s = raw.trim().toLowerCase().replace(/\s+/g, ' ');
  if (!s) return null;
  // No decimals allowed
  if (/[0-9]\.[0-9]/.test(s)) return null;

  const units = [
    { re: /(\d+)\s*y(?:ear(?:s)?)?/, ms: 365*24*60*60*1000, lbl: n => n===1 ? '1 year' : n+' years' },
    { re: /(\d+)\s*mo(?:nth(?:s)?)?/, ms: 30*24*60*60*1000, lbl: n => n===1 ? '1 month' : n+' months' },
    { re: /(\d+)\s*d(?:ay(?:s)?)?/, ms: 24*60*60*1000, lbl: n => n===1 ? '1 day' : n+' days' },
    { re: /(\d+)\s*h(?:our(?:s)?)?/, ms: 60*60*1000, lbl: n => n===1 ? '1 hour' : n+' hours' },
    { re: /(\d+)\s*m(?:in(?:ute(?:s)?)?)?(?!o)/, ms: 60*1000, lbl: n => n===1 ? '1 minute' : n+' minutes' },
  ];
  let working = s;
  let totalMs = 0;
  const parts = [];
  for (const u of units) {
    const m = working.match(u.re);
    if (m) {
      const n = parseInt(m[1]);
      if (n <= 0) return null;
      totalMs += n * u.ms;
      parts.push(u.lbl(n));
      working = working.replace(m[0], '').trim();
    }
  }
  if (working.replace(/\s/g,'') !== '') return null;
  if (!parts.length || totalMs <= 0) return null;
  return { ms: totalMs, label: parts.join(' and ') };
}

function fmtNextDue(tsMs) {
  const d = new Date(tsMs);
  return d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}) +
    ' at ' + d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false});
}

function recurBadge(status) {
  const map = { active:'cs-active', paused:'cs-awaiting', failed:'cs-closed', completed:'cs-resolved' };
  const lbl = { active:'Active', paused:'Paused', failed:'Failed', completed:'Completed' };
  return '<span class="chat-status-badge ' + (map[status]||'cs-active') + '">' + (lbl[status]||status) + '</span>';
}

let _recurPreviewData = null;

function previewRecurring() {
  const alertEl = document.getElementById('t-recur-alert');
  const accKey = (document.getElementById('t-recur-acc')||{}).value || '';
  const name = ((document.getElementById('t-recur-name')||{}).value||'').trim();
  const amt = parseFloat((document.getElementById('t-recur-amt')||{}).value||'');
  const target = (document.getElementById('t-recur-target')||{}).value || 'checking';
  const cat = (document.getElementById('t-recur-cat')||{}).value || 'Other';
  const intervalRaw = ((document.getElementById('t-recur-interval')||{}).value||'').trim();
  const occ = parseInt((document.getElementById('t-recur-occ')||{}).value||'0')||0;
  const penalty = parseFloat((document.getElementById('t-recur-penalty')||{}).value||'0')||0;

  if (!accKey) { showAl(alertEl,'error','Select an account.'); return; }
  if (!name)   { showAl(alertEl,'error','Enter a payment label.'); return; }
  if (!amt || amt <= 0 || isNaN(amt)) { showAl(alertEl,'error','Enter a valid amount greater than zero.'); return; }
  if (occ < 0 || occ !== Math.floor(occ)) { showAl(alertEl,'error','Occurrences must be a non-negative whole number.'); return; }
  if (penalty < 0) { showAl(alertEl,'error','Penalty must be zero or a positive amount.'); return; }

  const parsed = parseInterval(intervalRaw);
  if (!parsed) {
    showAl(alertEl,'error','Invalid interval format. Use shorthand like: 1mo · 7d · 1h 30m · 1y 2mo · 2d 12h');
    return;
  }
  // Duplicate check
  const dup = DB.recurringPayments.find(r => r.accKey == accKey && r.name === name && r.status !== 'completed');
  if (dup) { showAl(alertEl,'error','A recurring payment with this name already exists for this account.'); return; }

  clAl(alertEl);
  _recurPreviewData = { accKey, name, amt, target, cat, intervalRaw, intervalMs: parsed.ms, intervalLabel: parsed.label, occ, maxOcc: occ, penalty };

  const panel = document.getElementById('t-recur-preview');
  const accName = (DB.accounts[accKey]||{}).name || accKey;
  const setTxt = (id, val) => { const e = document.getElementById(id); if(e) e.textContent = val; };
  setTxt('t-rp-name', name);
  setTxt('t-rp-account', accName + ' (' + accKey + ')');
  setTxt('t-rp-amount', '$' + fmt(amt) + ' from ' + target);
  setTxt('t-rp-interval', 'Every ' + parsed.label);
  setTxt('t-rp-next', fmtNextDue(Date.now() + parsed.ms));
  setTxt('t-rp-occ', occ > 0 ? occ + ' time(s) then completes' : 'Unlimited');
  setTxt('t-rp-penalty', penalty > 0 ? '$' + fmt(penalty) + ' NSF penalty' : 'None');
  if (panel) { panel.style.display = 'block'; panel.scrollIntoView({ behavior:'smooth', block:'nearest' }); }
}

function cancelRecurPreview() {
  _recurPreviewData = null;
  const panel = document.getElementById('t-recur-preview');
  if (panel) panel.style.display = 'none';
}

function confirmCreateRecurring() {
  if (!_recurPreviewData) return;
  const p = _recurPreviewData;
  DB.recurringPayments.push({
    id: DB.nextRecurId++,
    accKey: p.accKey, name: p.name, amt: p.amt, target: p.target, cat: p.cat,
    intervalRaw: p.intervalRaw, intervalMs: p.intervalMs, intervalLabel: p.intervalLabel,
    occ: p.occ, maxOcc: p.maxOcc, penalty: p.penalty,
    nextDue: Date.now() + p.intervalMs,
    createdAt: ts(), occurrencesRun: 0,
    status: 'active', failedCount: 0, missedCount: 0, lastRun: null, pausedAt: null
  });
  addAudit('Recurring "' + p.name + '" created: $' + fmt(p.amt) + ' every ' + p.intervalLabel + ' from Account ' + p.accKey, 'Teller');
  const alertEl = document.getElementById('t-recur-alert');
  showAl(alertEl,'success','Recurring payment "' + p.name + '" is now active.');
  cancelRecurPreview();
  clearRecurForm();
  renderRecurringList();
  if (currentAcc) renderCust();
}

function clearRecurForm() {
  ['t-recur-name','t-recur-amt','t-recur-interval'].forEach(id => { const e=document.getElementById(id); if(e) e.value=''; });
  ['t-recur-occ','t-recur-penalty'].forEach(id => { const e=document.getElementById(id); if(e) e.value='0'; });
}

function renderRecurringList() {
  const list = document.getElementById('t-recur-list');
  if (!list) return;
  const filterEl = document.getElementById('t-recur-filter');
  const filter = filterEl ? filterEl.value : 'all';
  let rows = DB.recurringPayments.filter(r => filter === 'all' ? true : r.status === filter);
  if (!rows.length) {
    list.innerHTML = '<div style="color:var(--text3);font-size:12px">No schedules found.</div>';
    return;
  }
  // Sort: active first, then paused, failed, completed
  const order = { active:0, paused:1, failed:2, completed:3 };
  rows = rows.slice().sort((a,b) => (order[a.status]||9) - (order[b.status]||9));

  list.innerHTML = rows.map(r => {
    const nextStr = r.status==='paused' ? '<em style="color:var(--amber)">Paused</em>'
      : r.status==='completed' ? '<em style="color:var(--blue)">Completed</em>'
      : r.nextDue ? fmtNextDue(r.nextDue) : '—';
    const intervalDisplay = esc(r.intervalRaw || r.freq || '?') +
      (r.intervalLabel ? ' <span style="color:var(--text3);font-size:10px">(' + esc(r.intervalLabel) + ')</span>' : '');
    return '<div class="recur-row">' +
      '<div class="rr-info">' +
        '<div class="rr-name">' + esc(r.name) + ' ' + recurBadge(r.status||'active') + '</div>' +
        '<div class="rr-meta">ACC ' + r.accKey + ' &nbsp;·&nbsp; ' +
          '<strong style="color:var(--amber)">$' + fmt(r.amt) + '</strong> from ' + r.target + ' &nbsp;·&nbsp; ' +
          intervalDisplay +
          (r.maxOcc > 0 ? ' &nbsp;·&nbsp; ' + r.occurrencesRun + '/' + r.maxOcc + ' runs' : ' &nbsp;·&nbsp; ' + r.occurrencesRun + ' runs') +
          (r.failedCount > 0 ? ' &nbsp;·&nbsp; <span style="color:var(--red)">' + r.failedCount + ' failed</span>' : '') +
        '</div>' +
        '<div style="font-size:11px;color:var(--text3);margin-top:3px">Next deduction: ' + nextStr + '</div>' +
      '</div>' +
      '<div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end">' +
        (r.status==='active' ? '<button class="btn btn-ghost btn-sm" onclick="pauseRecurring(' + r.id + ')" style="color:var(--amber);font-size:10px">⏸ Pause</button>' : '') +
        (r.status==='paused' ? '<button class="btn btn-ghost btn-sm" onclick="resumeRecurring(' + r.id + ')" style="color:var(--green2);font-size:10px">▶ Resume</button>' : '') +
        (r.status !== 'completed' ? '<button class="btn btn-danger btn-sm" onclick="cancelRecurring(' + r.id + ')" style="font-size:10px">✕ Cancel</button>' : '') +
      '</div>' +
    '</div>';
  }).join('');
}

function pauseRecurring(id) {
  const r = DB.recurringPayments.find(r => r.id === id);
  if (!r || r.status !== 'active') return;
  r.status = 'paused'; r.pausedAt = ts();
  addAudit('Recurring "' + r.name + '" (ID:' + id + ') paused by teller', 'Teller');
  renderRecurringList();
}

function resumeRecurring(id) {
  const r = DB.recurringPayments.find(r => r.id === id);
  if (!r || r.status !== 'paused') return;
  r.status = 'active'; r.pausedAt = null;
  r.nextDue = Date.now() + (r.intervalMs || 2592000000);
  addAudit('Recurring "' + r.name + '" (ID:' + id + ') resumed by teller', 'Teller');
  renderRecurringList();
}

function cancelRecurring(id) {
  const r = DB.recurringPayments.find(r => r.id === id);
  if (!r) return;
  if (!confirm('Cancel recurring payment "' + r.name + '"? This cannot be undone.')) return;
  r.status = 'completed';
  addAudit('Recurring "' + r.name + '" (ID:' + id + ') cancelled by teller', 'Teller');
  renderRecurringList();
}

function processDuePayments() {
  if (!DB.recurringPayments) return;
  const now = Date.now();
  const results = [];
  DB.recurringPayments.filter(r => r.status === 'active' && r.nextDue <= now).forEach(r => {
    if (r.maxOcc > 0 && r.occurrencesRun >= r.maxOcc) { r.status = 'completed'; return; }
    const a = DB.accounts[r.accKey];
    if (!a) { r.status = 'completed'; return; }
    if (a[r.target] >= r.amt) {
      a[r.target] = +(a[r.target] - r.amt).toFixed(2);
      addTx(r.accKey, r.name, -r.amt, r.target, '🔄', r.cat, 'Recurring');
      r.occurrencesRun++;
      r.lastRun = ts();
      r.nextDue = now + (r.intervalMs || 2592000000);
      if (r.maxOcc > 0 && r.occurrencesRun >= r.maxOcc) r.status = 'completed';
      addAudit('Recurring "' + r.name + '" processed: -$' + fmt(r.amt) + ' from Account ' + r.accKey, 'System');
      results.push('<span style="color:var(--green2)">✓ ' + esc(r.name) + ' &nbsp;·&nbsp; -$' + fmt(r.amt) + '</span>');
    } else {
      r.failedCount = (r.failedCount||0) + 1;
      r.missedCount = (r.missedCount||0) + 1;
      r.status = 'failed';
      r.nextDue = now + (r.intervalMs || 2592000000);
      if (r.penalty > 0 && a[r.target] >= r.penalty) {
        a[r.target] = +(a[r.target] - r.penalty).toFixed(2);
        addTx(r.accKey, r.name + ' — NSF PENALTY', -r.penalty, r.target, '⚠', 'Penalty', 'Non-sufficient funds');
        addAudit('Recurring "' + r.name + '" FAILED — NSF penalty $' + fmt(r.penalty) + ' applied on Account ' + r.accKey, 'System');
      } else {
        addAudit('Recurring "' + r.name + '" FAILED — insufficient funds on Account ' + r.accKey, 'System');
      }
      results.push('<span style="color:var(--red)">✗ ' + esc(r.name) + ' &nbsp;·&nbsp; FAILED (insufficient funds)</span>');
    }
    if (currentAcc == r.accKey) renderCust();
  });
  const resEl = document.getElementById('t-recur-run-result');
  if (resEl) resEl.innerHTML = results.length === 0
    ? '<span style="color:var(--text3)">No payments were due at this time.</span>'
    : results.map(r => '<div style="padding:3px 0">' + r + '</div>').join('');
  renderRecurringList();
  renderTellerSummary();
}

function renderCustRecurring() {
  const el = document.getElementById('c-recur-list');
  if (!el) return;
  const myPayments = DB.recurringPayments.filter(r => r.accKey == currentAcc && r.status !== 'completed');
  if (!myPayments.length) {
    el.innerHTML = '<div class="card card-sm" style="color:var(--text3);font-size:12px">No scheduled recurring payments on this account.</div>';
    return;
  }
  el.innerHTML = myPayments.map(r =>
    '<div class="card card-sm" style="margin-bottom:10px">' +
      '<div style="display:flex;justify-content:space-between;align-items:flex-start">' +
        '<div>' +
          '<div style="font-size:14px;font-weight:600">' + esc(r.name) + '</div>' +
          '<div style="font-size:11px;color:var(--text3);margin-top:3px">' + esc(r.cat) + ' · from ' + r.target + '</div>' +
        '</div>' +
        '<div style="text-align:right">' +
          '<div class="mono" style="font-size:18px;color:var(--amber)">$' + fmt(r.amt) + '</div>' +
          '<div style="margin-top:4px">' + recurBadge(r.status||'active') + '</div>' +
        '</div>' +
      '</div>' +
      '<div style="margin-top:10px;display:flex;gap:20px;font-size:12px;color:var(--text2)">' +
        '<div><span style="color:var(--text3)">Every:</span> ' + esc(r.intervalLabel || r.intervalRaw || r.freq || '—') + '</div>' +
        '<div><span style="color:var(--text3)">Runs:</span> ' + r.occurrencesRun + (r.maxOcc > 0 ? '/' + r.maxOcc : '') + '</div>' +
      '</div>' +
      '<div style="margin-top:6px;font-size:12px;color:var(--text2)">' +
        '<span style="color:var(--text3)">Next payment:</span> ' +
        (r.status === 'paused' ? '<em style="color:var(--amber)">Paused — contact support</em>'
          : r.nextDue ? fmtNextDue(r.nextDue) : '—') +
      '</div>' +
    '</div>'
  ).join('');
}

// ================================================================
// TELLER: LOANS
// ================================================================
function issueLoan(){
  const accKey = document.getElementById('t-loan-acc').value;
  const name = document.getElementById('t-loan-name').value.trim();
  const principal = parseFloat(document.getElementById('t-loan-principal').value);
  const rate = parseFloat(document.getElementById('t-loan-rate').value)||0;
  const monthly = parseFloat(document.getElementById('t-loan-payment').value);
  const months = parseInt(document.getElementById('t-loan-months').value)||12;
  const disburse = document.getElementById('t-loan-disburse').value;
  const schedule = document.getElementById('t-loan-schedule').value;
  const alertEl = document.getElementById('t-loan-alert');

  if(!accKey){ showAl(alertEl,'error','Select an account.'); return; }
  if(!name){ showAl(alertEl,'error','Enter a loan label.'); return; }
  if(!principal||principal<=0){ showAl(alertEl,'error','Enter a valid principal.'); return; }
  if(!monthly||monthly<=0){ showAl(alertEl,'error','Enter a monthly payment amount.'); return; }

  const loanId = DB.nextLoanId++;
  const a = DB.accounts[accKey];
  a.loans.push({ id:loanId, name, principal, remaining:+principal.toFixed(2), rate, monthly, months, startDate:ts() });
  a[disburse] = +(a[disburse]+principal).toFixed(2);
  a.creditTier = 'Active Borrower';
  addTx(accKey, `Loan Disbursement — ${name}`, +principal.toFixed(2), disburse, '💼', 'Loan Disbursement', '');
  addAudit(`Loan issued: "${name}" $${fmt(principal)} at ${rate}% APR → Account ${accKey}`, 'Teller');

  if(schedule==='yes'){
    DB.recurringPayments.push({
      id: DB.nextRecurId++,
      accKey, name: `Loan Payment — ${name}`,
      amt: +monthly.toFixed(2), target:'checking', cat:'Loan Payment',
      freq:'monthly', occ:months, maxOcc:months, penalty:0,
      nextDue: Date.now()+2592000000,
      createdAt:ts(), occurrencesRun:0, active:true, failedCount:0,
      loanId
    });
    addAudit(`Auto-scheduled monthly payment $${fmt(monthly)} for loan "${name}"`, 'System');
  }

  showAl(alertEl,'success',`Loan "${name}" issued. $${fmt(principal)} disbursed to ${disburse}.`);
  ['t-loan-name','t-loan-principal','t-loan-rate','t-loan-payment','t-loan-months'].forEach(id=>{ const e=document.getElementById(id); if(e) e.value=''; });
  renderLoansAdmin();
  renderTellerSummary();
  populateTellerSelects();
  if(currentAcc==accKey) renderCust();
}

function renderLoansAdmin(){
  const allLoans = [];
  Object.entries(DB.accounts).forEach(([k,a])=>{
    a.loans.filter(l=>l.remaining>0).forEach(l=>allLoans.push({accKey:k,accName:a.name,...l}));
  });
  const listEl = document.getElementById('t-loans-active-list');
  listEl.innerHTML = allLoans.length===0
    ? '<div style="color:var(--text3);font-size:12px">No active loans in system.</div>'
    : allLoans.map(l=>`
        <div class="card card-sm" style="margin-bottom:8px">
          <div style="display:flex;justify-content:space-between;margin-bottom:6px">
            <div><div style="font-size:13px;font-weight:600">${esc(l.name)}</div><div style="font-size:11px;color:var(--text3)">ACC ${l.accKey} — ${esc(l.accName)}</div></div>
            <div style="text-align:right"><div class="mono" style="color:var(--amber)">$${fmt(l.remaining)}</div><div style="font-size:10px;color:var(--text3)">${l.rate}% APR</div></div>
          </div>
          <div class="prog-wrap"><div class="prog-fill prog-amber" style="width:${Math.min(100,((l.principal-l.remaining)/l.principal*100)).toFixed(1)}%"></div></div>
        </div>`).join('');
}

function makeLoanPayment(){
  const sel = document.getElementById('t-loanpay-select').value;
  const amt = parseFloat(document.getElementById('t-loanpay-amt').value);
  const alertEl = document.getElementById('t-loanpay-alert');

  if(!sel||sel==='No active loans'){ showAl(alertEl,'error','No loan selected.'); return; }
  if(!amt||amt<=0){ showAl(alertEl,'error','Enter a payment amount.'); return; }

  const [accKey, loanIdStr] = sel.split('|');
  const loanId = parseInt(loanIdStr);
  const a = DB.accounts[accKey];
  const loan = a.loans.find(l=>l.id===loanId);
  if(!loan){ showAl(alertEl,'error','Loan not found.'); return; }
  if(a.checking < amt){ showAl(alertEl,'error','Insufficient checking balance.'); return; }

  const actual = Math.min(amt, loan.remaining);
  a.checking = +(a.checking-actual).toFixed(2);
  loan.remaining = +(loan.remaining-actual).toFixed(2);
  addTx(accKey, `Loan Payment — ${loan.name}`, -actual, 'checking', '📋', 'Loan Payment', '');
  addAudit(`Loan payment $${fmt(actual)} applied to "${loan.name}" — Account ${accKey}`, 'Teller');
  if(loan.remaining <= 0){
    a.creditTier = 'Paid Borrower';
    addAudit(`Loan "${loan.name}" fully repaid — Account ${accKey}`, 'System');
  }
  showAl(alertEl,'success',`Payment of $${fmt(actual)} applied. Remaining: $${fmt(loan.remaining)}`);
  document.getElementById('t-loanpay-amt').value='';
  renderLoansAdmin();
  renderTellerSummary();
  populateTellerSelects();
  if(currentAcc==accKey) renderCust();
}

// ================================================================
// TELLER: GENERATE ACCOUNT
// ================================================================
function generateAccount(){
  const name = document.getElementById('t-gen-name').value.trim();
  const alertEl = document.getElementById('t-gen-alert');
  if(!name){ showAl(alertEl,'error','Enter the account holder name.'); return; }

  const newNum = DB.nextAccId++;
  const newPin = String(10000+Math.floor(Math.random()*90000));
  DB.accounts[newNum] = {
    name, pin:newPin,
    checking:0, savings:0,
    frozen:false, flagged:false,
    creditTier:'—',
    transactions:[], loans:[],
    chat:[{from:'ai',text:'Welcome to Clover Financial Support. I\'m the Clover AI Assistant. How can I assist you today?',time:ts()}],
    chatStatus:'active',
    chatAiEscalated:false,
    chatId:`ACC-${newNum}-001`,
    chatOpenedAt:ts(),
    chatClosedAt:null, chatArchivedAt:null, chatClosureReason:null,
    failedLogins:0, loginLocked:false
  };
  addAudit(`New account generated: ${newNum} — "${name}"`, 'Teller');
  document.getElementById('t-gen-num').textContent = newNum;
  document.getElementById('t-gen-pin').textContent = newPin;
  document.getElementById('t-gen-result').style.display = 'block';
  clAl(alertEl);
  document.getElementById('t-gen-name').value='';
  populateTellerSelects();
  renderTellerAccounts();
  renderTellerSummary();
}

// ================================================================

// ================================================================
// ██████████████████████████████████████████████████████████████
// CLOVER AI SUPPORT ENGINE
// ██████████████████████████████████████████████████████████████
// ================================================================

// ================================================================
// AI INTELLIGENCE ENGINE — 3-LAYER HYBRID SYSTEM
// Layer 1: Teller FAQ (highest authority)
// Layer 2: Built-in KB with contextual interpretation
// Layer 3: Confidence-based escalation
// ================================================================

// ---- Built-in Knowledge Base ----
const AI_BUILTIN_KB = [
  {
    id: 'deposit', category: 'deposit',
    keywords: ['deposit','add money','add funds','put money','put funds','how to deposit','make a deposit','fund account'],
    answer: 'Deposits at Clover Financial are <strong>teller-controlled only</strong>. To make a deposit, please visit a Clover Financial branch in person or contact us through the official Discord banking channel. An authorized teller must process all deposits through the admin panel.',
    followups: ['connect','policy-deposit'], escalate: false, requiresLogin: false
  },
  {
    id: 'withdrawal', category: 'withdrawal',
    keywords: ['withdraw','withdrawal','take out money','take money out','cash out','how do i withdraw','how to withdraw'],
    answer: 'Withdrawals can be initiated from your account dashboard under <strong>Withdraw Funds</strong>. Standard withdrawal limits apply based on your account status. Flagged accounts are restricted to withdrawals under $2,000. Frozen accounts cannot process withdrawals.',
    followups: ['connect','login'], escalate: false, requiresLogin: false
  },
  {
    id: 'freeze', category: 'security',
    keywords: ['frozen','account frozen','account locked','why is my account frozen','freeze','unfreeze','locked account','account lock'],
    answer: 'Account freezes are applied by our teller team for security or compliance reasons. A frozen account cannot process withdrawals or certain transactions. To request a review or unfreeze, please connect with a human agent — only authorized tellers can modify account freeze status.',
    followups: ['connect'], escalate: true, requiresLogin: false
  },
  {
    id: 'loans', category: 'loans',
    keywords: ['loan','borrow','lending','how do loans work','loan payment','pay loan','loan balance','loan interest','apr','monthly payment'],
    answer: 'Clover Financial offers structured loans managed by our teller team. Loan terms, interest rates, and monthly payments are set at origination. You can view your active loans and payment history in the <strong>Loans</strong> section of your dashboard. Loan payments are processed as scheduled recurring deductions.',
    followups: ['connect','login'], escalate: false, requiresLogin: false
  },
  {
    id: 'recurring', category: 'recurring',
    keywords: ['recurring','scheduled payment','automatic payment','recurring payment','auto pay','scheduled deduction','automatic deduction','monthly payment'],
    answer: 'Recurring payments are automated deductions set by your teller — such as rent, loan repayments, utility bills, or subscriptions. They occur at scheduled intervals you can view in your dashboard. To modify or cancel a recurring payment, please connect with a human agent.',
    followups: ['connect','login'], escalate: false, requiresLogin: false
  },
  {
    id: 'account-open', category: 'account',
    keywords: ['open account','create account','new account','how to sign up','register','join','become a member','get an account','sign up'],
    answer: 'To open a Clover Financial account, please speak with an authorized teller or contact us via our official Discord channel. Account credentials — account number and PIN — are generated by our teller team and provided securely. There is no self-registration. All accounts are created through our controlled onboarding process.',
    followups: ['connect'], escalate: false, requiresLogin: false
  },
  {
    id: 'teller-access', category: 'general',
    keywords: ['teller','teller access','teller login','admin','staff login','how to become teller','staff panel','admin panel'],
    answer: 'Teller access is restricted to authorized Clover Financial staff. The teller terminal requires a secure authentication code and is not publicly available. If you require teller-level access, please contact the system administrator directly.',
    followups: [], escalate: false, requiresLogin: false
  },
  {
    id: 'balance', category: 'account',
    keywords: ['balance','how much money','check balance','my balance','account balance','what is my balance','current balance'],
    answer: 'For security, account balance information is only accessible through your secure dashboard. Please log in to your member portal to view your checking and savings balances.',
    followups: ['login'], escalate: false, requiresLogin: true
  },
  {
    id: 'savings', category: 'savings',
    keywords: ['savings','savings account','interest rate','savings rate','interest','how much interest'],
    answer: 'Your Clover Financial savings account is managed alongside your checking account. Interest rates and savings policies are set by the teller team. You can view your current savings balance from your dashboard. For questions about interest policy, please connect with an agent.',
    followups: ['connect','login'], escalate: false, requiresLogin: false
  },
  {
    id: 'dispute', category: 'dispute',
    keywords: ['dispute','wrong charge','incorrect transaction','unauthorized','fraud','error on account','wrong amount','transaction error','incorrect charge','charge error'],
    answer: 'Transaction disputes require review by an authorized human agent. I am not able to modify account balances or reverse transactions. A human agent will review your transaction history and take appropriate action on your behalf.',
    followups: ['connect'], escalate: true, requiresLogin: false
  },
  {
    id: 'security', category: 'security',
    keywords: ['security','pin','password','change pin','forgot pin','reset password','privacy','data','credentials','authentication'],
    answer: 'Account security changes — such as PIN resets or credential updates — must be processed by an authorized teller with valid identification. I am not able to modify authentication credentials. Please connect with a human agent to proceed.',
    followups: ['connect'], escalate: true, requiresLogin: false
  },
  {
    id: 'about', category: 'general',
    keywords: ['how does clover work','what is clover','what is clover financial','about clover','explain clover','controlled economy','roleplay bank','how clover works'],
    answer: 'Clover Financial is a structured, controlled-economy digital banking platform. All financial transactions are managed by authorized tellers, ensuring every balance is verified and auditable. Members can access checking and savings accounts, apply for loans, and set up recurring payments — all within a secure, policy-governed framework.',
    followups: ['connect'], escalate: false, requiresLogin: false
  },
  {
    id: 'support', category: 'general',
    keywords: ['how does support work','contact support','speak to agent','human agent','talk to person','talk to someone','real person','live agent','connect'],
    answer: "Clover Financial support operates on a two-layer model: <strong>Clover AI</strong> handles general questions and policy guidance instantly. For account actions, disputes, or complex requests, a <strong>Human Agent</strong> from our teller team will assist you directly with full authority to take action on your account.",
    followups: ['connect'], escalate: false, requiresLogin: false
  },
  {
    id: 'transfer', category: 'general',
    keywords: ['transfer','move money','move funds','transfer to savings','transfer money','move to savings'],
    answer: 'You can transfer funds between your Checking and Savings accounts from the <strong>Transfer to Savings</strong> section of your dashboard. Transfers are processed immediately and reflected in your balance. For external transfers or wire transfers, please connect with a human agent.',
    followups: ['login'], escalate: false, requiresLogin: false
  },
  {
    id: 'fees', category: 'policy',
    keywords: ['fee','fees','charges','service fee','account fee','cost','pricing','monthly fee'],
    answer: 'Account fees, service charges, and any applicable penalties are determined by Clover Financial policy and administered by the teller team. For a detailed breakdown of any charges on your account, please connect with a human agent or review your transaction history in your dashboard.',
    followups: ['connect','login'], escalate: false, requiresLogin: false
  }
];

// ---- Hard escalation triggers ----
const AI_ESCALATION_PHRASES = [
  'speak to a person','speak to human','talk to person','talk to agent','human agent',
  'real person','connect me','escalate','need a human','want a person','i need help now',
  'this is urgent','urgent','emergency','account modification','change my balance',
  'modify my account','delete my account','close my account','give me my money',
  'this is wrong','fix this now','not working'
];

// ---- AI State ----
let _aiResponseTimer = null;

// ---- Fuzzy keyword scorer ----
function _aiScore(lower, keywords) {
  let score = 0;
  for (const kw of keywords) {
    const kwl = kw.toLowerCase();
    if (lower.includes(kwl)) {
      // Bonus for longer/more specific keyword matches
      score += 1 + (kwl.split(' ').length - 1) * 0.5;
    } else {
      // Partial word match (handles typos like "widthdraw")
      const words = kwl.split(' ');
      for (const w of words) {
        if (w.length > 4 && lower.includes(w.substring(0, Math.floor(w.length * 0.8)))) {
          score += 0.3;
        }
      }
    }
  }
  return score;
}

// ---- Core 3-Layer AI Response Function ----
function aiRespond(userText, channel, context) {
  if (!DB.ai || !DB.ai.enabled) return null;
  if (!userText) return null;

  const lower = userText.toLowerCase().trim();
  const t0 = Date.now();

  // ── LAYER 1: Teller-defined FAQ (highest authority) ──────────────
  let bestFaq = null, bestFaqScore = 0;
  for (const faq of (DB.ai.faqs || [])) {
    if (!faq.active) continue;
    const kwList = (faq.keywords || []).concat(faq.title ? [faq.title] : []);
    const score = _aiScore(lower, kwList);
    if (score > bestFaqScore) { bestFaqScore = score; bestFaq = faq; }
  }
  if (bestFaq && bestFaqScore > 0) {
    // Update hit count
    bestFaq.hitCount = (bestFaq.hitCount || 0) + 1;
    const btns = [];
    if (bestFaq.escalationRequired) btns.push({ label:'Connect with Agent', action:'escalate', style:'escalate' });
    btns.push({ label:'Connect with Agent', action:'escalate', style:'escalate' });
    // Deduplicate
    const uniqueBtns = btns.filter((b,i,arr) => arr.findIndex(x=>x.action===b.action)===i);
    const s = DB.ai.stats;
    s.categoryHits = s.categoryHits || {};
    s.categoryHits[bestFaq.category || 'general'] = (s.categoryHits[bestFaq.category || 'general'] || 0) + 1;
    _logAiInteraction(userText, bestFaq.escalationRequired ? 'escalated' : 'answered', channel, Date.now()-t0, 'high');
    return {
      text: bestFaq.response,
      quickBtns: bestFaq.escalationRequired ? [{ label:'Connect with Agent', action:'escalate', style:'escalate' }] : [],
      escalate: !!bestFaq.escalationRequired
    };
  }

  // ── LAYER 2: Escalation phrase detection ─────────────────────────
  const wantsHuman = AI_ESCALATION_PHRASES.some(p => lower.includes(p));
  if (wantsHuman) {
    _logAiInteraction(userText, 'escalated', channel, Date.now()-t0, 'high');
    return {
      text: "Understood. I will connect you with a <strong>Clover Financial Human Agent</strong> right away. Please hold — a member of our teller team will join this conversation shortly.",
      quickBtns: [],
      escalate: true
    };
  }

  // ── LAYER 2: Built-in KB matching with scoring ───────────────────
  let bestMatch = null, bestScore = 0;
  for (const entry of AI_BUILTIN_KB) {
    const score = _aiScore(lower, entry.keywords);
    if (score > bestScore) { bestScore = score; bestMatch = entry; }
  }

  const sensitivity = DB.ai.escalationSensitivity || 2;

  if (bestMatch && bestScore > 0) {
    // Confidence assessment
    const confidence = bestScore >= 1.5 ? 'high' : bestScore >= 0.8 ? 'medium' : 'low';

    // Low confidence on high sensitivity → escalate
    if (confidence === 'low' && sensitivity >= 3) {
      _logAiInteraction(userText, 'escalated', channel, Date.now()-t0, confidence);
      return {
        text: 'I may not have complete information on that specific matter. I recommend connecting with a human agent for direct assistance.',
        quickBtns: [{ label:'Connect with Agent', action:'escalate', style:'escalate' }],
        escalate: false
      };
    }

    // Account-specific on public channel
    if (bestMatch.requiresLogin && channel === 'public') {
      _logAiInteraction(userText, 'answered', channel, Date.now()-t0, confidence);
      return {
        text: 'For account-specific information, please <strong>log in</strong> to your member portal. Your balance and account details are accessible securely through the dashboard.',
        quickBtns: [
          { label:'Member Login', action:'login' },
          { label:'Connect with Agent', action:'escalate', style:'escalate' }
        ],
        escalate: false
      };
    }

    // Context-aware note for logged-in users
    let contextNote = '';
    if (context && context.isLoggedIn && context.accKey) {
      const a = DB.accounts[context.accKey];
      if (a) {
        if (bestMatch.id === 'freeze' && a.frozen) {
          contextNote = ' <em style="color:var(--amber)">Note: Your account currently has a freeze flag applied. Please connect with a human agent to discuss this.</em>';
        } else if (bestMatch.id === 'loans') {
          const activeLoans = (a.loans || []).filter(l => l.remaining > 0).length;
          if (activeLoans > 0) contextNote = ' <em>You currently have <strong>' + activeLoans + ' active loan(s)</strong> on your account.</em>';
        } else if (bestMatch.id === 'recurring') {
          const myRec = DB.recurringPayments.filter(r => r.accKey == context.accKey && r.status === 'active').length;
          if (myRec > 0) contextNote = ' <em>You have <strong>' + myRec + ' active scheduled payment(s)</strong> on your account. View them in your dashboard under <strong>Recurring</strong>.</em>';
        }
      }
    }

    // Build action buttons
    const btns = [];
    if ((bestMatch.followups || []).includes('connect') || bestMatch.escalate) {
      btns.push({ label:'Connect with Agent', action:'escalate', style:'escalate' });
    }
    if ((bestMatch.followups || []).includes('login')) btns.push({ label:'Member Login', action:'login' });
    if ((bestMatch.followups || []).includes('policy-deposit')) btns.push({ label:'View Deposit Policy', action:'deposit-info' });

    // Medium confidence → add agent suggestion
    let mediumNote = '';
    if (confidence === 'medium') {
      mediumNote = ' If you need further assistance, our human agents are available to help directly.';
      if (!btns.find(b => b.action === 'escalate')) {
        btns.push({ label:'Connect with Agent', action:'escalate', style:'escalate' });
      }
    }

    const s = DB.ai.stats;
    s.categoryHits = s.categoryHits || {};
    s.categoryHits[bestMatch.category] = (s.categoryHits[bestMatch.category] || 0) + 1;
    _logAiInteraction(userText, bestMatch.escalate ? 'escalated' : 'answered', channel, Date.now()-t0, confidence);
    return {
      text: bestMatch.answer + contextNote + mediumNote,
      quickBtns: btns,
      escalate: bestMatch.escalate || false
    };
  }

  // ── LAYER 3: No match — log unmatched, offer agent ───────────────
  _logAiInteraction(userText, 'unmatched', channel, Date.now()-t0, 'none');
  DB.ai.unmatchedQuestions = DB.ai.unmatchedQuestions || [];
  DB.ai.unmatchedQuestions.unshift({ time: ts(), question: userText.substring(0, 200), channel });
  if (DB.ai.unmatchedQuestions.length > 100) DB.ai.unmatchedQuestions.pop();
  DB.ai.stats.totalUnmatched = (DB.ai.stats.totalUnmatched || 0) + 1;

  return {
    text: 'That is a question our teller team will be best positioned to address. I recommend connecting with a human agent for direct and authoritative assistance.',
    quickBtns: [
      { label:'Connect with Agent', action:'escalate', style:'escalate' },
      { label:'No, cancel', action:'cancel' }
    ],
    escalate: false
  };
}

// ---- Log AI Interaction ----
function _logAiInteraction(question, outcome, channel, ms, confidence) {
  const s = DB.ai.stats;
  if (outcome === 'escalated') s.totalEscalated++;
  else if (outcome === 'unmatched') s.totalUnmatched = (s.totalUnmatched||0) + 1;
  else s.totalAnswered++;
  s.responseTimes.push(ms);
  if (s.responseTimes.length > 200) s.responseTimes.shift();
  const _conv0 = DB.publicChats && DB.publicChats[0];
  DB.ai.conversationLogs.unshift({
    time: ts(), channel, question: (question||'').substring(0,120),
    outcome, ms, confidence: confidence||'—',
    sessionId: channel === 'public' ? (_conv0 ? _conv0.id : 'pub') : 'acc-'+(currentAcc||'?')
  });
  if (DB.ai.conversationLogs.length > 500) DB.ai.conversationLogs.pop();
}

// ---- Render a chat message bubble (unified, supports ai/teller/customer/visitor) ----
function renderMsgBubble(m) {
  const isAi      = m.from === 'ai';
  const isTeller  = m.from === 'teller';
  const isCust    = m.from === 'customer' || m.from === 'visitor';
  let cls = isTeller || isAi ? '' : 'cust';
  if(isAi) cls = 'ai-msg';
  const label = isAi ? '\u2736 Clover AI' : (isTeller ? 'Human Agent' : (m.from==='visitor' ? 'Visitor' : 'You'));
  const timeLabel = label + ' \u00b7 ' + (m.time || '');
  // m.text may contain safe HTML (bold tags from AI) — keep as-is; sanitize user text via esc() at push time
  const bubbleContent = (m.from === 'ai' || m.from === 'teller') ? (m.text || '') : esc(m.text || '');
  let html = '<div class="chat-msg ' + cls + '">';
  html += '<div class="chat-bubble">' + bubbleContent + '</div>';
  html += '<div class="chat-time' + (isAi ? ' ai-label' : '') + '">' + esc(timeLabel) + '</div>';
  // Quick buttons (stored on message)
  if(m.quickBtns && m.quickBtns.length) {
    html += '<div class="ai-quick-btns">';
    for(const b of m.quickBtns) {
      const btnStyle = b.style === 'escalate' ? ' ai-qbtn-escalate' : '';
      const ch = (m._channel === 'account') ? 'account' : 'public';
      const ky = (m._key || '').replace(/'/g, '');
      let oc = '';
      if(b.action === 'escalate')    oc = "aiUserEscalate('" + ch + "','" + ky + "')";
      else if(b.action === 'login')  oc = 'showPage(\'page-login\')';
      else if(b.action === 'deposit-info') oc = 'openMod(\'modal-deposit-info\')';
      if(oc) html += '<button class="ai-qbtn' + btnStyle + '" onclick="' + oc + '">' + esc(b.label) + '</button>';
      else   html += '<button class="ai-qbtn' + btnStyle + '">' + esc(b.label) + '</button>';
    }
    html += '</div>';
  }
  html += '</div>';
  return html;
}

// ---- Show typing indicator, then AI reply ----
function _deliverAiReply(containerEl, responseObj, onDone) {
  // Show typing dots
  const typingId = 'ai-typing-' + Date.now();
  containerEl.insertAdjacentHTML('beforeend',
    `<div id="${typingId}" class="ai-typing">
       <span>Clover AI</span>
       <div class="ai-typing-dots">
         <div class="ai-typing-dot"></div>
         <div class="ai-typing-dot"></div>
         <div class="ai-typing-dot"></div>
       </div>
     </div>`
  );
  containerEl.scrollTop = containerEl.scrollHeight;
  const delay = 600 + Math.min(responseObj.text.length * 8, 1200);
  setTimeout(() => {
    const typingEl = document.getElementById(typingId);
    if(typingEl) typingEl.remove();
    onDone(responseObj);
    containerEl.scrollTop = containerEl.scrollHeight;
  }, delay);
}

// ---- User-triggered escalation (from quick button or phrase) ----
function aiUserEscalate(channel, key) {
  if(channel === 'public') {
    const conv = DB.publicChats[0];
    if(!conv) return;
    if(conv.aiEscalated) return;
    conv.aiEscalated = true;
    conv.status = 'awaiting';
    const now = ts();
    conv.messages.push({from:'teller', text:'<strong>Escalated to Human Agent.</strong> A member of our teller team will join this conversation shortly. Please hold.', time:now});
    addAudit(`Public support [${conv.id}] — escalated to human agent by user`, 'AI System');
    renderPublicChat(); updatePublicChatStatusUi();
    renderCustPublicChat(); updateCustPubChatStatusUi();
    renderTellerPublicChats();
    const notif = document.getElementById('t-notif');
    if(notif) notif.style.display='';
  } else if(channel === 'account' && key) {
    const a = DB.accounts[key];
    if(!a || a.chatAiEscalated) return;
    a.chatAiEscalated = true;
    if(a.chatStatus==='active') a.chatStatus='awaiting';
    const now = ts();
    a.chat.push({from:'teller', text:'<strong>Escalated to Human Agent.</strong> A member of our teller team will join this conversation shortly. Please hold.', time:now});
    addAudit(`Account ${key} chat [${a.chatId}] — escalated to human agent by user`, 'AI System');
    renderCustChat(); updateCustAccChatStatusUi(key);
    renderTellerChats();
    const notif = document.getElementById('t-notif');
    if(notif) notif.style.display='';
  }
}

// CHAT LIFECYCLE HELPERS
// ================================================================

let tellerChatFilter = 'all';
let pendingChatAction = null;   // { type: 'close'|'archive'|'delete', key, isPublic, pubIdx }

function chatStatusBadgeHtml(status) {
  const map = {
    active:   'cs-active',
    awaiting: 'cs-awaiting',
    resolved: 'cs-resolved',
    closed:   'cs-closed',
    archived: 'cs-archived'
  };
  const labels = { active:'Active', awaiting:'Awaiting Response', resolved:'Resolved', closed:'Closed', archived:'Archived' };
  const cls = map[status] || 'cs-active';
  return `<span class="chat-status-badge ${cls}">${labels[status]||status}</span>`;
}

function setChatFilter(f) {
  tellerChatFilter = f;
  // Update filter button states
  ['all','active','awaiting','resolved','closed','archived'].forEach(n => {
    const el = document.getElementById('sfb-'+n);
    if(el) el.classList.toggle('active', n === f);
  });
  renderTellerChats();
}

function chatMatchesFilter(status) {
  if(tellerChatFilter === 'all') return true;
  return status === tellerChatFilter;
}

function chatMatchesSearch(name, accKey, chatId) {
  const q = (document.getElementById('t-chat-search')?.value || '').toLowerCase().trim();
  if(!q) return true;
  return (
    String(name).toLowerCase().includes(q) ||
    String(accKey).toLowerCase().includes(q) ||
    String(chatId).toLowerCase().includes(q)
  );
}

// ================================================================
// TELLER: CHATS
// ================================================================
function renderTellerChats(){
  const listEl = document.getElementById('t-chat-list');
  if(!listEl) return;

  const accEntries = Object.entries(DB.accounts);
  const filtered = accEntries.filter(([k,a]) => {
    const status = a.chatStatus || 'active';
    return chatMatchesFilter(status) && chatMatchesSearch(a.name, k, a.chatId||'');
  });

  listEl.innerHTML = filtered.length === 0
    ? `<div style="font-size:12px;color:var(--text3);padding:12px 0">No conversations match this filter.</div>`
    : filtered.map(([k,a]) => {
        const status = a.chatStatus || 'active';
        const hasCust = a.chat.some(m=>m.from==='customer');
        const last = a.chat[a.chat.length-1];
        const preview = last ? esc(last.text.substring(0,72))+(last.text.length>72?'…':'') : 'No messages';
        return `
          <div class="chat-list-item ${status} ${a.chatAiEscalated ? getEscalationUrgency(a.escalatedAt) : ''}">
            <div class="cli-header">
              <div>
                <div class="cli-name">${esc(a.name)}</div>
                <div class="cli-meta">${k} · ${a.chatId||'—'}</div>
              </div>
              ${chatStatusBadgeHtml(status)}
            </div>
            <div class="cli-preview">${preview}</div>
            <div class="cli-footer">
              <div class="cli-actions">
                <button class="btn btn-ghost btn-sm" onclick="openTellerChat('${k}')">View →</button>
                ${status !== 'closed' && status !== 'archived'
                  ? `<button class="btn btn-amber btn-sm" onclick="openCloseChatModalFor('${k}',false)">Close</button>` : ''}
                ${status !== 'archived'
                  ? `<button class="btn btn-ghost btn-sm" style="color:var(--text3)" onclick="openArchiveChatModalFor('${k}',false)">Archive</button>` : ''}
                <button class="btn btn-danger btn-sm" onclick="openDeleteChatModalFor('${k}',false)">Delete</button>
              </div>
              <div class="cli-ts">${hasCust?'↩ Needs reply':'·'} ${a.chat.length} msgs · Opened: ${a.chatOpenedAt||'—'}${a.chatAiEscalated ? (function(){var u=getEscalationUrgency(a.escalatedAt);var m=a.escalatedAt?Math.floor((Date.now()-a.escalatedAt)/60000):0;return u==='overdue'?' &nbsp;<span class="overdue-badge">OVERDUE '+m+'m</span>':u==='waiting'?' &nbsp;<span class="waiting-badge">Waiting '+m+'m</span>':' &nbsp;⚡ Escalated';})() : ''}</div>
            </div>
          </div>`;
      }).join('');

  const countEl = document.getElementById('t-acc-chat-count');
  if(countEl) countEl.textContent = `(${filtered.length})`;

  document.getElementById('t-notif').style.display = 'none';
  renderTellerPublicChats();
}

function openTellerChat(k){
  const a = DB.accounts[k];
  tellerViewingAccKey = k;
  pendingChatAction = null;

  document.getElementById('t-chat-viewing-name').textContent = a.name;
  document.getElementById('t-chat-viewing-acc').textContent = `Account: ${k} · ${a.chatId||'—'}`;
  document.getElementById('t-chat-panel').style.display = 'block';

  // Channel badge
  const badge = document.getElementById('t-chat-channel-badge');
  if(badge){ badge.textContent='Account Assistance'; badge.className='teller-chat-channel-badge tcc-account'; }

  // Status badge + lifecycle header
  const status = a.chatStatus || 'active';
  const statusEl = document.getElementById('t-chat-status-badge');
  if(statusEl){ statusEl.className='chat-status-badge '+(status==='active'?'cs-active':status==='awaiting'?'cs-awaiting':status==='resolved'?'cs-resolved':status==='closed'?'cs-closed':'cs-archived'); statusEl.textContent=status.charAt(0).toUpperCase()+status.slice(1).replace('ing',' Response'); }

  document.getElementById('t-chat-id-display').textContent = a.chatId||'';
  document.getElementById('t-chat-opened-at').textContent = a.chatOpenedAt ? 'Opened: '+a.chatOpenedAt : '';

  // Notices
  document.getElementById('t-chat-restrict-notice').style.display='none';
  const closedBanner = document.getElementById('t-chat-closed-banner');
  if(closedBanner) closedBanner.style.display = (status==='closed'||status==='archived') ? 'block' : 'none';

  // Input area — tellers can always reply regardless of status
  const iaw = document.getElementById('t-chat-iaw');
  if(iaw) iaw.classList.remove('is-closed');

  // Lifecycle action button visibility
  const isActive = status==='active'||status==='awaiting'||status==='resolved';
  const el_close   = document.getElementById('t-btn-close-chat');
  const el_archive = document.getElementById('t-btn-archive-chat');
  if(el_close)   el_close.style.display   = (status==='closed'||status==='archived') ? 'none' : '';
  if(el_archive) el_archive.style.display = (status==='archived') ? 'none' : '';

  // Lifecycle footer
  const footer = document.getElementById('t-chat-lifecycle-footer');
  if(footer){
    let info = [];
    if(a.chatClosedAt) info.push(`Closed: ${a.chatClosedAt}${a.chatClosureReason?' — Reason: '+a.chatClosureReason:''}`);
    if(a.chatArchivedAt) info.push(`Archived: ${a.chatArchivedAt}`);
    footer.textContent = info.join('  ·  ');
    footer.style.display = info.length ? 'block' : 'none';
  }

  // Escalation status chip in header
  const escBanner = document.getElementById('t-acc-escalation-note');
  if(escBanner) escBanner.style.display = a.chatAiEscalated ? 'flex' : 'none';

  // Render messages
  const container = document.getElementById('t-chat-msgs');
  let bannerHtml = a.chatAiEscalated
    ? '<div class="ai-escalation-banner">⚡ <span><strong>Escalated</strong> — User requested human agent. AI is inactive.</span></div>'
    : '';
  container.innerHTML = bannerHtml + a.chat.map(m => renderMsgBubble(m)).join('');
  container.scrollTop = container.scrollHeight;
  document.getElementById('t-chat-input')._key = k;
  document.getElementById('t-chat-input')._isPublic = false;
}

function closeTellerChat(){
  document.getElementById('t-chat-panel').style.display='none';
  tellerViewingAccKey=null;
  pendingChatAction=null;
}

function sendTellerMsg(){
  const inp = document.getElementById('t-chat-input');
  const k = inp._key || tellerViewingAccKey;
  const text = inp.value.trim();
  if(!text||!k) return;

  if(k === '__public__' || inp._isPublic){
    const conv = DB.publicChats[0];
    if(!conv) return;
    conv.messages.push({from:'teller', text, time:ts()});
    // Auto-update status to resolved if it was awaiting
    if(conv.status==='awaiting') conv.status='active';
    inp.value='';
    openTellerPublicChat();
    addAudit(`Teller replied to General Support [${conv.id}]`, 'Teller');
    renderPublicChat(); renderCustPublicChat();
    return;
  }

  const a = DB.accounts[k];
  a.chat.push({from:'teller', text, time:ts()});
  // Auto-status: if awaiting, flip back to active
  if(a.chatStatus==='awaiting') a.chatStatus='active';
  inp.value='';
  openTellerChat(k);
  addAudit(`Teller replied to Account ${k} [${a.chatId}] support chat`, 'Teller');
  if(currentAcc==k){ document.getElementById('sd-notif').style.display=''; renderCustChat(); }
}

// Status quick-set
function tellerSetStatus(newStatus){
  const inp = document.getElementById('t-chat-input');
  const k = inp._key || tellerViewingAccKey;
  if(!k) return;
  if(k==='__public__'||inp._isPublic){
    const conv = DB.publicChats[0];
    if(!conv) return;
    const old = conv.status;
    conv.status = newStatus;
    addAudit(`General Support [${conv.id}] status changed: ${old} → ${newStatus}`, 'Teller');
    openTellerPublicChat();
    renderCustPublicChat();
  } else {
    const a = DB.accounts[k];
    const old = a.chatStatus;
    a.chatStatus = newStatus;
    addAudit(`Account ${k} chat [${a.chatId}] status changed: ${old} → ${newStatus}`, 'Teller');
    openTellerChat(k);
    renderCustChat();
  }
  renderTellerChats();
}

// ================================================================
// CHAT LIFECYCLE — MODALS
// ================================================================

// Called from teller chat panel header (currently open chat)
function openCloseChatModal(){
  const inp = document.getElementById('t-chat-input');
  const k = inp._key || tellerViewingAccKey;
  pendingChatAction = { type:'close', key:k, isPublic: (k==='__public__'||inp._isPublic) };
  openMod('modal-close-chat');
}
function openArchiveChatModal(){
  const inp = document.getElementById('t-chat-input');
  const k = inp._key || tellerViewingAccKey;
  pendingChatAction = { type:'archive', key:k, isPublic: (k==='__public__'||inp._isPublic) };
  openMod('modal-archive-chat');
}
function openDeleteChatModal(){
  const inp = document.getElementById('t-chat-input');
  const k = inp._key || tellerViewingAccKey;
  pendingChatAction = { type:'delete', key:k, isPublic: (k==='__public__'||inp._isPublic) };
  document.getElementById('delete-confirm-input').value='';
  openMod('modal-delete-chat');
}

// Called from inline list buttons
function openCloseChatModalFor(key, isPublic){
  pendingChatAction = { type:'close', key, isPublic };
  openMod('modal-close-chat');
}
function openArchiveChatModalFor(key, isPublic){
  pendingChatAction = { type:'archive', key, isPublic };
  openMod('modal-archive-chat');
}
function openDeleteChatModalFor(key, isPublic){
  pendingChatAction = { type:'delete', key, isPublic };
  document.getElementById('delete-confirm-input').value='';
  openMod('modal-delete-chat');
}

function openMod(id){ document.getElementById(id).classList.add('show'); }

function confirmCloseChat(){
  if(!pendingChatAction) return;
  const reason = document.getElementById('modal-close-reason').value;
  const now = ts();
  if(pendingChatAction.isPublic){
    const conv = DB.publicChats[0];
    const old = conv.status;
    conv.status='closed'; conv.closedAt=now; conv.closureReason=reason;
    addAudit(`General Support [${conv.id}] CLOSED — Reason: ${reason} (was: ${old})`, 'Teller');
    renderPublicChat(); updatePublicChatStatusUi();
    renderCustPublicChat(); updateCustPubChatStatusUi();
  } else {
    const a = DB.accounts[pendingChatAction.key];
    const old = a.chatStatus;
    a.chatStatus='closed'; a.chatClosedAt=now; a.chatClosureReason=reason;
    addAudit(`Account ${pendingChatAction.key} chat [${a.chatId}] CLOSED — Reason: ${reason} (was: ${old})`, 'Teller');
    renderCustChat(); updateCustAccChatStatusUi(pendingChatAction.key);
    if(tellerViewingAccKey===pendingChatAction.key) openTellerChat(pendingChatAction.key);
  }
  renderTellerChats();
  closeMod('modal-close-chat');
  pendingChatAction=null;
}

function confirmArchiveChat(){
  if(!pendingChatAction) return;
  const now = ts();
  if(pendingChatAction.isPublic){
    const conv = DB.publicChats[0];
    const old = conv.status;
    conv.status='archived'; conv.archivedAt=now;
    if(!conv.closedAt){ conv.closedAt=now; }
    addAudit(`General Support [${conv.id}] ARCHIVED (was: ${old})`, 'Teller');
    renderCustPublicChat(); updateCustPubChatStatusUi();
    if(pendingChatAction.key==='__public__') openTellerPublicChat();
  } else {
    const a = DB.accounts[pendingChatAction.key];
    const old = a.chatStatus;
    a.chatStatus='archived'; a.chatArchivedAt=now;
    if(!a.chatClosedAt){ a.chatClosedAt=now; a.chatClosureReason='Archived'; }
    addAudit(`Account ${pendingChatAction.key} chat [${a.chatId}] ARCHIVED (was: ${old})`, 'Teller');
    renderCustChat(); updateCustAccChatStatusUi(pendingChatAction.key);
    if(tellerViewingAccKey===pendingChatAction.key) openTellerChat(pendingChatAction.key);
  }
  renderTellerChats();
  closeMod('modal-archive-chat');
  // Close panel if archived from it
  document.getElementById('t-chat-panel').style.display='none';
  pendingChatAction=null;
}

function confirmDeleteChat(){
  const val = document.getElementById('delete-confirm-input').value.trim();
  if(val !== 'DELETE'){
    document.getElementById('delete-confirm-input').style.borderColor='var(--red)';
    return;
  }
  if(!pendingChatAction) return;
  const now = ts();
  if(pendingChatAction.isPublic){
    const conv = DB.publicChats[0];
    const id = conv.id;
    const msgCount = conv.messages.length;
    // Reset to fresh — "permanently deleted" means we clear it but keep the entry (no actual splice, keeping 1 channel)
    conv.messages = [{ from:'teller', text:'New support session started. Previous transcript permanently deleted.', time:now }];
    conv.status='active'; conv.closedAt=null; conv.archivedAt=null; conv.closureReason=null; conv.openedAt=now;
    addAudit(`⛔ PERMANENT DELETE — General Support [${id}] transcript deleted (${msgCount} messages). Teller action.`, 'Teller');
    renderPublicChat(); renderCustPublicChat(); updateCustPubChatStatusUi();
    document.getElementById('t-chat-panel').style.display='none';
  } else {
    const k = pendingChatAction.key;
    const a = DB.accounts[k];
    const id = a.chatId;
    const msgCount = a.chat.length;
    // Reset chat to fresh session
    const newId = `ACC-${k}-${String(DB.nextChatId++).padStart(3,'0')}`;
    a.chat=[{from:'teller',text:'New support session started. Previous transcript permanently deleted.',time:now}];
    a.chatStatus='active'; a.chatId=newId; a.chatOpenedAt=now; a.chatAiEscalated=false;
    a.chatClosedAt=null; a.chatArchivedAt=null; a.chatClosureReason=null;
    addAudit(`⛔ PERMANENT DELETE — Account ${k} chat [${id}] deleted (${msgCount} messages). New session: [${newId}]`, 'Teller');
    renderCustChat(); updateCustAccChatStatusUi(k);
    document.getElementById('t-chat-panel').style.display='none';
  }
  renderTellerChats();
  closeMod('modal-delete-chat');
  pendingChatAction=null;
}

// ================================================================
// TELLER: PUBLIC CHATS RENDERING (with lifecycle)
// ================================================================
function renderTellerPublicChats() {
  const listEl = document.getElementById('t-pub-chat-list');
  if(!listEl) return;
  if(!DB.publicChats || !DB.publicChats.length) { listEl.innerHTML='<div style="font-size:12px;color:var(--text3);padding:12px 0">No public conversations.</div>'; return; }
  const allPub = DB.publicChats.filter(c => chatMatchesFilter(c.status||'active'));
  const countEl = document.getElementById('t-pub-chat-count');
  if(countEl) countEl.textContent = `(${allPub.length})`;
  if(!allPub.length){
    listEl.innerHTML='<div style="font-size:12px;color:var(--text3);padding:12px 0">No public conversations match this filter.</div>';
    return;
  }
  listEl.innerHTML = allPub.map(conv => {
    const status = conv.status||'active';
    const hasPub = conv.messages.some(m=>m.from==='visitor');
    const last = conv.messages[conv.messages.length-1];
    const preview = last ? esc(last.text.substring(0,72))+(last.text.length>72?'…':'') : 'No messages';
    return `
      <div class="chat-list-item ${status}">
        <div class="cli-header">
          <div>
            <div class="cli-name">General Support Channel</div>
            <div class="cli-meta">${conv.id} · Public</div>
          </div>
          ${chatStatusBadgeHtml(status)}
        </div>
        <div class="cli-preview">${preview}</div>
        <div class="cli-footer">
          <div class="cli-actions">
            <button class="btn btn-ghost btn-sm" onclick="openTellerPublicChat()">View →</button>
            ${status!=='closed'&&status!=='archived'
              ? `<button class="btn btn-amber btn-sm" onclick="openCloseChatModalFor('__public__',true)">Close</button>` : ''}
            ${status!=='archived'
              ? `<button class="btn btn-ghost btn-sm" style="color:var(--text3)" onclick="openArchiveChatModalFor('__public__',true)">Archive</button>` : ''}
            <button class="btn btn-danger btn-sm" onclick="openDeleteChatModalFor('__public__',true)">Delete</button>
          </div>
          <div class="cli-ts">${hasPub?'↩ Visitor message':'·'} ${conv.messages.length} msgs · Opened: ${conv.openedAt||'—'}</div>
        </div>
      </div>`;
  }).join('');
}

function openTellerPublicChat() {
  const conv = DB.publicChats[0];
  if(!conv) return;
  const status = conv.status||'active';
  tellerViewingAccKey = null;
  pendingChatAction = null;

  document.getElementById('t-chat-viewing-name').textContent = 'General Support Channel';
  document.getElementById('t-chat-viewing-acc').textContent = `Public · No account tied · ${conv.id}`;

  const badge = document.getElementById('t-chat-channel-badge');
  if(badge){ badge.textContent='General'; badge.className='teller-chat-channel-badge tcc-public'; }

  const statusEl = document.getElementById('t-chat-status-badge');
  if(statusEl){ statusEl.className='chat-status-badge '+(status==='active'?'cs-active':status==='awaiting'?'cs-awaiting':status==='resolved'?'cs-resolved':status==='closed'?'cs-closed':'cs-archived'); statusEl.textContent=status.charAt(0).toUpperCase()+status.slice(1); }

  document.getElementById('t-chat-id-display').textContent = conv.id;
  document.getElementById('t-chat-opened-at').textContent = conv.openedAt ? 'Opened: '+conv.openedAt : '';

  document.getElementById('t-chat-restrict-notice').style.display='block';
  const closedBanner = document.getElementById('t-chat-closed-banner');
  if(closedBanner) closedBanner.style.display=(status==='closed'||status==='archived')?'block':'none';

  const iaw = document.getElementById('t-chat-iaw');
  if(iaw) iaw.classList.remove('is-closed'); // teller can always reply

  const el_close  = document.getElementById('t-btn-close-chat');
  const el_archive= document.getElementById('t-btn-archive-chat');
  if(el_close)  el_close.style.display  =(status==='closed'||status==='archived')?'none':'';
  if(el_archive)el_archive.style.display=(status==='archived')?'none':'';

  const footer = document.getElementById('t-chat-lifecycle-footer');
  if(footer){
    let info=[];
    if(conv.closedAt) info.push(`Closed: ${conv.closedAt}${conv.closureReason?' — '+conv.closureReason:''}`);
    if(conv.archivedAt) info.push(`Archived: ${conv.archivedAt}`);
    footer.textContent=info.join('  ·  ');
    footer.style.display=info.length?'block':'none';
  }

  document.getElementById('t-chat-panel').style.display='block';
  const container = document.getElementById('t-chat-msgs');
  let escBannerPub = conv.aiEscalated
    ? '<div class="ai-escalation-banner">⚡ <span><strong>Escalated</strong> — User requested human agent. AI is inactive.</span></div>'
    : '';
  container.innerHTML = escBannerPub + conv.messages.map(m => renderMsgBubble(m)).join('');
  container.scrollTop=container.scrollHeight;
  document.getElementById('t-chat-input')._key='__public__';
  document.getElementById('t-chat-input')._isPublic=true;
}

// ================================================================

// ================================================================
// AI CONTROL CENTER — TELLER PANEL
// ================================================================

function renderAIControlCenter() {
  if (!DB.ai) return;
  const s = DB.ai.stats;
  const total = s.totalAnswered + s.totalEscalated;
  const rate = total > 0 ? ((s.totalEscalated / total) * 100).toFixed(0) + '%' : '—';
  const avgMs = s.responseTimes.length > 0
    ? (s.responseTimes.reduce((a,b) => a+b, 0) / s.responseTimes.length).toFixed(0) + 'ms' : '—';
  const faqs = DB.ai.faqs || [];

  const set = (id, val) => { const e = document.getElementById(id); if(e) e.textContent = val; };
  set('ai-stat-answered', s.totalAnswered);
  set('ai-stat-escalated', s.totalEscalated);
  set('ai-stat-unmatched', s.totalUnmatched || 0);
  set('ai-stat-rate', rate);
  set('ai-stat-faqs', faqs.filter(f => f.active).length + ' / ' + faqs.length);
  set('ai-stat-avgms', avgMs);

  const tog = document.getElementById('ai-master-toggle');
  if (tog) tog.checked = DB.ai.enabled;
  const sens = document.getElementById('ai-sensitivity');
  const sensLbl = document.getElementById('ai-sensitivity-label');
  if (sens) sens.value = DB.ai.escalationSensitivity;
  if (sensLbl) { const ll = {1:'Low',2:'Medium',3:'High'}; sensLbl.textContent = ll[DB.ai.escalationSensitivity]||'Medium'; }

  // FAQ list
  const faqWrap = document.getElementById('ai-faq-list-wrap');
  if (faqWrap) {
    if (!faqs.length) {
      faqWrap.innerHTML = '<div style="font-size:12px;color:var(--text3);padding:8px 0">No knowledge base entries. Add your first FAQ above.</div>';
    } else {
      faqWrap.innerHTML = '<div class="sec-label" style="margin-top:0">Knowledge Base (' + faqs.length + ' entries)</div>' +
        faqs.map((f, i) => {
          const statusCls = f.active ? 'cs-active' : 'cs-closed';
          const statusLbl = f.active ? 'Active' : 'Inactive';
          return '<div class="ai-faq-item" style="flex-direction:column;gap:8px;padding:12px">' +
            '<div style="display:flex;justify-content:space-between;align-items:center">' +
              '<div>' +
                '<span style="font-size:13px;font-weight:600;color:var(--text)">' + esc(f.title) + '</span> ' +
                '<span class="chat-status-badge ' + statusCls + '" style="font-size:10px">' + statusLbl + '</span>' +
                (f.escalationRequired ? ' <span class="badge b-amber" style="font-size:10px">Escalates</span>' : '') +
                (f.hitCount ? ' <span style="font-size:10px;color:var(--text3);margin-left:4px">× ' + f.hitCount + ' hits</span>' : '') +
              '</div>' +
              '<div style="display:flex;gap:6px">' +
                '<button class="btn btn-ghost btn-sm" onclick="toggleFaqActive(' + i + ')" style="font-size:10px">' + (f.active ? 'Deactivate' : 'Activate') + '</button>' +
                '<button class="btn btn-danger btn-sm" onclick="removeFaqEntry(' + i + ')" style="font-size:10px">✕</button>' +
              '</div>' +
            '</div>' +
            '<div style="font-size:11px;color:var(--text3)">' +
              '<span style="color:var(--green2)">Keywords:</span> ' + esc((f.keywords||[]).join(', ').substring(0, 100)) +
            '</div>' +
            '<div style="font-size:12px;color:var(--text2);border-left:2px solid var(--border2);padding-left:8px">' +
              esc((f.response||'').substring(0,120)) + (f.response && f.response.length > 120 ? '…' : '') +
            '</div>' +
            '<div style="font-size:10px;color:var(--text3)">Category: ' + esc(f.category||'general') + '</div>' +
          '</div>';
        }).join('');
    }
  }

  // Most triggered FAQ
  const topFaqEl = document.getElementById('ai-top-faq');
  if (topFaqEl) {
    const withHits = faqs.filter(f => f.hitCount > 0).sort((a,b) => (b.hitCount||0)-(a.hitCount||0));
    if (!withHits.length) {
      topFaqEl.innerHTML = '<div style="font-size:12px;color:var(--text3)">No FAQ triggers recorded yet.</div>';
    } else {
      topFaqEl.innerHTML = withHits.slice(0,5).map(f =>
        '<div class="ai-faq-item">' +
          '<div class="ai-faq-q" style="font-weight:600">' + esc(f.title) + '</div>' +
          '<div class="ai-faq-count">× ' + f.hitCount + '</div>' +
        '</div>'
      ).join('');
    }
  }

  // Unmatched questions
  const unmEl = document.getElementById('ai-unmatched-log');
  if (unmEl) {
    const unm = DB.ai.unmatchedQuestions || [];
    unmEl.innerHTML = !unm.length
      ? '<div style="font-size:12px;color:var(--text3)">No unmatched questions yet.</div>'
      : unm.slice(0, 20).map(u =>
          '<div class="ai-log-row">' +
            '<div class="ai-log-time">' + u.time + '</div>' +
            '<div class="ai-log-channel ' + (u.channel==='account'?'acc':'pub') + '">' + (u.channel==='account'?'Acc':'Pub') + '</div>' +
            '<div class="ai-log-q" style="flex:1">' + esc(u.question) + '</div>' +
          '</div>'
        ).join('');
  }

  // Conversation log
  const logEl = document.getElementById('ai-conv-log');
  if (logEl) {
    logEl.innerHTML = !DB.ai.conversationLogs.length
      ? '<div style="font-size:12px;color:var(--text3)">No conversations logged.</div>'
      : DB.ai.conversationLogs.slice(0, 50).map(l =>
          '<div class="ai-log-row">' +
            '<div class="ai-log-time">' + l.time + '</div>' +
            '<div class="ai-log-channel ' + (l.channel==='account'?'acc':'pub') + '">' + (l.channel==='account'?'Acc':'Pub') + '</div>' +
            '<div class="ai-log-q">' + esc(l.question) + '</div>' +
            '<div class="ai-log-outcome ' + l.outcome + '">' + l.outcome + '</div>' +
          '</div>'
        ).join('');
  }
}

function setAiEnabled(val) {
  DB.ai.enabled = !!val;
  addAudit('AI Assistant ' + (val ? 'ENABLED' : 'DISABLED') + ' by Teller', 'Teller');
  renderAIControlCenter();
}

function setAiSensitivity(val) {
  DB.ai.escalationSensitivity = parseInt(val);
  const labels = {1:'Low',2:'Medium',3:'High'};
  const lbl = document.getElementById('ai-sensitivity-label');
  if (lbl) lbl.textContent = labels[val] || 'Medium';
  addAudit('AI escalation sensitivity set to: ' + (labels[val]||val), 'Teller');
}

function addFaqEntry() {
  const alertEl = document.getElementById('ai-faq-add-alert');
  const title    = ((document.getElementById('ai-faq-title')||{}).value||'').trim();
  const keywords = ((document.getElementById('ai-faq-keywords')||{}).value||'').trim();
  const answer   = ((document.getElementById('ai-faq-answer')||{}).value||'').trim();
  const cat      = (document.getElementById('ai-faq-cat')||{}).value || 'general';
  const escalate = (document.getElementById('ai-faq-escalate')||{}).value === 'yes';

  if (!title)    { showAl(alertEl,'error','Enter a FAQ title.'); return; }
  if (!keywords) { showAl(alertEl,'error','Enter at least one keyword.'); return; }
  if (!answer)   { showAl(alertEl,'error','Enter the official response.'); return; }

  const kwList = keywords.split(',').map(k => k.trim()).filter(Boolean);
  if (!kwList.length) { showAl(alertEl,'error','Enter at least one valid keyword.'); return; }

  DB.ai.faqs = DB.ai.faqs || [];
  DB.ai.faqs.push({
    id: DB.ai.nextFaqId++,
    title, keywords: kwList, response: answer,
    category: cat, escalationRequired: escalate,
    active: true, hitCount: 0,
    createdAt: ts()
  });

  ['ai-faq-title','ai-faq-keywords','ai-faq-answer'].forEach(id => {
    const e = document.getElementById(id); if(e) e.value = '';
  });
  clAl(alertEl);
  addAudit('AI FAQ added: "' + title + '"', 'Teller');
  renderAIControlCenter();
}

function toggleFaqActive(idx) {
  const faqs = DB.ai.faqs || [];
  if (!faqs[idx]) return;
  faqs[idx].active = !faqs[idx].active;
  addAudit('AI FAQ "' + faqs[idx].title + '" ' + (faqs[idx].active ? 'activated' : 'deactivated'), 'Teller');
  renderAIControlCenter();
}

function removeFaqEntry(idx) {
  const faqs = DB.ai.faqs || [];
  if (!faqs[idx]) return;
  if (!confirm('Remove FAQ entry "' + faqs[idx].title + '"? This cannot be undone.')) return;
  const removed = faqs.splice(idx, 1);
  addAudit('AI FAQ removed: "' + ((removed[0]||{}).title||'?') + '"', 'Teller');
  renderAIControlCenter();
}

// Legacy compatibility shims (old function names still wired in some older HTML)
function addCustomFAQ() { addFaqEntry(); }
function removeCustomFAQ(idx) { removeFaqEntry(idx); }

// AUDIT & LOGIN LOGS
// ================================================================
function renderAuditLog(){
  const el = document.getElementById('t-audit-list');
  if(!el) return;
  el.innerHTML = DB.auditLog.length===0
    ? '<div style="color:var(--text3);font-size:12px">No audit events.</div>'
    : DB.auditLog.map(e=>`
        <div class="audit-row">
          <div class="audit-time">${e.time}</div>
          <div class="audit-action">${esc(e.action)}</div>
          <div class="audit-actor">${esc(e.actor)}</div>
        </div>`).join('');
}

function renderLoginLog(){
  const el = document.getElementById('t-login-list');
  if(!el) return;
  el.innerHTML = DB.loginLog.length===0
    ? '<div style="color:var(--text3);font-size:12px">No login attempts recorded.</div>'
    : `<table><thead><tr><th>Time</th><th>Account</th><th>Result</th></tr></thead><tbody>${
        DB.loginLog.map(e=>`
          <tr>
            <td class="mono" style="font-size:11px">${e.time}</td>
            <td class="mono">${esc(String(e.acc))}</td>
            <td><span class="badge ${e.success?'b-green':'b-red'}">${e.success?'Success':'Failed'}</span></td>
          </tr>`).join('')
      }</tbody></table>`;
}

// ================================================================
// TELLER TABS
// ================================================================
function tTab(name, btn){
  document.querySelectorAll('#page-teller .tab-pane').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('#page-teller .snav-item').forEach(b=>b.classList.remove('active'));
  const tpane = document.getElementById('tpane-'+name);
  if(tpane) tpane.classList.add('active'); else console.warn('[Clover] tTab: pane not found:', name);
  if(btn) btn.classList.add('active');
  const titles={overview:'System Overview',accounts:'Account Management',transaction:'Create Transaction',recurring:'Recurring Payments','loans-admin':'Loan Management',generate:'Generate Account',chats:'Support Chats','ai-control':'AI Control Center',audit:'Audit Log',logins:'Login Attempts'};
  document.getElementById('t-topbar-title').textContent = titles[name]||name;
  if(name==='audit') renderAuditLog();
  if(name==='logins') renderLoginLog();
  if(name==='chats') renderTellerChats();
  if(name==='accounts') renderTellerAccounts();
  if(name==='overview') renderTellerSummary();
  if(name==='recurring') renderRecurringList();
  if(name==='loans-admin'){ renderLoansAdmin(); populateTellerSelects(); }
  if(name==='ai-control') renderAIControlCenter();
}

// ================================================================
// INIT
// ================================================================
addAudit('Clover Financial platform initialized — Controlled Economy Mode', 'System');

// ================================================================
// LANDING PAGE ENHANCEMENTS
// ================================================================

// --- Nav scroll shadow ---
window.addEventListener('scroll', function() {
  const nav = document.getElementById('main-nav');
  if(nav) nav.classList.toggle('scrolled', window.scrollY > 20);
}, { passive: true });

// --- Live stats (reads from DB) ---
function updateLandingStats() {
  const accs = Object.values(DB.accounts);
  const totalTx = accs.reduce((s,a) => s + a.transactions.length, 0);
  const totalLoans = accs.flatMap(a => a.loans.filter(l => l.remaining > 0)).length;
  const totalChats = accs.filter(a => a.chat.some(m => m.from === 'customer')).length;

  if(document.getElementById('count-accounts'))    animateCount('count-accounts', accs.length, '');
  if(document.getElementById('count-transactions')) animateCount('count-transactions', totalTx, '');
  if(document.getElementById('count-loans'))        animateCount('count-loans', totalLoans, '');
  if(document.getElementById('count-support'))      animateCount('count-support', totalChats, '');
}

function animateCount(id, target, suffix) {
  const el = document.getElementById(id);
  if(!el) return;
  const duration = 1200;
  const start = Date.now();
  const startVal = 0;
  function step() {
    const elapsed = Date.now() - start;
    const progress = Math.min(elapsed / duration, 1);
    // Ease out
    const eased = 1 - Math.pow(1 - progress, 3);
    const current = Math.round(startVal + (target - startVal) * eased);
    el.textContent = current + suffix;
    if(progress < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

// --- Agent availability ---
// Status options: 'online' | 'limited' | 'offline'
// Tellers can change this via a global variable
window.AGENT_STATUS = 'online';

const agentLabels = {
  online:  { text: 'Agents Available',      sub: 'Teller team is active',       cls: 'online' },
  limited: { text: 'Limited Availability',   sub: 'Some agents unavailable',     cls: 'limited' },
  offline: { text: 'Support Offline',        sub: 'Check back shortly',          cls: 'offline' }
};

function renderAgentStatus() {
  const dot  = document.getElementById('agent-dot-indicator');
  const text = document.getElementById('agent-status-text');
  const sub  = document.getElementById('agent-status-sub');
  if(!dot && !text) return;
  const s = agentLabels[window.AGENT_STATUS] || agentLabels.online;
  dot.className = 'agent-dot ' + s.cls;
  text.className = 'agent-status-text ' + s.cls;
  text.textContent = s.text;
  if(sub) sub.textContent = s.sub;
}

// showPage already handles all page-specific logic — no override needed here

// Initial run
updateLandingStats();
renderAgentStatus();

window.setAgentStatus = function(status) {
  if(['online','limited','offline'].includes(status)) {
    window.AGENT_STATUS = status;
    renderAgentStatus();
    renderPublicAgentStatus();
    addAudit(`Agent availability set to: ${status}`, 'Teller');
    const disp = document.getElementById('t-agent-status-display');
    const colors = { online: 'var(--green)', limited: 'var(--amber)', offline: 'var(--red)' };
    const labels = { online: 'Online', limited: 'Limited', offline: 'Offline' };
    if(disp){ disp.textContent = labels[status]; disp.style.color = colors[status]; }
  }
};

// ================================================================
// PUBLIC SUPPORT PAGE
// ================================================================
function renderPublicSupportPage() {
  renderPublicAgentStatus();
  renderPublicChat();
  updatePublicChatStatusUi();
}

function renderPublicAgentStatus() {
  const dot  = document.getElementById('pub-agent-dot');
  const text = document.getElementById('pub-agent-text');
  const sub  = document.getElementById('pub-agent-sub');
  const hdr  = document.getElementById('pub-chat-agent-status');
  if(!dot && !text && !hdr) return;
  const s = agentLabels[window.AGENT_STATUS] || agentLabels.online;
  dot.className = 'agent-dot ' + s.cls;
  if(text){ text.className='agent-status-text '+s.cls; text.textContent=s.text; }
  if(sub)  sub.textContent=s.sub;
  if(hdr)  hdr.textContent=s.text;
  // Update AI chip
  const aiChip = document.getElementById('pub-ai-chip');
  if(aiChip) {
    const conv = DB.publicChats[0];
    if(!DB.ai.enabled) { aiChip.textContent='AI Disabled'; aiChip.className='ai-status-chip disabled'; }
    else if(conv && conv.aiEscalated) { aiChip.textContent='Escalated'; aiChip.className='ai-status-chip escalated'; }
    else { aiChip.textContent='AI Active'; aiChip.className='ai-status-chip'; }
  }
}

function renderPublicChat() {
  const conv = DB.publicChats[0];
  const container = document.getElementById('pub-chat-msgs');
  if(!conv || !container) return;
  // Escalation banner
  let bannerHtml = conv.aiEscalated
    ? '<div class="ai-escalation-banner">⚡ <span><strong>Escalated to Human Agent</strong> — A teller will join this conversation shortly. The AI assistant has stepped back.</span></div>'
    : '';
  container.innerHTML = bannerHtml + conv.messages.map(m => renderMsgBubble(m)).join('');
  container.scrollTop = container.scrollHeight;
}

function updatePublicChatStatusUi() {
  const conv = DB.publicChats[0];
  if(!conv) return;
  const status = conv.status||'active';
  const badge = document.getElementById('pub-chat-status-badge');
  if(badge){
    const map={active:'cs-active',awaiting:'cs-awaiting',resolved:'cs-resolved',closed:'cs-closed',archived:'cs-archived'};
    const labels={active:'Active',awaiting:'Awaiting Response',resolved:'Resolved',closed:'Closed',archived:'Archived'};
    badge.className='chat-status-badge '+(map[status]||'cs-active');
    badge.textContent=labels[status]||status;
  }
  const idEl=document.getElementById('pub-chat-id-display');
  if(idEl) idEl.textContent=`Session: ${conv.id} · No account required · All messages logged`;
  const iaw = document.getElementById('pub-chat-iaw');
  if(iaw) iaw.classList.toggle('is-closed', status==='closed'||status==='archived');
  const endBtn = document.getElementById('pub-btn-end-session');
  if(endBtn) endBtn.style.display=(status==='closed'||status==='archived')?'none':'';
}

function sendPublicMsg() {
  const conv = DB.publicChats[0];
  if(!conv) return;
  if(conv.status==='closed'||conv.status==='archived') return;
  const inp = document.getElementById('pub-chat-input');
  const text = inp.value.trim();
  if(!text) return;
  conv.messages.push({ from:'visitor', text, time:ts() });
  if(conv.status==='active') conv.status='awaiting';
  inp.value='';
  renderPublicChat();
  updatePublicChatStatusUi();
  addAudit(`Public support message received [${conv.id}]`, 'Public Visitor');
  renderTellerPublicChats();

  // AI response — only if not escalated and AI enabled
  if(!conv.aiEscalated && DB.ai.enabled) {
    const container = document.getElementById('pub-chat-msgs');
    const aiResp = aiRespond(text, 'public', { isLoggedIn:false });
    if(aiResp) {
      _deliverAiReply(container, aiResp, (resp) => {
        const msg = {from:'ai', text:resp.text, time:ts(), quickBtns:resp.quickBtns, _channel:'public', _key:''};
        conv.messages.push(msg);
        renderPublicChat();
        renderCustPublicChat();
        renderTellerPublicChats();
        if(resp.escalate) aiUserEscalate('public','');
        else { conv.status='active'; updatePublicChatStatusUi(); }
      });
    }
  } else {
    // Escalated — notify teller
    const notif = document.getElementById('t-notif');
    if(notif) notif.style.display='';
  }
}

// Visitor voluntarily ends session
function pubVisitorEndSession() {
  const conv = DB.publicChats[0];
  if(!conv) return;
  if(conv.status==='closed'||conv.status==='archived') return;
  const now = ts();
  conv.status='closed'; conv.closedAt=now; conv.closureReason='Visitor ended session';
  conv.messages.push({from:'teller',text:'Session ended by visitor. Thank you for contacting Clover Financial.',time:now});
  addAudit(`General Support [${conv.id}] — visitor ended session`, 'Public Visitor');
  renderPublicChat();
  updatePublicChatStatusUi();
  renderTellerPublicChats();
}

// Visitor starts a new public session
function pubStartNewSession() {
  const now = ts();
  const newId = 'PUB-' + String(DB.nextChatId++).padStart(3,'0');
  // Archive old session if exists
  const old = DB.publicChats[0];
  if(old && old.status !== 'archived') { old.status='archived'; old.archivedAt=now; }
  DB.publicChats.unshift({
    id: newId, label:'General Support', status:'active',
    openedAt:now, closedAt:null, archivedAt:null, closureReason:null,
    messages:[{from:'ai', text:"Welcome to Clover Financial Support. I'm the Clover AI Assistant. How can I assist you today?", time:now}],
    aiEscalated: false
  });
  addAudit(`New public support session created [${newId}]`, 'Public Visitor');
  renderPublicChat(); updatePublicChatStatusUi();
  renderTellerPublicChats();
}

// ================================================================
// DASHBOARD: SUPPORT CHANNEL SWITCHING
// ================================================================
let activeSupportChannel = 'account';

function switchSupportChannel(channel) {
  activeSupportChannel = channel;
  document.getElementById('sct-account-btn').classList.toggle('active', channel==='account');
  document.getElementById('sct-public-btn').classList.toggle('active', channel==='public');
  document.getElementById('support-channel-account').classList.toggle('active', channel==='account');
  document.getElementById('support-channel-public').classList.toggle('active', channel==='public');
  if(channel==='account') renderCustChat();
  else renderCustPublicChat();
}

function renderCustPublicChat() {
  const conv = DB.publicChats[0];
  const container = document.getElementById('c-pub-chat-msgs');
  if(!conv || !container) return;
  let bannerHtml = conv.aiEscalated
    ? '<div class="ai-escalation-banner">⚡ <span><strong>Escalated to Human Agent</strong> — A teller will join shortly.</span></div>'
    : '';
  container.innerHTML = bannerHtml + conv.messages.map(m => renderMsgBubble(m)).join('');
  container.scrollTop = container.scrollHeight;
  updateCustPubChatStatusUi();
}

function updateCustPubChatStatusUi() {
  const conv = DB.publicChats[0];
  if(!conv) return;
  const status = conv.status||'active';
  const badge = document.getElementById('c-pub-chat-status-badge');
  if(badge){
    const map={active:'cs-active',awaiting:'cs-awaiting',resolved:'cs-resolved',closed:'cs-closed',archived:'cs-archived'};
    const labels={active:'Active',awaiting:'Awaiting Response',resolved:'Resolved',closed:'Closed',archived:'Archived'};
    badge.className='chat-status-badge '+(map[status]||'cs-active');
    badge.textContent=labels[status]||status;
  }
  const isClosed = status==='closed'||status==='archived';
  const iaw = document.getElementById('c-pub-chat-iaw');
  if(iaw) iaw.classList.toggle('is-closed', isClosed);
  const newWrap = document.getElementById('c-pub-new-chat-wrap');
  if(newWrap) newWrap.style.display = isClosed ? 'block' : 'none';
  const endBtn = document.getElementById('c-btn-end-pub-chat');
  if(endBtn) endBtn.style.display = isClosed ? 'none' : '';
}

function sendCustPubMsg() {
  const conv = DB.publicChats[0];
  if(!conv) return;
  if(conv.status==='closed'||conv.status==='archived') return;
  const inp = document.getElementById('c-pub-chat-input');
  const text = inp.value.trim();
  if(!text) return;
  conv.messages.push({ from:'visitor', text, time:ts() });
  if(conv.status==='active') conv.status='awaiting';
  inp.value='';
  renderCustPublicChat();
  renderTellerPublicChats();
  addAudit(`General support message from member dashboard [${conv.id}]`, 'Account '+(currentAcc||'?'));

  if(!conv.aiEscalated && DB.ai.enabled) {
    const container = document.getElementById('c-pub-chat-msgs');
    const aiResp = aiRespond(text, 'public', { isLoggedIn:!!currentAcc, accKey:currentAcc });
    if(aiResp) {
      _deliverAiReply(container, aiResp, (resp) => {
        const msg = {from:'ai', text:resp.text, time:ts(), quickBtns:resp.quickBtns, _channel:'public', _key:''};
        conv.messages.push(msg);
        renderCustPublicChat();
        renderPublicChat();
        renderTellerPublicChats();
        if(resp.escalate) aiUserEscalate('public','');
        else { conv.status='active'; updateCustPubChatStatusUi(); }
      });
    }
  } else {
    const notif = document.getElementById('t-notif');
    if(notif) notif.style.display='';
  }
}

function updateCustAccChatStatusUi(k) {
  if(!k && !currentAcc) return;
  const accKey = k || currentAcc;
  if(!DB.accounts[accKey]) return;
  const a = DB.accounts[accKey];
  const status = a.chatStatus||'active';
  const badge = document.getElementById('c-acc-chat-status-badge');
  if(badge){
    const map={active:'cs-active',awaiting:'cs-awaiting',resolved:'cs-resolved',closed:'cs-closed',archived:'cs-archived'};
    const labels={active:'Active',awaiting:'Awaiting Response',resolved:'Resolved',closed:'Closed',archived:'Archived'};
    badge.className='chat-status-badge '+(map[status]||'cs-active');
    badge.textContent=labels[status]||status;
  }
  const isClosed = status==='closed'||status==='archived';
  const iaw = document.getElementById('c-acc-chat-iaw');
  if(iaw) iaw.classList.toggle('is-closed', isClosed);
  const newWrap = document.getElementById('c-acc-new-chat-wrap');
  if(newWrap) newWrap.style.display = isClosed ? 'block' : 'none';
  const endBtn = document.getElementById('c-btn-end-acc-chat');
  if(endBtn) endBtn.style.display = isClosed ? 'none' : '';
}

// Customer voluntarily ends account chat session
function custEndAccChat() {
  if(!currentAcc) return;
  const a = DB.accounts[currentAcc];
  if(a.chatStatus==='closed'||a.chatStatus==='archived') return;
  const now = ts();
  a.chatStatus='closed'; a.chatClosedAt=now; a.chatClosureReason='Customer ended session';
  a.chat.push({from:'teller',text:'Session ended. Thank you for contacting Clover Financial Account Assistance.',time:now});
  addAudit(`Account ${currentAcc} chat [${a.chatId}] — customer ended session`, 'Account '+currentAcc);
  renderCustChat(); updateCustAccChatStatusUi(currentAcc);
  renderTellerChats();
}

// Customer starts new account chat session
function custStartNewAccChat() {
  if(!currentAcc) return;
  const now = ts();
  const a = DB.accounts[currentAcc];
  const oldId = a.chatId;
  const newId = `ACC-${currentAcc}-${String(DB.nextChatId++).padStart(3,'0')}`;
  a.chat=[{from:'ai', text:"New support session started. I'm the Clover AI Assistant. How can I assist you today?", time:now}]; a.chatAiEscalated=false;
  a.chatStatus='active'; a.chatId=newId; a.chatOpenedAt=now;
  a.chatClosedAt=null; a.chatArchivedAt=null; a.chatClosureReason=null;
  addAudit(`Account ${currentAcc} — new chat session [${newId}] opened (replaced [${oldId}])`, 'Account '+currentAcc);
  renderCustChat(); updateCustAccChatStatusUi(currentAcc);
  renderTellerChats();
}

// Customer ends public chat from dashboard
function custEndPubChat() {
  const conv = DB.publicChats[0];
  if(!conv) return;
  if(conv.status==='closed'||conv.status==='archived') return;
  const now = ts();
  conv.status='closed'; conv.closedAt=now; conv.closureReason='Customer ended session';
  conv.messages.push({from:'teller',text:'Session ended. Thank you for contacting Clover Financial.',time:now});
  addAudit(`General Support [${conv.id}] — customer ended session from dashboard`, 'Account '+(currentAcc||'?'));
  renderCustPublicChat(); updateCustPubChatStatusUi();
  renderTellerPublicChats();
}

// Customer starts new public chat from dashboard
function custStartNewPubChat() {
  pubStartNewSession();
  renderCustPublicChat();
  updateCustPubChatStatusUi();
}

// ================================================================
// CLOVER QOL — REAL-TIME SCHEDULER ENGINE
// Runs every 30s, auto-processes due recurring payments
// ================================================================

let _schedulerInterval = null;
let _recurActivityLog = []; // in-memory log for overview panel

function startScheduler() {
  if (_schedulerInterval) return; // prevent double start
  _schedulerInterval = setInterval(function() {
    runSchedulerTick();
  }, 30000); // check every 30s
  // Run immediately on start too
  runSchedulerTick();
}

function runSchedulerTick() {
  if (!DB || !DB.recurringPayments) return;
  var now = Date.now();
  var anyRan = false;
  var tellerOpen = _isTellerActive(); // cache for this tick

  DB.recurringPayments.forEach(function(r) {
    if (r.status !== 'active') return;
    if (!r.nextDue || now < r.nextDue) return;
    // Guard: already ran this exact nextDue (prevent double deduction on rapid ticks)
    if (r._lastProcessedDue && r._lastProcessedDue === r.nextDue) return;

    if (r.maxOcc > 0 && r.occurrencesRun >= r.maxOcc) {
      r.status = 'completed';
      return;
    }
    const a = DB.accounts[r.accKey];
    if (!a) { r.status = 'completed'; return; }

    const prevNextDue = r.nextDue;
    r._lastProcessedDue = prevNextDue;

    if (a[r.target] >= r.amt) {
      a[r.target] = +(a[r.target] - r.amt).toFixed(2);
      addTx(r.accKey, r.name, -r.amt, r.target, '🔄', r.cat, 'Auto-Recurring');
      r.occurrencesRun++;
      r.lastRun = ts();
      // Rolling: next = this execution + interval (NOT now + interval)
      r.nextDue = prevNextDue + (r.intervalMs || 2592000000);
      if (r.maxOcc > 0 && r.occurrencesRun >= r.maxOcc) r.status = 'completed';
      addAudit('⏱ AUTO Recurring "' + r.name + '" processed: -$' + fmt(r.amt) + ' from Account ' + r.accKey, 'Scheduler');
      _recurActivityLog.unshift({ name: r.name, accKey: r.accKey, amt: r.amt, result: 'success', lastRun: r.lastRun, nextDue: r.nextDue, status: r.status });
      playAlert(1);
    } else {
      r.failedCount = (r.failedCount || 0) + 1;
      r.missedCount = (r.missedCount || 0) + 1;
      r.status = 'failed';
      r.nextDue = prevNextDue + (r.intervalMs || 2592000000);
      if (r.penalty > 0 && a[r.target] >= r.penalty) {
        a[r.target] = +(a[r.target] - r.penalty).toFixed(2);
        addTx(r.accKey, r.name + ' — NSF PENALTY', -r.penalty, r.target, '⚠', 'Penalty', 'Auto-Recurring NSF');
        addAudit('⏱ AUTO Recurring "' + r.name + '" FAILED + penalty $' + fmt(r.penalty) + ' on Account ' + r.accKey, 'Scheduler');
      } else {
        addAudit('⏱ AUTO Recurring "' + r.name + '" FAILED — NSF on Account ' + r.accKey, 'Scheduler');
      }
      _recurActivityLog.unshift({ name: r.name, accKey: r.accKey, amt: r.amt, result: 'failed', lastRun: ts(), nextDue: r.nextDue, status: 'failed' });
      addNotification('warn', '⚠ Recurring Payment Failed', '"' + r.name + '" on Account ' + r.accKey + ' — insufficient funds');
      playAlert(2);
    }

    if (_recurActivityLog.length > 100) _recurActivityLog.pop();
    anyRan = true;
    if (currentAcc == r.accKey) renderCust();
  });

  if (anyRan) {
    renderRecurringList();
    renderTellerSummary();
    renderRecurActivityLog();
  }
  updateStatusBar();
  checkEscalationTimeouts();
}

function renderRecurActivityLog() {
  const el = document.getElementById('t-recur-activity-log');
  if (!el) return;
  if (!_recurActivityLog.length) {
    el.innerHTML = '<div style="font-size:12px;color:var(--text3)">No automatic executions yet.</div>';
    return;
  }
  el.innerHTML = '<div class="recur-log-row recur-log-hdr"><span>PAYMENT</span><span>ACCOUNT</span><span>AMOUNT</span><span>LAST RUN</span><span>STATUS</span><span>RESULT</span></div>' +
    _recurActivityLog.slice(0, 20).map(function(r) {
      const resStyle = r.result === 'success' ? 'color:var(--green2)' : 'color:var(--red)';
      const resLabel = r.result === 'success' ? '✓ Success' : '✗ Failed';
      return '<div class="recur-log-row">' +
        '<span style="font-weight:600">' + esc(r.name) + '</span>' +
        '<span class="mono">' + r.accKey + '</span>' +
        '<span style="color:var(--amber)">$' + fmt(r.amt) + '</span>' +
        '<span style="color:var(--text3)">' + esc(r.lastRun || '—') + '</span>' +
        '<span>' + recurBadge(r.status || 'active') + '</span>' +
        '<span style="font-weight:600;' + resStyle + '">' + resLabel + '</span>' +
      '</div>';
    }).join('');
}

// ================================================================
// LIVE STATUS BAR
// ================================================================

function updateStatusBar() {
  const rp = DB.recurringPayments || [];
  const accs = Object.values(DB.accounts || {});
  const activeRecur = rp.filter(function(r){ return r.status==='active'; }).length;
  const failedRecur = rp.filter(function(r){ return r.status==='failed'; }).length;
  const flaggedAccs = accs.filter(function(a){ return a.flagged||a.frozen; }).length;
  const activeChats = accs.filter(function(a){ return a.chatStatus==='awaiting'||a.chatStatus==='active'; }).length
    + (DB.publicChats||[]).filter(function(c){ return c.status==='awaiting'||c.status==='active'; }).length;

  const setEl = function(id, val) { var e=document.getElementById(id); if(e) e.textContent=val; };
  setEl('tsb-active-recur', activeRecur);
  setEl('tsb-failed-recur', failedRecur);
  setEl('tsb-flagged', flaggedAccs);
  setEl('tsb-chats', activeChats);

  const dot = document.getElementById('tsb-dot');
  const label = document.getElementById('tsb-label');
  if (failedRecur > 0 || flaggedAccs > 3) {
    if (dot) { dot.className='tsb-dot crit'; }
    if (label) label.textContent = '⚠ Critical Alerts';
  } else if (failedRecur > 0 || flaggedAccs > 0) {
    if (dot) dot.className = 'tsb-dot warn';
    if (label) label.textContent = '⚡ Warnings';
  } else {
    if (dot) dot.className = 'tsb-dot';
    if (label) label.textContent = 'System Active';
  }

  // Next execution display
  const active = rp.filter(function(r){ return r.status==='active' && r.nextDue; });
  const nextExec = active.length ? Math.min.apply(null, active.map(function(r){ return r.nextDue; })) : null;
  const nextEl = document.getElementById('t-next-execution-display');
  if (nextEl) {
    nextEl.textContent = nextExec ? 'Next execution: ' + fmtNextDue(nextExec) : '';
  }
}

// ================================================================
// NOTIFICATION SYSTEM
// ================================================================

let _notifications = [];

function addNotification(type, title, sub, action) {
  _notifications.unshift({ type: type||'info', title: title, sub: sub||'', action: action||null, ts: Date.now() });
  if (_notifications.length > 50) _notifications.pop();
  renderNotifications();
}

function renderNotifications() {
  const countEl = document.getElementById('t-notif-count');
  const badgeEl = document.getElementById('t-notif-count');
  const list = document.getElementById('tnd-list');
  const hdrCount = document.getElementById('tnd-count');
  const n = _notifications.length;

  if (countEl) { countEl.textContent = n; countEl.style.display = n > 0 ? '' : 'none'; }
  if (hdrCount) hdrCount.textContent = n;

  if (list) {
    if (!n) {
      list.innerHTML = '<div style="padding:12px;font-size:12px;color:var(--text3)">No notifications.</div>';
    } else {
      list.innerHTML = _notifications.slice(0, 30).map(function(notif) {
        return '<div class="tnd-item tnd-' + notif.type + '">' +
          '<div class="tnd-item-title">' + esc(notif.title) + '</div>' +
          '<div class="tnd-item-sub">' + esc(notif.sub) + '</div>' +
        '</div>';
      }).join('');
    }
  }
}

function toggleNotifDropdown() {
  const dd = document.getElementById('t-notif-dropdown');
  if (dd) dd.style.display = dd.style.display === 'none' ? '' : 'none';
}

function clearAllNotifs() {
  _notifications = [];
  renderNotifications();
  const dd = document.getElementById('t-notif-dropdown');
  if (dd) dd.style.display = 'none';
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
  const wrap = document.getElementById('t-notif-bell-wrap');
  if (wrap && !wrap.contains(e.target)) {
    const dd = document.getElementById('t-notif-dropdown');
    if (dd) dd.style.display = 'none';
  }
  // Also close search results
  const searchWrap = document.querySelector('.t-global-search-wrap');
  if (searchWrap && !searchWrap.contains(e.target)) {
    const sr = document.getElementById('t-search-results');
    if (sr) sr.style.display = 'none';
  }
});

// ================================================================
// CLOVER AUDIO ALERT SYSTEM v4
// ROLE-SCOPED · SESSION-AWARE · PREMIUM ADSR ENGINE
//
// ISOLATION RULES:
//   • Sounds ONLY play when page-teller is the active page
//   • _isTellerActive() guard on every public-facing call
//   • testAlertSafe() also enforces role guard + 2s test cooldown
//   • No global window-level playback for non-teller roles
//   • Scheduler/escalation checks bail out when teller is inactive
// ================================================================

var _audioCtx       = null;
var _lastAlertTime  = {};    // level → ms — live alert cooldown
var _testCooldown   = {};    // level → ms — test-button cooldown (2s)
var _tellerPageActive = false; // true only while page-teller is visible

// ----------------------------------------------------------------
// _isTellerActive — single source of truth for role guard
// Returns true only when the teller page is currently displayed.
// All audio entry points call this first.
// ----------------------------------------------------------------
function _isTellerActive() {
  var p = document.getElementById('page-teller');
  return !!(p && p.classList.contains('active'));
}

// ----------------------------------------------------------------
// Hook into showPage to track teller session state.
// When teller navigates away: mark inactive (sounds stop firing).
// When teller page opens: mark active.
// This runs ONCE after showPage is defined.
// ----------------------------------------------------------------
(function _hookTellerSession() {
  var _origShowPage = window.showPage;
  window.showPage = function(id) {
    _origShowPage(id);
    _tellerPageActive = (id === 'page-teller');
    if (id !== 'page-teller') {
      // Teller navigated away — reset live alert cooldowns so they
      // fire fresh next time teller returns, but don't stack audio.
      _lastAlertTime = {};
    }
  };
})();

// ----------------------------------------------------------------
// AudioContext — lazy init, unlocked on first user gesture.
// Single context reused for lifetime of page (no memory leak).
// ----------------------------------------------------------------
(function _initAudioUnlock() {
  var _unlocked = false;
  function _unlock() {
    if (_unlocked) return;
    _unlocked = true;
    if (_audioCtx && _audioCtx.state === 'suspended') _audioCtx.resume();
    ['click','keydown','touchstart'].forEach(function(e) {
      document.removeEventListener(e, _unlock);
    });
  }
  ['click','keydown','touchstart'].forEach(function(e) {
    document.addEventListener(e, _unlock, { passive: true });
  });
})();

function getAudioCtx() {
  if (!_audioCtx) {
    try { _audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    catch(e) { _audioCtx = null; }
  }
  return _audioCtx;
}

// ================================================================
// CLOVER PREMIUM AUDIO ENGINE v3
// Full ADSR envelope per voice, harmonic stacking, stereo width,
// sub-bass layer for L3, pitch-climb rhythm for L3 urgency.
// ================================================================

// ----------------------------------------------------------------
// _voice — renders one oscillator voice into a destination node.
// t = {
//   freq, wave, delay, attack, hold, release, amp,
//   detune,                            // cents offset
//   harmRatio, harmAmp,                // harmonic overtone
//   shimmer, shimmerAmp,               // airy detuned octave
//   pan                                // L/R pan -1..1
// }
// ----------------------------------------------------------------
function _voice(ctx, dest, t, defaultWave) {
  var wave  = t.wave  || defaultWave || 'sine';
  var start = ctx.currentTime + (t.delay   || 0);
  var atk   = t.attack  !== undefined ? t.attack  : 0.015;
  var hold  = t.hold    !== undefined ? t.hold    : 0;
  var rel   = t.release !== undefined ? t.release : 0.3;
  var amp   = t.amp     !== undefined ? t.amp     : 1.0;
  var end   = start + atk + hold + rel;
  var buf   = end + 0.06; // safety buffer before stop()

  // Optional stereo pan
  var output = dest;
  if (t.pan !== undefined && ctx.createStereoPanner) {
    var panner = ctx.createStereoPanner();
    panner.pan.value = Math.max(-1, Math.min(1, t.pan));
    panner.connect(dest);
    output = panner;
  }

  function makeOsc(freq, wave, detune) {
    var o = ctx.createOscillator();
    o.type = wave;
    o.frequency.value = freq;
    if (detune) o.detune.value = detune;
    return o;
  }

  function scheduleGain(gainNode, peakAmp) {
    gainNode.gain.setValueAtTime(0.0001, start);
    gainNode.gain.linearRampToValueAtTime(peakAmp, start + atk);
    if (hold > 0) gainNode.gain.setValueAtTime(peakAmp, start + atk + hold);
    gainNode.gain.exponentialRampToValueAtTime(0.0001, end);
  }

  // -- primary --
  var osc  = makeOsc(t.freq, wave, t.detune || 0);
  var gain = ctx.createGain();
  osc.connect(gain); gain.connect(output);
  scheduleGain(gain, amp);
  osc.start(start); osc.stop(buf);

  // -- harmonic overtone (warmth / body) --
  if (t.harmRatio && t.harmAmp) {
    var osc2  = makeOsc(t.freq * t.harmRatio, 'sine', 0);
    var gain2 = ctx.createGain();
    osc2.connect(gain2); gain2.connect(output);
    gain2.gain.setValueAtTime(0.0001, start);
    gain2.gain.linearRampToValueAtTime(t.harmAmp * amp, start + atk + 0.01);
    gain2.gain.exponentialRampToValueAtTime(0.0001, end * 0.82); // fades sooner
    osc2.start(start); osc2.stop(buf);
  }

  // -- shimmer (ultra-soft detuned octave — chorus/air) --
  if (t.shimmer) {
    var sAmp  = (t.shimmerAmp || 0.10) * amp;
    var osc3  = makeOsc(t.freq * 2, 'sine', 5); // +5 cents — subtle beating
    var gain3 = ctx.createGain();
    osc3.connect(gain3); gain3.connect(output);
    gain3.gain.setValueAtTime(0.0001, start + atk * 0.6);
    gain3.gain.linearRampToValueAtTime(sAmp, start + atk + 0.03);
    gain3.gain.exponentialRampToValueAtTime(0.0001, end * 0.68);
    osc3.start(start + atk * 0.6); osc3.stop(buf);
  }
}

// ----------------------------------------------------------------
// _renderTones — builds master gain + optional signal chain,
// then dispatches all voices in the profile.
//
// chain: 'warm'  → lowpass 4800Hz  (L1 silky)
//        'crisp' → lowpass 7000Hz  (L2 defined)
//        false   → direct (L3 raw)
// ----------------------------------------------------------------
function _renderTones(tones, vol, waveform, chain) {
  var ctx = getAudioCtx();
  if (!ctx) return;
  if (ctx.state === 'suspended') ctx.resume();

  var master = ctx.createGain();
  master.gain.value = Math.min(1.0, Math.max(0.0001, vol));

  if (chain === 'warm' || chain === 'crisp') {
    var lpf = ctx.createBiquadFilter();
    lpf.type = 'lowpass';
    lpf.frequency.value = chain === 'warm' ? 4800 : 7000;
    lpf.Q.value = 0.4;
    master.connect(lpf);
    lpf.connect(ctx.destination);
  } else {
    master.connect(ctx.destination);
  }

  tones.forEach(function(t) { _voice(ctx, master, t, waveform); });
}

// ----------------------------------------------------------------
// ALERT PROFILES v3
// ----------------------------------------------------------------
var _alertProfiles = {

  // ═══════════════════════════════════════════════════════════════
  // LEVEL 1 — True Silky Premium Glass Chime
  // Texture: crystal tap · luxury fintech · modern minimal
  //
  // Architecture:
  //   Voice A — A5 (880Hz): primary bell body
  //             60ms attack, 60ms hold, 700ms airy release
  //             Octave harmonic (×2) for bell warmth
  //             Shimmer layer for crystal air
  //             Slight left pan for width
  //
  //   Voice B — C#6 (1108Hz): harmonic bloom, enters at 200ms
  //             as Voice A decays — feels like resonance, not echo
  //             40ms attack, 500ms release
  //             Shimmer layer
  //             Slight right pan for stereo field
  //
  // Routed through warm lowpass (4800Hz) — removes any harshness
  // Total perceived length: ~1.3 seconds
  // ═══════════════════════════════════════════════════════════════
  1: {
    vol: 0.30,
    waveform: 'sine',
    chain: 'warm',
    tones: [
      {
        freq: 880,         // A5 — round, warm bell fundamental
        delay: 0.00,
        attack: 0.060,     // 60ms soft fade-in — no click whatsoever
        hold:  0.06,       // brief sustain — bell body
        release: 0.70,     // long airy tail — luxury feel
        amp: 1.0,
        harmRatio: 2.0,    // octave above — crystal ring overtone
        harmAmp: 0.20,
        shimmer: true,     // airy chorus sparkle
        shimmerAmp: 0.09,
        pan: -0.25         // soft left — stereo width
      },
      {
        freq: 1108,        // C#6 — major third, harmonic bloom
        delay: 0.20,       // enters as first tone starts to decay
        attack: 0.040,
        hold:  0.03,
        release: 0.55,     // overlapping airy tail
        amp: 0.68,         // softer — felt as resonance not ping
        harmRatio: 2.0,
        harmAmp: 0.13,
        shimmer: true,
        shimmerAmp: 0.07,
        pan: 0.25          // soft right — widens the image
      }
    ]
  },

  // ═══════════════════════════════════════════════════════════════
  // LEVEL 2 — Premium Serious Alert
  // Texture: refined system alert · focused · present · grounded
  //
  // Architecture:
  //   Lower base frequency than L1 (grounded, more weight)
  //   Two-note ascending pattern with controlled gap:
  //
  //   Voice A — F5 (698Hz): low-grounded first tone
  //             Triangle wave: bright but smooth (no square clipping)
  //             20ms attack, 500ms release — serious presence
  //             Perfect fifth harmonic (×1.5) adds authority
  //
  //   Voice B — A5 (880Hz): ascending second note, enters at 380ms
  //             30ms attack, 500ms release
  //             Creates "attention ↗" psychological cue
  //
  // Routed through crisp lowpass (7000Hz) — stays clean, not muddy
  // Total perceived length: ~1.4 seconds
  // ═══════════════════════════════════════════════════════════════
  2: {
    vol: 0.50,
    waveform: 'triangle',
    chain: 'crisp',
    tones: [
      {
        freq: 698,         // F5 — lower, grounded, more serious than L1
        delay: 0.00,
        attack: 0.020,     // faster than L1 — more assertive
        hold:  0.07,
        release: 0.50,
        amp: 1.0,
        wave: 'triangle',  // clean brightness, no clipping harmonics
        harmRatio: 1.5,    // perfect fifth — adds weight and authority
        harmAmp: 0.24,
        pan: -0.20
      },
      {
        freq: 880,         // A5 — ascending perfect third above F5
        delay: 0.38,       // arrives after brief pause — two-note cue
        attack: 0.025,
        hold:  0.05,
        release: 0.50,
        amp: 0.88,
        wave: 'triangle',
        harmRatio: 2.0,    // octave shimmer — lifts the tone slightly
        harmAmp: 0.15,
        shimmer: true,
        shimmerAmp: 0.06,
        pan: 0.20
      }
    ]
  },

  // ═══════════════════════════════════════════════════════════════
  // LEVEL 3 — True Critical Alert System
  // Texture: command center · immediate action required
  //
  // Architecture: RHYTHM + PITCH CLIMB + LAYERING
  //
  // Three bursts in ascending pitch — psychological urgency curve:
  //   Burst 1 @ 0ms    — 1400Hz mid-high (strong punch)
  //   Burst 2 @ 350ms  — 1760Hz higher   (escalating)
  //   Burst 3 @ 680ms  — 2093Hz peak     (final demand)
  //
  // Each burst = two rapid square hits (2 voices, 50ms apart)
  // for percussive "double-knock" feel.
  //
  // Sub-bass layer: 80Hz sine pulse under each burst —
  // creates physical rumble sensation on speakers/headphones.
  //
  // High-frequency layer: 3500Hz sawtooth above each burst —
  // cuts through any ambient sound, impossible to miss.
  //
  // NO lowpass — raw signal for maximum urgency cut-through.
  // Total length: ~1.7 seconds
  // ═══════════════════════════════════════════════════════════════
  3: {
    vol: 0.90,
    waveform: 'square',
    chain: false,
    tones: [
      // ── BURST 1 @ 1400Hz ──────────────────────────────────────
      { freq: 1400, delay: 0.000, attack: 0.003, hold: 0, release: 0.08, amp: 1.00, wave: 'square'   },
      { freq: 1400, delay: 0.055, attack: 0.003, hold: 0, release: 0.07, amp: 0.90, wave: 'square'   },
      // sub-bass rumble under burst 1
      { freq: 80,   delay: 0.000, attack: 0.005, hold: 0, release: 0.18, amp: 0.35, wave: 'sine'     },
      // piercing high layer over burst 1
      { freq: 3500, delay: 0.010, attack: 0.003, hold: 0, release: 0.06, amp: 0.28, wave: 'sawtooth' },

      // ── BURST 2 @ 1760Hz (higher — escalating) ───────────────
      { freq: 1760, delay: 0.350, attack: 0.003, hold: 0, release: 0.09, amp: 1.00, wave: 'square'   },
      { freq: 1760, delay: 0.410, attack: 0.003, hold: 0, release: 0.08, amp: 0.92, wave: 'square'   },
      // sub-bass rumble under burst 2
      { freq: 80,   delay: 0.350, attack: 0.005, hold: 0, release: 0.18, amp: 0.32, wave: 'sine'     },
      // piercing high over burst 2
      { freq: 3500, delay: 0.360, attack: 0.003, hold: 0, release: 0.07, amp: 0.26, wave: 'sawtooth' },

      // ── BURST 3 @ 2093Hz (peak — final demand) ───────────────
      { freq: 2093, delay: 0.680, attack: 0.003, hold: 0, release: 0.10, amp: 1.00, wave: 'square'   },
      { freq: 2093, delay: 0.745, attack: 0.003, hold: 0, release: 0.10, amp: 0.95, wave: 'square'   },
      // sub-bass under final burst
      { freq: 80,   delay: 0.680, attack: 0.005, hold: 0, release: 0.22, amp: 0.30, wave: 'sine'     },
      // aggressive high termination spike
      { freq: 3800, delay: 0.690, attack: 0.002, hold: 0, release: 0.08, amp: 0.30, wave: 'sawtooth' }
    ]
  }
};

// ----------------------------------------------------------------
// playAlert — live system alert
// Guards: role check → mute → criticalOnly → soundEnabled → cooldown
// NEVER fires for non-teller sessions.
// ----------------------------------------------------------------
function playAlert(level) {
  // ── ROLE GUARD — abort immediately if teller panel is not active ──
  if (!_isTellerActive()) return;

  var n = DB.notifications || {};
  if (n.muted) return;
  if (n.criticalOnly && level < 3) return;
  if (n.soundEnabled === false && level < 3) return;

  // ── COOLDOWN: L1/L2 → 10s, L3 → 20s ─────────────────────────────
  var now      = Date.now();
  var cooldown = level === 3 ? 20000 : 10000;
  if (_lastAlertTime[level] && now - _lastAlertTime[level] < cooldown) return;
  _lastAlertTime[level] = now;

  var profile  = _alertProfiles[level] || _alertProfiles[1];
  var userVol  = (n.volume !== undefined ? n.volume : 0.7);
  var finalVol = level === 3
    ? Math.min(1.0, profile.vol * userVol * 1.15)
    : profile.vol * userVol;

  _renderTones(profile.tones, finalVol, profile.waveform, profile.chain);

  if (level === 3) _flashCriticalVisual();
}

// ----------------------------------------------------------------
// testAlertSafe — test-button only
// Guards: role check → mute → 2s per-level test cooldown
// Does NOT trigger visual effects, logs, or escalation logic.
// Does NOT advance the live alert cooldown timer.
// ----------------------------------------------------------------
function testAlertSafe(level) {
  // ── ROLE GUARD ────────────────────────────────────────────────────
  if (!_isTellerActive()) return;

  var n = DB.notifications || {};
  if (n.muted) return;

  // ── 2-SECOND TEST COOLDOWN (prevents button spam) ─────────────────
  var now = Date.now();
  if (_testCooldown[level] && now - _testCooldown[level] < 2000) return;
  _testCooldown[level] = now;

  var profile  = _alertProfiles[level] || _alertProfiles[1];
  var userVol  = (n.volume !== undefined ? n.volume : 0.7);
  var finalVol = level === 3
    ? Math.min(1.0, profile.vol * userVol * 1.15)
    : profile.vol * userVol;

  _renderTones(profile.tones, finalVol, profile.waveform, profile.chain);
  // no visual flash, no log, no cooldown update on _lastAlertTime
}

// Backward-compat alias
function testAlert(level) { testAlertSafe(level); }

// ----------------------------------------------------------------
// Critical visual flash — status bar + notification bell
// ----------------------------------------------------------------
var _critFlashTimer = null;
function _flashCriticalVisual() {
  if (_critFlashTimer) { clearTimeout(_critFlashTimer); }
  // Flash status bar red
  var bar = document.getElementById('t-status-bar');
  var bell = document.getElementById('t-notif-bell-btn');
  if (bar) {
    bar.style.background = 'rgba(255,77,77,0.18)';
    bar.style.borderBottomColor = 'var(--red)';
  }
  if (bell) {
    bell.style.animation = 'notif-bell-shake 0.4s ease';
  }
  _critFlashTimer = setTimeout(function() {
    if (bar) { bar.style.background = ''; bar.style.borderBottomColor = ''; }
    if (bell) bell.style.animation = '';
  }, 1200);
}

// ================================================================
// ESCALATION TIMEOUT MONITOR — 3-stage reinforcement
// Stage 0: immediate L1 on escalation (in aiUserEscalate hook)
// Stage 2: L2 reminder at threshold1 minutes
// Stage 3a: L3 critical at threshold2 minutes
// Stage 3b: ONE additional L3 burst 30s later if still unacknowledged
// ================================================================

function checkEscalationTimeouts() {
  // Only run escalation sound logic when teller panel is active
  if (!_isTellerActive()) return;

  var n = DB.notifications || {};
  var t1 = (n.escalationThreshold1 || 3) * 60 * 1000;
  var t2 = (n.escalationThreshold2 || 8) * 60 * 1000;
  var t3b = t2 + 30000; // critical + 30s secondary burst
  var alertedMap = n.alertedEscalations = n.alertedEscalations || {};
  var now = Date.now();

  function checkConv(conv, label, convKey) {
    // Skip resolved/closed conversations
    if (!conv) return;
    var s = conv.status || conv.chatStatus || 'active';
    if (s === 'resolved' || s === 'closed' || s === 'archived') return;
    var escalated = conv.aiEscalated || conv.chatAiEscalated;
    if (!escalated) return;
    var escalatedAt = conv.escalatedAt || 0;
    if (!escalatedAt) return;
    var waited = now - escalatedAt;
    var key = convKey || conv.id || label;
    var minWaited = Math.floor(waited / 60000);

    // Stage 3b — 30s after critical (one-time only)
    if (waited >= t3b && !alertedMap[key + '_3b']) {
      alertedMap[key + '_3b'] = now;
      playAlert(3);
      addNotification('crit', '🔴 STILL UNACKNOWLEDGED', label + ' — ' + minWaited + ' min. IMMEDIATE action required.');
    }
    // Stage 3a — critical threshold (one-time only)
    else if (waited >= t2 && !alertedMap[key + '_3']) {
      alertedMap[key + '_3'] = now;
      playAlert(3);
      addNotification('crit', '🔴 OVERDUE — Immediate Attention', label + ' — Waiting ' + minWaited + ' min. No agent has responded.');
    }
    // Stage 2 — reminder (one-time only)
    else if (waited >= t1 && !alertedMap[key + '_2']) {
      alertedMap[key + '_2'] = now;
      playAlert(2);
      addNotification('warn', '🟡 Escalation Reminder', label + ' — Waiting ' + minWaited + ' min with no response.');
    }
  }

  // Check all account chats
  Object.entries(DB.accounts || {}).forEach(function(entry) {
    var k = entry[0], a = entry[1];
    if (a.chatAiEscalated) {
      if (!a.escalatedAt) a.escalatedAt = now;
      checkConv(a, 'Account ' + k + ' (' + a.name + ')', 'acc_' + k);
    }
  });

  // Check public chat
  var pub = (DB.publicChats || [])[0];
  if (pub && pub.aiEscalated) {
    if (!pub.escalatedAt) pub.escalatedAt = now;
    checkConv(pub, 'General Support [' + pub.id + ']', pub.id);
  }

  // Re-render chats pane if open (applies visual highlights)
  var chatsPane = document.getElementById('tpane-chats');
  if (chatsPane && chatsPane.classList.contains('active')) renderTellerChats();
}

// Helper: calculate escalation urgency class for a conversation
// Returns '' | 'waiting' | 'overdue'
function getEscalationUrgency(escalatedAt) {
  if (!escalatedAt) return '';
  var n = DB.notifications || {};
  var t1 = (n.escalationThreshold1 || 3) * 60 * 1000;
  var t2 = (n.escalationThreshold2 || 8) * 60 * 1000;
  var waited = Date.now() - escalatedAt;
  if (waited >= t2) return 'overdue';
  if (waited >= t1) return 'waiting';
  return '';
}

// Hook into aiUserEscalate — records timestamp, plays L1 alert, notifies
var _aiEscHooked = false;
(function hookEscalate() {
  if (_aiEscHooked) return;
  _aiEscHooked = true;
  var _origAiEscalate = window.aiUserEscalate;
  window.aiUserEscalate = function(channel, key) {
    if (_origAiEscalate) _origAiEscalate(channel, key);
    var now = Date.now();
    if (channel === 'account' && key && DB.accounts[key]) {
      DB.accounts[key].escalatedAt = now;
      // Clear any existing alert state for this conv so stages fire fresh
      var alertedMap = (DB.notifications || {}).alertedEscalations || {};
      ['_2','_3','_3b'].forEach(function(s){ delete alertedMap['acc_'+key+s]; });
    } else if (channel === 'public' && DB.publicChats && DB.publicChats[0]) {
      DB.publicChats[0].escalatedAt = now;
      var alertedMap = (DB.notifications || {}).alertedEscalations || {};
      var pid = DB.publicChats[0].id;
      ['_2','_3','_3b'].forEach(function(s){ delete alertedMap[pid+s]; });
    }
    // Stage 0: immediate L1 ping — only if teller is watching
    if (_isTellerActive()) playAlert(1);
    addNotification('info', '⚡ New Escalation Request', 'User requested human agent — ' + channel + ' channel.');
    updateStatusBar();
  };
})();

// ================================================================
// NOTIFICATION PREFERENCES
// ================================================================

function setNotifPref(key, val) {
  DB.notifications = DB.notifications || {};
  DB.notifications[key] = val;
  addAudit('Notification setting "' + key + '" set to ' + val, 'Teller');
}

function setNotifVolume(val) {
  DB.notifications = DB.notifications || {};
  DB.notifications.volume = parseInt(val) / 100;
  const lbl = document.getElementById('notif-vol-label');
  if (lbl) lbl.textContent = val + '%';
}

function setNotifThreshold(level, val) {
  DB.notifications = DB.notifications || {};
  const v = parseInt(val);
  if (level === 1) DB.notifications.escalationThreshold1 = v;
  else DB.notifications.escalationThreshold2 = v;
  addAudit('Escalation threshold ' + level + ' set to ' + v + ' min', 'Teller');
}

// ================================================================
// GLOBAL SEARCH
// ================================================================

function globalSearch(query) {
  const resEl = document.getElementById('t-search-results');
  if (!resEl) return;
  const q = (query || '').trim().toLowerCase();
  if (!q || q.length < 2) { resEl.style.display = 'none'; return; }

  const results = [];

  // Search accounts
  Object.entries(DB.accounts || {}).forEach(function(entry) {
    var k = entry[0], a = entry[1];
    if (String(k).toLowerCase().includes(q) || a.name.toLowerCase().includes(q) || String(a.pin).includes(q)) {
      results.push({ type:'ACCOUNT', name: a.name, meta: 'ACC ' + k + ' · $' + fmt(a.checking+a.savings) + ' total', action: 'account:' + k });
    }
    // Search loans
    (a.loans || []).forEach(function(l) {
      if (String(l.id).includes(q) || l.name.toLowerCase().includes(q)) {
        results.push({ type:'LOAN', name: l.name, meta: 'ACC ' + k + ' · $' + fmt(l.remaining) + ' remaining', action: 'account:' + k });
      }
    });
  });

  // Search recurring payments
  (DB.recurringPayments || []).forEach(function(r) {
    if (String(r.id).includes(q) || r.name.toLowerCase().includes(q)) {
      results.push({ type:'RECURRING', name: r.name, meta: 'ACC ' + r.accKey + ' · $' + fmt(r.amt) + ' · ' + (r.status||'active'), action: 'recurring' });
    }
  });

  // Search chats
  Object.entries(DB.accounts || {}).forEach(function(entry) {
    var k = entry[0], a = entry[1];
    if (a.chatId && a.chatId.toLowerCase().includes(q)) {
      results.push({ type:'CHAT', name: 'Chat ' + a.chatId, meta: a.name + ' · Status: ' + (a.chatStatus||'active'), action: 'chats' });
    }
  });

  if (!results.length) {
    resEl.innerHTML = '<div class="tsr-item" style="color:var(--text3)">No results for "' + esc(query) + '"</div>';
  } else {
    resEl.innerHTML = results.slice(0, 12).map(function(r) {
      return '<div class="tsr-item" onclick="searchGoto(' + JSON.stringify(r.action) + ')">' +
        '<div class="tsr-type">' + r.type + '</div>' +
        '<div class="tsr-name">' + esc(r.name) + '</div>' +
        '<div class="tsr-meta">' + esc(r.meta) + '</div>' +
      '</div>';
    }).join('');
  }
  resEl.style.display = '';
}

function searchGoto(action) {
  const resEl = document.getElementById('t-search-results');
  if (resEl) resEl.style.display = 'none';
  const searchEl = document.getElementById('t-global-search');
  if (searchEl) searchEl.value = '';

  if (action.startsWith('account:')) {
    const k = action.split(':')[1];
    tTab('accounts', document.querySelector('#page-teller .snav-item:nth-child(2)'));
  } else if (action === 'recurring') {
    tTab('recurring', document.querySelector('#page-teller .snav-item:nth-child(4)'));
  } else if (action === 'chats') {
    tTab('chats', document.querySelector('#page-teller .snav-item:nth-child(7)'));
  }
}

// ================================================================
// ENHANCED renderTellerSummary — adds analytics
// ================================================================

const _origRenderTellerSummary = window.renderTellerSummary || renderTellerSummary;
window.renderTellerSummary = function() {
  _origRenderTellerSummary();
  updateStatusBar();
  renderRecurActivityLog();
};

// ================================================================
// BOOT — start scheduler after DOM ready
// ================================================================

// Boot landing page elements
setTimeout(function(){
  updateLandingStats();
  renderAgentStatus();
  startScheduler();
  updateStatusBar();
  // Listen for teller login to initialize notification UI
  document.addEventListener('tellerLoggedIn', function() {
    renderNotifications();
    updateStatusBar();
  });
}, 150);
</script>

<script>
/* ================================================================
   SCROLL REVEAL — IntersectionObserver
   Triggers .reveal elements as they enter the viewport
================================================================ */
(function() {
  const io = new IntersectionObserver(
    (entries) => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          e.target.classList.add('visible');
          io.unobserve(e.target); // fire once
        }
      });
    },
    { threshold: 0.12, rootMargin: '0px 0px -40px 0px' }
  );

  function initReveal() {
    document.querySelectorAll('.reveal').forEach(el => io.observe(el));
  }

  // Run on load and whenever the landing page becomes active
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initReveal);
  } else {
    initReveal();
  }

  // Re-init reveals when landing page is shown
  const _revealOrigShowPage = window.showPage || showPage;
  window.showPage = function(id) {
    _revealOrigShowPage(id);
    if (id === 'page-landing') {
      setTimeout(() => {
        document.querySelectorAll('#page-landing .reveal:not(.visible)')
          .forEach(el => io.observe(el));
      }, 50);
    }
  };
})();
</script>
</body>
</html>
